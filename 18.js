(function(){var e={"esri/views/3d/layers/i3s/I3SUtil":250,"esri/views/3d/layers/i3s/I3SBinaryReader":403,"esri/views/3d/layers/support/attributeUtils":472,"esri/views/3d/layers/i3s/I3SProjectionUtil":473,"esri/views/3d/layers/i3s/LEPCC":513,"esri/views/3d/layers/i3s/I3SGeometryUtil":613,"esri/layers/graphics/controllers/I3SOnDemandController":727,"esri/views/3d/layers/i3s/I3SFrameTask":728,"esri/views/3d/layers/i3s/I3SIndex":729,"esri/views/3d/layers/i3s/I3SNode":730,"esri/views/3d/layers/i3s/I3SLodHandling":731,"esri/views/3d/layers/i3s/I3SNodeLoader":732,"esri/views/3d/layers/i3s/I3SMaterialUtil":733,"esri/views/3d/layers/i3s/I3SStreamDataController":734,"esri/views/3d/layers/i3s/I3SViewportQueries":735,"esri/layers/support/SceneModification":736,"esri/views/3d/support/GraphicsMap":737,"esri/views/3d/layers/I3SMeshView3D":842,"esri/views/3d/layers/I3SMeshViewLabeler":1063,"esri/views/3d/support/LimitGraphicsMap":1064,"esri/views/3d/layers/I3SMeshWorkerHandle":1065,"esri/views/3d/layers/i3s/Highlights":1066,"esri/views/3d/layers/i3s/I3SElevationProvider":1067,"esri/views/3d/layers/i3s/I3SIntersectionHandler":1068,"esri/views/3d/layers/i3s/IDBCache":1069,"esri/views/3d/webgl-engine/core/material/RenderTexture":1070},t=this||window,r=t.webpackJsonp=t.webpackJsonp||[];r.registerAbsMids?r.registerAbsMids(e):(r.absMidsWaiting=r.absMidsWaiting||[]).push(e)})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{1063:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(174),r(239),r(158),r(167),r(152),r(151),r(435),r(160),r(207),r(565),r(566),r(613),r(1064)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p,f,g){Object.defineProperty(t,"__esModule",{value:!0});var y=function(e){function t(t){var r=e.call(this,t)||this;return r.loadedGraphics=new g.LimitGraphicsMap(5e4),r.slicePlaneEnabled=!1,r._renderingInfo={symbol:new n.PointSymbol3D},r._handles=new a,r._graphicsByNode=new Map,r._scaleVisibility=null,r}return r.__extends(t,e),t.prototype.initialize=function(){var e=this;this._graphicsCore=new h.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:1,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1});var t=this.view.basemapTerrain;this._scaleVisibility=new p({layerScaleEnabled:!1}),this._scaleVisibility.setup(this,this.layer,(function(t,r,i){return e._graphicsCore.spatialIndex.queryGraphicUIDsInExtent(t,r,i)}),this._graphicsCore,t);var r=this.view.labeler.addGraphicsOwner(this._graphicsCore,this._scaleVisibility,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),i=this.view.deconflictor.addGraphicsOwner(this._graphicsCore);this._graphicsCore.setup({labeler:r,deconflictor:i,scaleVisibility:this._scaleVisibility}).then((function(){e._graphicsCore.startCreateGraphics()})).catch((function(){})),this._handles.add([this.layer.watch("labelingInfo",(function(t,r){d.diff(t,r)&&e._graphicsCore.updateLabelingInfo()}))])},t.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null),null!=this._scaleVisibility&&(this._scaleVisibility.destroy(),this._scaleVisibility=null),null!=this._graphicsCore&&(this._graphicsCore.destroy(),this._graphicsCore=null),this.loadedGraphics.destroy(),this.view=null},t.prototype.addNodeMeta=function(e,t){var r=this,n=0,o=e.filteredIds,a=e.featureIds.map((function(a,l){f.boundingBoxTop(l,r.collection,e.objectHandle,_);var d=c.makeDehydratedPoint(0,0,0,r.view.spatialReference);r.view.renderCoordsHelper.fromRenderCoords(_,d);var u=t(l,e),h=!1;return s.isNone(o)?h=!0:n<o.length&&a===o[n]&&(h=!0,n++),{objectId:a,uid:i.generateUID(),attributes:u,visible:h,geometry:d}}));this.loadedGraphics.addMany(a),this._graphicsByNode.set(e.node.index,a)},t.prototype.setNodeMetaAttributes=function(e,t){for(var r=this._graphicsByNode.get(e.node.index),i=new Array(r.length),n=0;n<r.length;n++){var o=r[n];o.attributes=t(n,e),i[n]=o.uid}this._graphicsCore.updateLabelingInfo(i)},t.prototype.applyFilterChange=function(e){var t=this._graphicsByNode.get(e.node.index);if(t)if(s.isNone(e.filteredIds))for(var r=0,i=t;r<i.length;r++)(l=i[r]).visible||(l.visible=!0,m.graphic=l,m.property="visible",m.oldValue=!1,m.newValue=!0,this._graphicsCore.graphicUpdateHandler(m));else for(var n=0,o=0,a=t;o<a.length;o++){var l,d=(l=a[o]).visible;n<e.filteredIds.length&&l.objectId===e.filteredIds[n]?(l.visible=!0,n++):l.visible=!1,d!==l.visible&&(m.graphic=l,m.property="visible",m.oldValue=d,m.newValue=l.visible,this._graphicsCore.graphicUpdateHandler(m))}},t.prototype.removeNodeMeta=function(e){this.loadedGraphics.removeManyByObjectId(e.featureIds)},t.prototype.getRenderingInfo=function(){return this._renderingInfo},t.prototype.notifyGraphicUpdate=function(){},Object.defineProperty(t.prototype,"usedMemory",{get:function(){return this._graphicsCore.usedMemory},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return this._graphicsCore.unprocessedMemoryEstimate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{graphicsCore:this._graphicsCore}},enumerable:!0,configurable:!0}),r.__decorate([l.property()],t.prototype,"view",void 0),r.__decorate([l.property()],t.prototype,"layer",void 0),r.__decorate([l.property()],t.prototype,"collection",void 0),r.__decorate([l.property()],t.prototype,"loadedGraphics",void 0),r.__decorate([l.property({aliasOf:"_graphicsCore.updating"})],t.prototype,"updating",void 0),r.__decorate([l.property()],t.prototype,"slicePlaneEnabled",void 0),r.__decorate([l.property()],t.prototype,"_graphicsCore",void 0),r.__decorate([l.subclass("esri.views.3d.layers.I3SMeshViewLabeler")],t)}(o),m={graphic:null,property:null,oldValue:null,newValue:null},_=u.vec3f64.create();t.default=y}.apply(null,i))||(e.exports=n)},1064:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(190),r(210),r(737)],void 0===(n=function(e,t,r,i,n,o){Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t){var r=e.call(this)||this;return r._limit=t,r._all=new o.GraphicsMap,r._active=new l(r),r._pending=new Map,r._handle=r._all.on("change",(function(e){return r._handleChanges(e)})),r}return r.__extends(t,e),t.prototype.destroy=function(){this._handle.remove()},Object.defineProperty(t.prototype,"length",{get:function(){return this._active.length},enumerable:!0,configurable:!0}),t.prototype.toArray=function(){return this._active.toArray()},t.prototype.find=function(e){return this._active.find(e)},t.prototype.forEach=function(e){this._active.forEach(e)},t.prototype.addMany=function(e){this._all.addMany(e)},t.prototype.removeManyByObjectId=function(e){this._all.removeManyByObjectId(e)},t.prototype._handleChanges=function(e){var t=this,r=e.removed;if(this._pending.size>0){r=new Array;for(var i=0,n=e.removed;i<n.length;i++){var o=n[i];this._pending.delete(o.objectId)||r.push(o)}}var a=this._limit-this._active.length+r.length;a<e.added.length&&(this._active.removeMany(r),r=[],s.reset(1-this._limit/(this._active.length+e.added.length)),this._active.forEach((function(e){s.sample()&&(r.push(e),t._pending.set(e.objectId,e))})),a=this._limit-this._active.length+r.length);var l=e.added;if(a<e.added.length){l=new Array,s.reset(a/e.added.length);for(var d=0,u=e.added;d<u.length;d++)o=u[d],s.sample()?l.push(o):this._pending.set(o.objectId,o)}var c=a-l.length;c>0&&this._pending.size>0&&(s.reset(c/this._pending.size),this._pending.forEach((function(e){s.sample()&&(l.push(e),t._pending.delete(e.objectId))}))),this._active.addAndRemove(l,r)},t}(i);t.LimitGraphicsMap=a;var s=new(function(){function e(){this.percentage=1,this.last=-1,this.index=0}return e.prototype.reset=function(e){this.percentage=e,this.last=-1},e.prototype.sample=function(){var e=Math.floor(this.index*this.percentage);return++this.index,e!==this.last&&(this.last=e,!0)},e}()),l=function(){function e(e){this._parent=e,this._map=new Map}return Object.defineProperty(e.prototype,"length",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.forEach=function(e){this._map.forEach((function(t){return e(t)}))},e.prototype.find=function(e){var t;return n.someMap(this._map,(function(r){return!!e(r)&&(t=r,!0)})),t},e.prototype.toArray=function(){return n.valuesOfMap(this._map)},e.prototype.addAndRemove=function(e,t){for(var r=0,i=e;r<i.length;r++){var n=i[r];this._map.set(n.objectId,n)}for(var o=0,a=t;o<a.length;o++)n=a[o],this._map.delete(n.objectId);(e.length>0||t.length>0)&&this._parent.emit("change",{added:e,removed:t})},e.prototype.removeMany=function(e){for(var t=0,r=e;t<r.length;t++){var i=r[t];this._map.delete(i.objectId)}e.length>0&&this._parent.emit("change",{added:[],removed:e})},e}()}.apply(null,i))||(e.exports=n)},1065:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(156),r(214),r(192),r(662)],void 0===(n=function(e,t,r,i,n,o,a){Object.defineProperty(t,"__esModule",{value:!0});var s=i.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle"),l=function(e){function t(t){return e.call(this,"SceneLayerWorker","process",t)||this}return r.__extends(t,e),t.prototype.getTransferList=function(e){return[e.geometryBuffer]},t.prototype.setModifications=function(e,t,r){var i={context:e,modifications:c(t,r)};this.broadcast(i,"setModifications")},t.prototype.setLegacySchema=function(e,t){var r=JSON.stringify(t);this.broadcast({context:e,jsonSchema:r},"setLegacySchema")},t.prototype.destroyContext=function(e){return this.broadcast(e,"destroyContext")},t}(a.WorkerHandle);t.I3SMeshWorkerHandle=l;var d=new n({deallocator:null}),u=[0,0,0];function c(e,t){d.clear();for(var r=function(e){var r="clip"===e.type?2:"mask"===e.type?1:0,i=e.geometry,n=function(e){return e};if(i.spatialReference){if(!o.canProject(i.spatialReference,t))return s.warn("Can't project modification polygon into layer spatial reference, ignoring modification"),"continue";n=function(e){return o.vectorToVector(e,i.spatialReference,u,t),u}}else i.hasZ||(u[2]=0,n=function(e){return u[0]=e[0],u[1]=e[1],u});d.push(r),d.push(i.rings.length);for(var a=0,l=i.rings;a<l.length;a++){var c=l[a];d.push(c.length);for(var h=0,p=c;h<p.length;h++){var f=n(p[h]);d.push(f[0]),d.push(f[1]),d.push(f[2])}}},i=0,n=e;i<n.length;i++)r(n[i]);d.push(3);for(var a=new Float64Array(d.length),l=0;l<d.length;++l)a[l]=d.getItemAt(l);return a}t.toWasmModification=c}.apply(null,i))||(e.exports=n)},1066:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(180)],void 0===(n=function(e,t,r){var i=function(){this.ids=new Set,this.paused=!1};return function(){function e(e){this.highlights=[],this.collection=e.collection,this.forAllFeatures=e.forAllFeatures,this.forAllFeaturesOfNode=e.forAllFeaturesOfNode}return e.prototype.destroy=function(){var e=this;this.highlights.forEach((function(t){return e.releaseSet(t)})),this.highlights=null},e.prototype.acquireSet=function(){var e=this,t=new i;this.highlights.push(t);var n={remove:function(){e.releaseSet(t),r.removeUnordered(e.highlights,t)},pause:function(){e.releaseSet(t),t.paused=!0},resume:function(){t.paused=!1,e.initializeSet(t)}};return{set:t,handle:n}},e.prototype.setFeatureIds=function(e,t){t.forEach((function(t){return e.ids.add(t)})),this.initializeSet(e)},e.prototype.initializeSet=function(e){var t=this;this.forAllFeatures((function(r,i,n){return e.ids.has(r)&&t.collection.addComponentHighlight(n.objectHandle,i),1}))},e.prototype.releaseSet=function(e){var t=this;this.forAllFeatures((function(r,i,n){return e.ids.has(r)&&t.collection.removeComponentHighlight(n.objectHandle,i),1}))},e.prototype.objectCreated=function(e){var t=this;this.highlights.forEach((function(r){r.paused||t.forAllFeaturesOfNode(e,(function(i,n){return r.ids.has(i)&&t.collection.addComponentHighlight(e.objectHandle,n),1}))}))},e.prototype.objectDeleted=function(e){this.collection.clearHighlights(e.objectHandle)},e}()}.apply(null,i))||(e.exports=n)},1067:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(158),r(190),r(156),r(152),r(151),r(189),r(185),r(162),r(160),r(173),r(390)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p){var f=h.empty(),g=d.mat4f64.create(),y=c.vec3f64.create(),m=c.vec3f64.create(),_=c.vec3f64.create(),v=o.getLogger("esri.views.3d.layers.i3s.I3SElevationProvider");return function(e){function t(t){var r=e.call(this,t)||this;return r.tmpEvent={spatialReference:null,extent:f,context:"scene"},r}return r.__extends(t,e),t.prototype.initialize=function(){this.view=this.layerView.view,this.renderCoordsHelper=this.view.renderCoordsHelper,this.intersector=new p.Intersector(this.view.viewingMode),this.intersector.options.store=0;var e=this.layerView.layer.fullExtent;this.zmin=e.zmin,this.zmax=e.zmax,this.tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"},t.prototype.getElevation=function(e,t,r,i){if(y[0]=e,y[1]=t,y[2]=r,!this.renderCoordsHelper.toRenderCoords(y,i,y))return v.error("could not project point for elevation alignment"),null;var n=this.layerView.elevationOffset,o=this.zmin+n,a=this.zmax+n;return u.vec3.copy(m,y),u.vec3.copy(_,y),this.renderCoordsHelper.setAltitude(a,m),this.renderCoordsHelper.setAltitude(o,_),this.intersector.reset(m,_),this.intersectionHandler.intersect(this.intersector,null,m,_),this.intersector.results.min.getIntersectionPoint(y)?this.renderCoordsHelper.getAltitude(y):null},t.prototype.layerChanged=function(){this.spatialReference&&(this.tmpEvent.extent=this.computeLayerExtent(),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))},t.prototype.objectChanged=function(e){this.spatialReference&&(this.tmpEvent.extent=this.computeObjectExtent(e),this.tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this.tmpEvent))},t.prototype.computeObjectExtent=function(e){return h.empty(f),this.expandExtent(e,f),f},t.prototype.computeLayerExtent=function(){h.empty(f);for(var e=0,t=this.layerView.getVisibleNodes();e<t.length;e++){var r=t[e];this.expandExtent(r,f)}return f},t.prototype.expandExtent=function(e,t){var r=e.renderObb;if(a.isSome(r)){l.mat4.fromQuat(g,r.quaternion),g[12]=r.center[0],g[13]=r.center[1],g[14]=r.center[2];for(var i=0;i<8;++i)y[0]=1&i?r.halfSize[0]:-r.halfSize[0],y[1]=2&i?r.halfSize[1]:-r.halfSize[1],y[2]=4&i?r.halfSize[2]:-r.halfSize[2],u.vec3.transformMat4(y,y,g),this.renderCoordsHelper.fromRenderCoords(y,y,this.spatialReference),h.expand(t,y)}else{var n=e.renderMbs[3],o=u.vec3.copy(m,e.renderMbs);o[0]-=n,o[1]-=n,o[2]-=n;var s=u.vec3.copy(_,e.renderMbs);for(s[0]+=n,s[1]+=n,s[2]+=n,i=0;i<8;++i)y[0]=1&i?o[0]:s[0],y[1]=2&i?o[1]:s[1],y[2]=4&i?o[2]:s[2],this.renderCoordsHelper.fromRenderCoords(y,y,this.spatialReference),h.expand(t,y)}return t},r.__decorate([s.property({constructOnly:!0})],t.prototype,"layerView",void 0),r.__decorate([s.property({constructOnly:!0})],t.prototype,"intersectionHandler",void 0),r.__decorate([s.property()],t.prototype,"view",void 0),r.__decorate([s.property({readOnly:!0,aliasOf:"view.elevationProvider.spatialReference"})],t.prototype,"spatialReference",void 0),r.__decorate([s.subclass("esri.views.3d.layers.i3s.I3SElevationProvider")],t)}(n.EventedMixin(i))}.apply(null,i))||(e.exports=n)},1068:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(152),r(162),r(289),r(391)],void 0===(n=function(e,t,r,i,n,o){Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e){this.type="I3S",this.layerUid=e.layerUid,this.sublayerUid=e.sublayerUid,this.collection=e.collection,this.forEach=e.forEach,this.slicePlane=e.slicePlaneEnabled,this.isGround=e.isGround}return e.prototype.intersect=function(e,t,a,s){var l=this,d=e.results,u=2===e.options.store,c=e.ray.direction,h=e.tolerance,p=function(e){return e},f=function(e){return e},g=o.getVerticalOffsetI3S(e.verticalOffset);r.isSome(g)&&(p=function(e){return g.applyToMbs(e)},f=function(e){return g.applyToObb(e)}),this.forEach((function(y,m){r.isNone(y.authorativeObb)&&!function(e,t,r,i){void 0===i&&(i=0);var n=e[3]+i,o=t[0]-e[0],a=t[1]-e[1],s=t[2]-e[2],l=r[0],d=r[1],u=r[2],c=l*o+d*a+u*s;return c*c-(l*l+d*d+u*u)*(o*o+a*a+s*s-n*n)>=0}(p(y.renderMbs),a,c,h)||r.isSome(y.renderObb)&&!n.intersectLine(f(y.renderObb),a,c,h)||l.collection.intersect(m,a,s,h,g,(function(r,n,c,h){if(n>=0){if(null!=t&&!t(a,s,n))return;var p=function(e){e.intersector=l.type,e.target={type:"external",metadata:{layerUid:l.layerUid,sublayerUid:l.sublayerUid,nodeIndex:y.index,componentIndex:r}},e.dist=n,i.vec3.copy(e.normal,c),e.triangleNr=h};if((null==d.min.dist||n<d.min.dist)&&p(d.min),(null==d.max.dist||n>d.max.dist)&&p(d.max),u){var f=new o.IntersectorResult(e.ray);p(f),e.results.all.push(f)}l.isGround&&(null==d.ground.dist||n<d.ground.dist)&&p(d.ground)}}))}))},Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0}),e}();t.I3SIntersectionHandler=a}.apply(null,i))||(e.exports=n)},1069:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(154),r(152),r(153)],void 0===(n=function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t,r){void 0===r&&(r=14),this._version=r,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=1073741824,this.quotaReductionFactor=.2,this._dbName=e,this._storeName=t}return e.prototype.init=function(){var e=this;return n.resolve().then((function(){var t=indexedDB.open(e._dbName,e._version);return t.onupgradeneeded=function(r){var i=t.result,n=t.transaction,o=i.objectStoreNames.contains(e._storeName)?n.objectStore(e._storeName):i.createObjectStore(e._storeName),a=i.objectStoreNames.contains("last_access")?n.objectStore("last_access"):i.createObjectStore("last_access");a.indexNames.contains("date")||a.createIndex("date","date",{unique:!1}),a.indexNames.contains("byteSize")||a.createIndex("byteSize","byteSize",{unique:!1}),r.oldVersion<e._version&&(o.clear(),a.clear())},s(t)})).then((function(t){e._destroyed?t.close():e._db=t}))},e.prototype.destroy=function(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0},Object.defineProperty(e.prototype,"initialized",{get:function(){return null!=this._db},enumerable:!0,configurable:!0}),e.prototype.getHitRate=function(){return this._hit/(this._hit+this._miss)},e.prototype.put=function(e,t){var i=this;return null==this._db?n.reject(new r("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:n.resolve()).then((function(){return i._put(e,t)})).catch((function(r){if(r&&"QuotaExceededError"===r.name)return null==i._quotaReductionPromise&&(i._quotaReductionPromise=i._getCacheSize().then((function(e){return i._removeLeastRecentlyAccessed(t.byteSize+Math.ceil(e*i.quotaReductionFactor))})),i._quotaReductionPromise.then((function(){return i._quotaReductionPromise=null}),(function(){return i._quotaReductionPromise=null}))),i._quotaReductionPromise.then((function(){return i._put(e,t)}));throw r})).then((function(){i._gcCounter--,i._gcCounter<0&&null!=i._db&&(i._gcCounter=i.gcFrequency,i._getCacheSize().then((function(e){return i._removeLeastRecentlyAccessed(e-i.maxByteSize)})))}))},e.prototype.get=function(e,t){var r=this;if(null==this._db)return n.resolve(null);var o=null;return n.resolve().then((function(){var i=r._db.transaction(r._storeName,"readonly");return o=n.onAbort(t,(function(){i.abort()})),s(i.objectStore(r._storeName).get(e))})).then((function(t){return null==t?++r._miss:r._db&&(++r._hit,r._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:t.byteSize},e)),i.isSome(o)&&o.remove(),t})).catch((function(){return++r._miss,n.throwIfAborted(t),i.isSome(o)&&o.remove(),null}))},e.prototype.remove=function(e){var t=this;return null==this._db?n.resolve():n.resolve().then((function(){var r=t._db.transaction([t._storeName,"last_access"],"readwrite"),i=r.objectStore(t._storeName),o=r.objectStore("last_access"),l=i.delete(e),d=o.delete(e);return n.all([s(l),s(d),a(r)])}))},e.prototype._put=function(e,t){var r=this._db.transaction([this._storeName,"last_access"],"readwrite"),i=r.objectStore(this._storeName),o=r.objectStore("last_access"),l=i.put(t,e),d=o.put({date:Date.now(),byteSize:t.byteSize},e);return n.all([s(l),s(d),a(r)])},e.prototype._removeLeastRecentlyAccessed=function(e){if(!(e<=0)){var t=this._db.transaction([this._storeName,"last_access"],"readwrite"),r=t.objectStore(this._storeName),i=t.objectStore("last_access"),n=0,o=i.index("date").openCursor(null,"next");return o.onsuccess=function(){var t=o.result;null!=t&&(null!=t.value.byteSize&&(n+=t.value.byteSize),r.delete(t.primaryKey),i.delete(t.primaryKey),n<e&&t.continue())},a(t)}},e.prototype._getCacheSize=function(){var e=this._db.transaction("last_access"),t=e.objectStore("last_access"),r=0,i=t.index("byteSize").openKeyCursor();return i.onsuccess=function(){var e=i.result;if(e){var t=e.key;null!=t&&(r+=t),e.continue()}},a(e).then((function(){return r}))},e}();function a(e){return n.create((function(t,r){e.oncomplete=function(){return t()},e.onerror=function(){return r(e.error)},e.onabort=function(){return r(e.error)}}))}function s(e){return n.create((function(t,r){"done"===e.readyState?null!=e.error?r(e.error):t(e.result):(e.onsuccess=function(){return t(e.result)},e.onerror=function(){return r(e.error)})}))}t.IDBCache=o,t.whenTransaction=a,t.whenRequest=s}.apply(null,i))||(e.exports=n)},1070:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(152)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){var i=this;this._textureRep=e,this._textureId=t,this._textureRef=r.applySome(this._textureId,(function(e){return i._textureRep.acquire(e)}))}return e.prototype.dispose=function(){var e=this;this._textureRef=r.applySome(this._textureId,(function(t){e._textureRep.release(t)}))},e.prototype.bind=function(e,t,i,n,o){if(r.isSome(this._textureRef)&&(t.setUniform1i(i,n),e.bindTexture(this._textureRef.glTexture,n),o)){var a=this._textureRef.glTexture;t.setUniform2f(o,a.descriptor.width,a.descriptor.height)}},e}();t.RenderTexture=i}.apply(null,i))||(e.exports=n)},250:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(165),r(180),r(154),r(152),r(153),r(120),r(478),r(189),r(185),r(444),r(600),r(162),r(201),r(170),r(193),r(173),r(197),r(199),r(403),r(473),r(539),r(596),r(289),r(192)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p,f,g,y,m,_,v,b,x,w,S,C,M){function I(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}Object.defineProperty(t,"__esModule",{value:!0}),t.DDS_ENCODING_STRING="image/vnd-ms.dds",t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],t.extractWkid=I,t.selectEncoding=function(e,r){if(r)for(var i=0;i<e.length;i++)if(e[i].encoding===t.DDS_ENCODING_STRING)return e[i];for(i=0;i<e.length;i++)if(t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[i].encoding)>-1)return e[i];return null},t.findIntersectingNodes=function(e,t,r,i,n,o){n.traverse(r,(function(r){var n=r.mbs;t!==i&&(n=D,M.mbsToMbs(r.mbs,i,n,t));var a=O(e,n);return 0!==a&&(o(r,a),!0)}))},t.filterInPlace=function(e,t,r){for(var i=0,n=0,o=0;o<t.length&&i<e.length;o++)e[i]===t[o]&&(r(o)&&(e[n]=e[i],n++),i++);e.length=n};var N=y.create();t.getClipAABB=function(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return N[0]=(e[0]-t.position[0])/t.rotationScale[0],N[1]=(e[1]-t.position[1])/t.rotationScale[4],N[2]=(e[2]-t.position[2])/t.rotationScale[8],N[3]=(e[3]-t.position[0])/t.rotationScale[0],N[4]=(e[4]-t.position[1])/t.rotationScale[4],N[5]=(e[5]-t.position[2])/t.rotationScale[8],N};var D=f.vec4f64.create();function O(e,t){var r=t[0],i=t[1],n=t[3],o=e[0]-r,a=r-e[2],s=e[1]-i,l=i-e[3],d=Math.max(o,a,0),u=Math.max(s,l,0),c=d*d+u*u;return c>n*n?0:c>0?1:-Math.max(o,a,s,l)>n?3:2}function P(e,t,r){for(var i=[],n=r&&r.missingFields,o=r&&r.originalFields,a=0,s=e;a<s.length;a++){for(var l=s[a],d=l.toLowerCase(),u=!1,c=0,h=t;c<h.length;c++){var p=h[c];if(d===p.name.toLowerCase()){i.push(p.name),u=!0,o&&o.push(l);break}}!u&&n&&n.push(l)}return i}t.intersectBoundingRectWithMbs=O,t.intersectBoundingBoxWithMbs=function(e,t){var r=t[0],i=t[1],n=t[2],o=t[3],a=e[0]-r,s=r-e[3],l=e[1]-i,d=i-e[4],u=e[2]-n,c=n-e[5],h=Math.max(a,s,0),p=Math.max(l,d,0),f=Math.max(u,c,0),g=h*h+p*p+f*f;return g>o*o?0:g>0?1:-Math.max(a,s,l,d,u,c)>o?3:2},t.findFieldsCaseInsensitive=P,t.whenGraphicAttributes=function(e,t,o,s,l,d){var u;if(!0===(d&&d.populateObjectId)&&(u=o,s=s.filter((function(e){return e!==u})).concat([u])),0===t.length)return a.resolve(t);var c=e.associatedLayer,h=e.attributeStorageInfo;if(c)return function(e,t,r,i){t.sort((function(e,t){return e.attributes[r]-t.attributes[r]}));var o=t.map((function(e){return e.attributes[r]})),s=[],l=P(i,e.fields,{originalFields:s});return function e(t,r,i){var o=t.capabilities.query.maxRecordCount;if(null!=o&&r.length>o){var s=function(e,t){for(var r=e.length,i=Math.ceil(r/t),n=[],o=0;o<i;o++){var a=Math.floor(r*o/i),s=Math.floor(r*(o+1)/i);n.push(e.slice(a,s))}return n}(r,o);return a.all(s.map((function(r){return e(t,r,i)}))).then(F)}var l=new v({objectIds:r,outFields:i,orderByFields:[t.objectIdField]});return t.queryFeatures(l).then((function(e){if(e&&e.features&&e.features.length===r.length)return e.features.map((function(e){return e.attributes}));throw new n("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}(e,o,l).then((function(e){for(var r=0;r<t.length;r++){var i=t[r],n=e[r],o={};if(i.attributes)for(var a in i.attributes)o[a]=i.attributes[a];for(var d=0;d<s.length;d++)o[s[d]]=n[l[d]];i.attributes=o}return t}))}(c,t,o,s);if(h){var p=l(t);if(!p)return a.reject(new n("scenelayer:features-not-loaded","Tried to query attributes for unloaded features"));var f=e.parsedUrl.path;return a.all(p.map((function(e){return function(e,t,i,n,o){for(var s=[],l=0,d=t;l<d.length;l++){var u=d[l];if(u&&-1!==o.indexOf(u.name)){var c=e+"/nodes/"+i.resources.attributes+"/attributes/"+u.key+"/0";s.push({url:c,storageInfo:u})}}return a.eachAlways(s.map((function(e){return r(e.url,{responseType:"array-buffer"}).then((function(t){return b.readBinaryAttribute(e.storageInfo,t.data)}))}))).then((function(e){for(var t=[],r=0,i=n;r<i.length;r++){for(var o=i[r],a={},l=0;l<e.length;l++)null!=e[l].value&&(a[s[l].storageInfo.name]=E(e[l].value,o));t.push(a)}return t}))}(f,h,e.node,e.indices,s).then((function(t){for(var r=0;r<e.graphics.length;r++){var i=e.graphics[r],n=t[r];if(i.attributes)for(var o in i.attributes)o in n||(n[o]=i.attributes[o]);i.attributes=n}return e.graphics}))}))).then(i.flatten)}return a.reject(new n("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var A=-Math.pow(2,15),T=-Math.pow(2,31);function E(e,t){if(!e)return null;var r=e[t];return s.isInt16Array(e)?r===A?null:r:s.isInt32Array(e)?r===T?null:r:r!=r?null:r}function F(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r];t=t.concat(n)}return t}function R(e){var t=new g(I(e.store.indexCRS||e.store.geographicCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function V(e){var t=new g(I(e.store.vertexCRS||e.store.projectedCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function L(e,t,r){if(!_.canProject(e,t))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&e.isGeographic)throw new n("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function j(e,t,r){var i=R(e),n=V(e);L(i,t,r),L(n,t,r)}function B(e){return"mesh-3d"===e.type}t.getCachedAttributeValue=E,t.getIndexCrs=R,t.getVertexCrs=V,t.getCacheKeySuffix=function(e,t){return t===M.SphericalECEFSpatialReference?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null},t.checkSpatialReference=L,t.checkSpatialReferences=j,t.checkSceneLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new n("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t},t.checkSceneLayerCompatibleWithView=function(e,t){j(e,t.spatialReference,t.viewingMode)},t.checkPointCloudLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new n("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t},t.checkPointCloudLayerCompatibleWithView=function(e,t){L(e.spatialReference,t.spatialReference,t.viewingMode)},t.rendererNeedsTextures=function(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var t=e.getSymbols();if(0===t.length)return!0;for(var r=0,i=t;r<i.length;r++){var n=i[r];if(!B(n)||0===n.symbolLayers.length)return!0;for(var a=0,s=n.symbolLayers.items;a<s.length;a++){var l=s[a];if("fill"!==l.type||o.isNone(l.material)||o.isNone(l.material.color)||"replace"!==l.material.colorMixMode)return!0}}return!1},t.transparentEdgeMaterial=w.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});var U=function(){this.edgeMaterial=null,this.material=null,this.castShadows=!0};function G(e,t,r,i,n,o){void 0===n&&(n=0),void 0===o&&(o=!1),i!==k||o?e===r?(r.center[2]+=n,M.bufferToBuffer(r.center,t,0,r.center,i,0,1)):(p.vec3.set(r.center,e.center[0],e.center[1],e.center[2]+n),M.bufferToBuffer(r.center,t,0,r.center,i,0,1),c.quat.copy(r.quaternion,e.quaternion),p.vec3.copy(r.halfSize,e.halfSize)):t.isGeographic?function(e,t,r,i){var n=1+Math.max(0,i)/(l.wgs84Radius+e.center[2]);p.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+i),M.bufferToBuffer(t.center,r,0,t.center,k,0,1),c.quat.copy(t.quaternion,e.quaternion),c.quat.conjugate(z,e.quaternion),p.vec3.set(Z,0,0,1),p.vec3.transformQuat(Z,Z,z),p.vec3.set(Z,e.halfSize[0]*Math.abs(Z[0]),e.halfSize[1]*Math.abs(Z[1]),e.halfSize[2]*Math.abs(Z[2])),p.vec3.scale(Z,Z,H),p.vec3.add(t.halfSize,e.halfSize,Z),p.vec3.scale(t.halfSize,t.halfSize,n)}(e,r,t,n):function(e,t,r,i){C.corners(e,Q),p.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+i),M.computeLinearTransformation(r,t.center,q,k),p.vec3.set(t.center,q[12],q[13],q[14]);var n=2*Math.sqrt(1+q[0]+q[5]+q[10]);z[0]=(q[6]-q[9])/n,z[1]=(q[8]-q[2])/n,z[2]=(q[1]-q[4])/n,z[3]=.25*n,c.quat.multiply(t.quaternion,z,e.quaternion),c.quat.conjugate(z,t.quaternion);for(var o=0,a=0,s=0,l=0,d=Q;l<d.length;l++){var u=d[l];u[2]+=i,M.bufferToBuffer(u,r,0,u,k,0,1),p.vec3.sub(Z,u,t.center),p.vec3.transformQuat(Z,Z,z),o=Math.max(o,Math.abs(Z[0])),a=Math.max(a,Math.abs(Z[1])),s=Math.max(s,Math.abs(Z[2]))}p.vec3.set(t.halfSize,o,a,s)}(e,r,t,n)}t.SymbolInfo=U,t.getSymbolInfo=function(e){for(var t=new U,r=!1,i=!1,n=0,a=e.symbolLayers.items;n<a.length;n++){var s=a[n];if("fill"===s.type&&s.enabled){var l=s.material,d=s.edges;if(o.isSome(l)&&!r){var u=l.color,c=S.parseColorMixMode(l.colorMixMode);o.isSome(u)?t.material={color:[u.r/255,u.g/255,u.b/255],alpha:u.a,colorMixMode:c}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=s.castShadows,r=!0}o.isSome(d)&&!i&&(t.edgeMaterial=w.createMaterialFromEdges(d,{}),i=!0)}}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t},t.addWraparound=function(e,t){return(0|e)+(0|t)|0},t.transformObb=G,t.computeAuthorativeOBB=function(e,t,r,i,n,a){var s,l=x.computeGlobalTransformation(e.mbs,n,r,t);d.mat4.invert(J,l);var u=1/0,c=-1/0,h=function(a){if("replace"===a.type){var l=a.geometry;if(l.hasZ){m.empty(W);var d=l.spatialReference||i,h=l.rings.reduce((function(e,r){return r.reduce((function(e,r){return M.vectorToVector(r,d,Z,t),p.vec3.transformMat4(Z,Z,J),m.expandPointInPlace(W,Z),Math.min(Z[2],e)}),e)}),1/0);!function(){if(!s)if(s=Q,m.empty(K),o.isSome(e.obb)&&!e.isComputedObb){G(e.obb,r,Y,t,n,e.isComputedObb),C.corners(Y,s);for(var i=0,a=s;i<a.length;i++){var l=a[i];p.vec3.transformMat4(l,l,J),m.expandPointInPlace(K,l)}}else{var d=e.mbs,u=d[3];M.vectorToVector(d,r,Z,t),p.vec3.transformMat4(Z,Z,J),Z[2]+=n;for(var c=0;c<8;++c){var h=1&c?u:-u,f=2&c?u:-u,g=4&c?u:-u;l=s[c],p.vec3.copy(l,[Z[0]+h,Z[1]+f,Z[2]+g]),m.expandPointInPlace(K,l)}}}(),m.intersects(K,W)&&(u=Math.min(u,h),c=Math.max(c,h))}}};if(a.forEach((function(e){return h(e)})),u===1/0)return null;for(var f,g,y,_=0;_<8;++_)f=X.data,g=3*_,y=s[_],p.vec3.transformMat4(Z,y,l),f[g+0]=Z[0],f[g+1]=Z[1],f[g+2]=Z[2],g+=24,y[2]=u,p.vec3.transformMat4(Z,y,l),f[g+0]=Z[0],f[g+1]=Z[1],f[g+2]=Z[2],g+=24,y[2]=c,p.vec3.transformMat4(Z,y,l),f[g+0]=Z[0],f[g+1]=Z[1],f[g+2]=Z[2];return C.compute(X)};var k=M.SphericalECEFSpatialReference,H=1/(1-l.wgs84Flattening)-1,q=u.mat4f64.create(),z=h.quatf32.create(),Q=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],W=m.create(),K=m.create(),Y=C.create(),Z=[0,0,0],X={data:new Array(72),size:3,offsetIdx:0,strideIdx:3},J=u.mat4f64.create()}.apply(null,i))||(e.exports=n)},403:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(154),r(118),r(156),r(513)],void 0===(n=function(e,t,r,i,n,o,a){Object.defineProperty(t,"__esModule",{value:!0});var s=o.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function l(e,t,r){for(var n="",o=0;o<r;){var a=e[t+o];if(a<128)n+=String.fromCharCode(a),o++;else if(a>=192&&a<224){if(o+1>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var s=(31&a)<<6|63&e[t+o+1];n+=String.fromCharCode(s),o+=2}else if(a>=224&&a<240){if(o+2>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");s=(15&a)<<12|(63&e[t+o+1])<<6|63&e[t+o+2],n+=String.fromCharCode(s),o+=3}else{if(!(a>=240&&a<248))throw new i("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");if(o+3>=r)throw new i("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");if((s=(7&a)<<18|(63&e[t+o+1])<<12|(63&e[t+o+2])<<6|63&e[t+o+3])>=65536){var l=55296+(s-65536>>10),d=56320+(1023&s);n+=String.fromCharCode(l,d)}else n+=String.fromCharCode(s);o+=4}}return n}function d(e,r){for(var i={byteOffset:0,byteCount:0,fields:Object.create(null)},n=0,o=0;o<r.length;o++){var a=r[o],s=a.valueType||a.type,l=t.valueType2ArrayBufferReader[s];i.fields[a.property]=l(e,n),n+=t.valueType2TypedArrayClassMap[s].BYTES_PER_ELEMENT}return i.byteCount=n,i}function u(e,t,r){var n,o,a=[],s=0;for(o=0;o<e;o+=1){if((n=t[o])>0){if(a.push(l(r,s,n-1)),0!==r[s+n-1])throw new i("string-array-error","Invalid string array: missing null termination.")}else a.push(null);s+=n}return a}function c(e,r){return new(0,t.valueType2TypedArrayClassMap[r.valueType])(e,r.byteOffset,r.count*r.valuesPerElement)}function h(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function p(e,t,r){for(var o=null!=t.header?d(e,t.header):{byteOffset:0,byteCount:0,fields:{count:r}},a={header:o,byteOffset:o.byteCount,byteCount:0,entries:Object.create(null)},s=o.byteCount,l=0;l<t.ordering.length;l++){var u=t.ordering[l],c=n.clone(t[u]);if(c.count=o.fields.count,"String"===c.valueType){if(c.byteOffset=s,c.byteCount=o.fields[u+"ByteCount"],"UTF-8"!==c.encoding)throw new i("unsupported-encoding","Unsupported String encoding.",{encoding:c.encoding})}else{if(!v(c.valueType))throw new i("unsupported-value-type","Unsupported binary valueType",{valueType:c.valueType});var h=b(c.valueType);s+=s%h!=0?h-s%h:0,c.byteOffset=s,c.byteCount=h*c.valuesPerElement*c.count}s+=c.byteCount,a.entries[u]=c}return a.byteCount=s-a.byteOffset,a}function f(e,t,r){if(t!==e&&s.error("Invalid "+r+" buffer size\n expected: "+e+", actual: "+t+")"),t<e)throw new i("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function g(e){return{isDraco:!1,isLegacy:!1,color:null!=e.color,normal:null!=e.normal,uv0:null!=e.uv0,uvRegion:null!=e.uvRegion,featureIndex:null!=e.faceRange&&null!=e.featureId}}function y(e){for(var t={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},r=0,i=e.ordering;r<i.length;r++){var n=i[r];if(e.vertexAttributes[n])switch(n){case"position":break;case"normal":t.normal=!0;break;case"color":t.color=!0;break;case"uv0":t.uv0=!0;break;case"region":t.uvRegion=!0}}return e.featureAttributes&&e.featureAttributeOrder&&(t.featureIndex=!0),t}function m(e){for(var t={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},r=0,i=e;r<i.length;r++)switch(i[r]){case"position":break;case"normal":t.normal=!0;break;case"uv0":t.uv0=!0;break;case"color":t.color=!0;break;case"uv-region":t.uvRegion=!0;break;case"feature-index":t.featureIndex=!0}return t}t.readHeader=d,t.readStringArray=u,t.createTypedView=c,t.createRawView=h,t.createAttributeDataIndex=p,t.createGeometryDescriptorFromDefinition=g,t.createGeometryIndexFromSchema=function(e,t){for(var i=d(e,t&&t.header),n=i.byteCount,o={isDraco:!1,header:i,byteOffset:i.byteCount,byteCount:0,vertexAttributes:{}},a=i.fields,s=null!=a.vertexCount?a.vertexCount:a.count,l=0,u=t.ordering;l<u.length;l++){var c=u[l];if(t.vertexAttributes[c]){var h=r.__assign(r.__assign({},t.vertexAttributes[c]),{byteOffset:n,count:s}),p=_[c]?_[c]:"_"+c;o.vertexAttributes[p]=h,n+=b(h.valueType)*h.valuesPerElement*s}}var g=a.faceCount;if(t.faces&&g){o.faces={};for(var y=0,m=t.ordering;y<m.length;y++){var v=m[y];t.faces[v]&&(h=r.__assign(r.__assign({},t.faces[v]),{byteOffset:n,count:g}),o.faces[v]=h,n+=b(h.valueType)*h.valuesPerElement*g)}}var x=a.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&x){o.featureAttributes={};for(var w=0,S=t.featureAttributeOrder;w<S.length;w++){var C=S[w];t.featureAttributes[C]&&(h=r.__assign(r.__assign({},t.featureAttributes[C]),{byteOffset:n,count:x}),o.featureAttributes[C]=h,n+=("UInt64"===h.valueType?8:b(h.valueType))*h.valuesPerElement*x)}}return f(n,e.byteLength,"geometry"),o.byteCount=n-o.byteOffset,o},t.createGeometryDescriptor=function(e,t){return e&&e.compressedAttributes&&"draco"===e.compressedAttributes.encoding?m(e.compressedAttributes.attributes):e?g(e):y(t)},t.createGeometryDescriptorFromSchema=y,t.createGeometryDescriptorForDraco=m;var _={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};function v(e){return t.valueType2TypedArrayClassMap.hasOwnProperty(e)}function b(e){return v(e)?t.valueType2TypedArrayClassMap[e].BYTES_PER_ELEMENT:0}t.readBinaryAttribute=function(e,t,r){if("lepcc-rgb"===e.encoding)return a.decodeRGB(t);if("lepcc-intensity"===e.encoding)return a.decodeIntensity(t);if(null!=e.encoding&&""!==e.encoding)throw new i("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(s.warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(s.warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");var n=p(t,e,r);f(n.byteOffset+n.byteCount,t.byteLength,"attribute");var o=n.entries.attributeValues||n.entries.objectIds;if(o){if("String"===o.valueType){var l=n.entries.attributeByteCounts,d=c(t,l),g=h(t,o);return u(l.count,d,g)}return c(t,o)}throw new i("bad-attribute-storage-info","Bad attributeStorageInfo specification.")},t.valueType2TypedArrayClassMap={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},t.valueType2ArrayBufferReader={Float32:function(e,t){return new DataView(e,0).getFloat32(t,!0)},Float64:function(e,t){return new DataView(e,0).getFloat64(t,!0)},UInt8:function(e,t){return new DataView(e,0).getUint8(t)},Int8:function(e,t){return new DataView(e,0).getInt8(t)},UInt16:function(e,t){return new DataView(e,0).getUint16(t,!0)},Int16:function(e,t){return new DataView(e,0).getInt16(t,!0)},UInt32:function(e,t){return new DataView(e,0).getUint32(t,!0)},Int32:function(e,t){return new DataView(e,0).getInt32(t,!0)}},t.isValueType=v,t.getBytesPerValue=b}.apply(null,i))||(e.exports=n)},472:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.attributeLookup=function(e,t){for(var r=t.toLowerCase(),i=0,n=Object.keys(e);i<n.length;i++){var o=n[i];if(o.toLowerCase()===r)return e[o]}return null}}.apply(null,i))||(e.exports=n)},473:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(185),r(160),r(238),r(192)],void 0===(n=function(e,t,r,i,n,o){function a(e,t,r){var o=i.vec3f64.create(),a=e[3],s=Math.ceil(Math.log(a)*Math.LOG2E/4),l=Math.pow(2,4*s+1);if(r.isGeographic){var d=l/n.earthRadius*180/Math.PI,u=Math.round(e[1]/d),c=Math.max(-90,Math.min(90,u*d)),h=d/Math.cos((Math.abs(c)-d/2)/180*Math.PI),p=(f=Math.round(e[0]/h))*h;o[0]=p,o[1]=c}else{var f=Math.round(e[0]/l);u=Math.round(e[1]/l),o[0]=f*l,o[1]=u*l}var g=e[2]+t,y=Math.round(g/l);return o[2]=y*l,o}Object.defineProperty(t,"__esModule",{value:!0}),t.computeGlobalTransformation=function(e,t,i,n){var s=a(e,t,i),l=r.mat4f64.create();return o.computeLinearTransformation(i,s,l,n),l},t.getLocalOrigin=a}.apply(null,i))||(e.exports=n)},513:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(154)],void 0===(n=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});function i(e,t,r){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,r+0,10)),version:t.getUint16(r+10,!0),checksum:t.getUint32(r+12,!0)}}function n(e,t,r){var i=[];t=o(e,t,i);for(var n=[],a=0;a<i.length;a++){n.length=0,t=o(e,t,n);for(var s=0;s<n.length;s++)r.push(n[s]+i[a])}return t}function o(e,t,i){var n=new DataView(e,t),o=n.getUint8(0),a=31&o,s=!!(32&o),l=(192&o)>>6,d=0;if(0===l)d=n.getUint32(1,!0),t+=5;else if(1===l)d=n.getUint16(1,!0),t+=3;else{if(2!==l)throw new r("lepcc-decode-error","Bad count type");d=n.getUint8(1),t+=2}if(s)throw new r("lepcc-decode-error","LUT not implemented");for(var u=Math.ceil(d*a/8),c=new Uint8Array(e,t,u),h=0,p=0,f=0,g=-1>>>32-a,y=0;y<d;y++){for(;p<a;)h|=c[f]<<p,p+=8,f+=1;i[y]=h&g,h>>>=a,(p-=a)+a>32&&(h|=c[f-1]>>8-p)}return t+f}t.decodeXYZ=function(e){var t=new DataView(e,0),o=0,a=i(e,t,o),s=a.identifier,l=a.version;if(o+=16,"LEPCC     "!==s)throw new r("lepcc-decode-error","Bad identifier");if(l>1)throw new r("lepcc-decode-error","Unknown version");var d=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),minX:e.getFloat64(t+8,!0),minY:e.getFloat64(t+16,!0),minZ:e.getFloat64(t+24,!0),maxX:e.getFloat64(t+32,!0),maxY:e.getFloat64(t+40,!0),maxZ:e.getFloat64(t+48,!0),errorX:e.getFloat64(t+56,!0),errorY:e.getFloat64(t+64,!0),errorZ:e.getFloat64(t+72,!0),count:e.getUint32(t+80,!0),reserved:e.getUint32(t+84,!0)}}(t,o);if(o+=88,d.sizeHi*Math.pow(2,32)+d.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");var u=new Float64Array(3*d.count),c=[],h=[],p=[],f=[];if(o=n(e,o,c),o=n(e,o,h),o=n(e,o,p),(o=n(e,o,f))!==e.byteLength)throw new r("lepcc-decode-error","Bad length");for(var g=0,y=0,m=0;m<c.length;m++){y+=c[m];for(var _=0,v=0;v<h[m];v++){_+=p[g];var b=f[g];u[3*g]=Math.min(d.maxX,d.minX+2*d.errorX*_),u[3*g+1]=Math.min(d.maxY,d.minY+2*d.errorY*y),u[3*g+2]=Math.min(d.maxZ,d.minZ+2*d.errorZ*b),g++}}return{errorX:d.errorX,errorY:d.errorY,errorZ:d.errorZ,result:u}};t.decodeRGB=function(e){var t=new DataView(e,0),n=0,o=i(e,t,n),a=o.identifier,s=o.version;if(n+=16,"ClusterRGB"!==a)throw new r("lepcc-decode-error","Bad identifier");if(s>1)throw new r("lepcc-decode-error","Unknown version");var l=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),count:e.getUint32(t+8,!0),colorMapCount:e.getUint16(t+12,!0),lookupMethod:e.getUint8(t+14),compressionMethod:e.getUint8(t+15)}}(t,n);if(n+=16,l.sizeHi*Math.pow(2,32)+l.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");if((2===l.lookupMethod||1===l.lookupMethod)&&0===l.compressionMethod){if(3*l.colorMapCount+l.count+n!==e.byteLength||l.colorMapCount>256)throw new r("lepcc-decode-error","Bad count");for(var d=new Uint8Array(e,n,3*l.colorMapCount),u=new Uint8Array(e,n+3*l.colorMapCount,l.count),c=new Uint8Array(3*l.count),h=0;h<l.count;h++){var p=u[h];c[3*h]=d[3*p],c[3*h+1]=d[3*p+1],c[3*h+2]=d[3*p+2]}return c}if(0===l.lookupMethod&&0===l.compressionMethod){if(3*l.count+n!==e.byteLength||0!==l.colorMapCount)throw new r("lepcc-decode-error","Bad count");return new Uint8Array(e,n).slice()}if(l.lookupMethod<=2&&1===l.compressionMethod){if(n+3!==e.byteLength||1!==l.colorMapCount)throw new r("lepcc-decode-error","Bad count");var f=t.getUint8(n),g=t.getUint8(n+1),y=t.getUint8(n+2);for(c=new Uint8Array(3*l.count),h=0;h<l.count;h++)c[3*h]=f,c[3*h+1]=g,c[3*h+2]=y;return c}throw new r("lepcc-decode-error","Bad method "+l.lookupMethod+","+l.compressionMethod)};t.decodeIntensity=function(e){var t=new DataView(e,0),n=0,a=i(e,t,n),s=a.identifier,l=a.version;if(n+=16,"Intensity "!==s)throw new r("lepcc-decode-error","Bad identifier");if(l>1)throw new r("lepcc-decode-error","Unknown version");var d=function(e,t){return{sizeLo:e.getUint32(t+0,!0),sizeHi:e.getUint32(t+4,!0),count:e.getUint32(t+8,!0),scaleFactor:e.getUint16(t+12,!0),bitsPerPoint:e.getUint8(t+14),reserved:e.getUint8(t+15)}}(t,n);if(n+=16,d.sizeHi*Math.pow(2,32)+d.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");var u=new Uint16Array(d.count);if(8===d.bitsPerPoint){if(d.count+n!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(var c=new Uint8Array(e,n,d.count),h=0;h<d.count;h++)u[h]=c[h]*d.scaleFactor}else if(16===d.bitsPerPoint){if(2*d.count+n!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(c=new Uint16Array(e,n,d.count),h=0;h<d.count;h++)u[h]=c[h]*d.scaleFactor}else{if(o(e,n,c=[])!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(h=0;h<d.count;h++)u[h]=c[h]*d.scaleFactor}return u}}.apply(null,i))||(e.exports=n)},613:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(180),r(162),r(160),r(193),r(173),r(192),r(161)],void 0===(n=function(e,t,i,n,o,a,s,l,d){var u;function c(){return!!u}function h(e,t){return u.intersects(e,t)?u.contains(e,t)?0:2:1}function p(e,t){return u.intersects(e,t)?u.contains(e,t)?1:2:0}Object.defineProperty(t,"__esModule",{value:!0}),t.isGeometryEngineLoaded=c,t.loadGeometryEngine=function(){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(e){switch(e.label){case 0:return c()?[2,u]:[4,new Promise((function(e,t){Promise.all([r.e(12),r.e(25)]).then(function(){var t=[r(1072)];e.apply(null,t)}.bind(this)).catch(t.bind(this))}))];case 1:return[2,u=e.sent()]}}))}))},t.processFilterGeometry=function(e,t){if(!e)return null;if("disjoint"===t&&"polygon"===e.type){for(var r=new Array(e.rings.length),i=0;i<e.rings.length;++i){var o=l.fromValues(1/0,1/0,-1/0,-1/0);l.expandWithNestedArray(o,e.rings[i]),r[i]={type:"polygon",rings:[e.rings[i]],spatialReference:e.spatialReference,aabr:o}}r.sort((function(e,t){return e.aabr[0]-t.aabr[0]}));var a=new Set,s=new n.PositionHint,d=function(e){for(var t=r[e],i=e+1;i<r.length;++i){var o=r[i];if(o.aabr[0]>=t.aabr[2])break;a.add(o)}a.forEach((function(e){if(t!==e)if(e.aabr[2]<=t.aabr[0])a.delete(e);else if(u.intersects(t,e)){t.rings=t.rings.concat(e.rings),l.expand(t.aabr,e.aabr),delete t._geVersion,a.delete(e);var i=n.indexOf(r,e,r.length,s);r.splice(i,1)}})),a.add(t)};for(i=0;i<r.length;++i)d(i);for(var c=0,h=r;c<h.length;c++)delete h[c].aabr;return r}return[e]},t.acquireMaskFilterContext=function(e,t,r,i,n){var o,a,s=t.renderSpatialReference,l=new Map,d={rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],hasZ:!1,hasM:!1,type:"polygon",spatialReference:r};switch(d.rings[0][3]=d.rings[0][0],e){case"intersects":o=function(e,t){return u.intersects(e,t)?0:2},a=h;break;case"contains":o=function(e,t){return u.contains(e,t)?2:1},a=h;break;case"disjoint":default:o=function(e,t){return u.disjoint(e,t)?2:1},a=p}return{collection:i,object:n,type:e,maskSR:r,renderSR:s,aabbCache:l,triangle:d,positions:{indices:null,data:null,stride:0,startIndex:0,endIndex:0},triangleTest:o,geometryTest:a}},t.computeMaskNodeMBS=function(e,t){var r={x:e[0],y:e[1],hasZ:!1,hasM:!1,type:"point",spatialReference:t.maskSR},i=t.maskSR.isWGS84||t.maskSR.isWebMercator?u.geodesicBuffer(r,e[3],1):u.buffer(r,e[3],1);return i.type="polygon",i},t.testMaskWithGeometry=function(e,t,r){switch(r){case"intersects":case"contains":return h(e,t);case"disjoint":return p(e,t)}};var f=Math.pow(2,-32);t.filterWithMask=function(e,t,r){var i=r.collection,n=r.object,a=r.renderSR,s=r.maskSR,l=r.geometryTest,u=r.aabbCache,c=u.get(t);if(!c){var h=i.getObjectTransform(n);i.getComponentAABB(n,t,g);for(var p=[[g[0],g[1],0],[g[0],g[4],0],[g[3],g[4],0],[g[3],g[1],0]],y=0;y<4;++y)o.vec3.transformMat3(p[y],p[y],h.rotationScale),o.vec3.add(p[y],p[y],h.position),d.vectorToVector(p[y],a,p[y],s);(c={rings:[p],hasZ:!1,hasM:!1,type:"polygon",spatialReference:s}).rings[0][4]=c.rings[0][0],u.set(t,c)}switch(l(e,c)){case 1:return!1;case 0:return!0}var m=r.triangle,_=r.triangleTest,v=r.positions,b=m.rings[0][0],x=m.rings[0][1],w=m.rings[0][2],S=i.getObjectTransform(n);i.getComponentPositions(n,t,v);var C=v.indices,M=v.data,I=v.stride,N=v.startIndex,D=v.endIndex;for(y=N;y<D;y+=3){var O=I*C[y+0],P=I*C[y+1],A=I*C[y+2];o.vec3.set(b,M[O+0],M[O+1],M[O+2]),o.vec3.set(x,M[P+0],M[P+1],M[P+2]),o.vec3.set(w,M[A+0],M[A+1],M[A+2]),o.vec3.transformMat3(b,b,S.rotationScale),o.vec3.transformMat3(x,x,S.rotationScale),o.vec3.transformMat3(w,w,S.rotationScale),o.vec3.add(b,b,S.position),o.vec3.add(x,x,S.position),o.vec3.add(w,w,S.position),d.vectorToVector(b,a,b,s),d.vectorToVector(x,a,x,s),d.vectorToVector(w,a,w,s);var T=x[0]-b[0],E=x[1]-b[1],F=w[0]-b[0],R=w[1]-b[1];if(!(Math.abs(T*R-E*F)<f))switch(delete m._geVersion,_(e,m)){case 1:return!1;case 0:return!0}}switch(r.type){case"intersects":return!1;case"contains":case"disjoint":default:return!0}},t.boundingBoxCornerPoints=function(e,t,r,i){for(var n=t.getComponentAABB(r,e,g),a=t.getObjectTransform(r),s=0;s<8;++s)y[0]=1&s?n[0]:n[3],y[1]=2&s?n[1]:n[4],y[2]=4&s?n[2]:n[5],o.vec3.transformMat3(y,y,a.rotationScale),o.vec3.add(y,y,a.position),i[3*s]=y[0],i[3*s+1]=y[1],i[3*s+2]=y[2];return i},t.boundingBoxTop=function(e,t,r,i){var n=t.getComponentAABB(r,e,g),a=t.getObjectTransform(r);i[0]=0,i[1]=0,i[2]=0;for(var s=0;s<8;++s)y[0]=1&s?n[0]:n[3],y[1]=2&s?n[1]:n[4],y[2]=n[5],o.vec3.transformMat3(y,y,a.rotationScale),o.vec3.add(y,y,a.position),i[0]+=y[0],i[1]+=y[1],i[2]+=y[2];return i[0]/=8,i[1]/=8,i[2]/=8,i};var g=s.create(),y=a.vec3f64.create()}.apply(null,i))||(e.exports=n)},727:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(158),r(180),r(167),r(164),r(156),r(152),r(214),r(303),r(153),r(157),r(151),r(162),r(160),r(193),r(173),r(207),r(383),r(728),r(729),r(731),r(732),r(734),r(250),r(735),r(192),r(529)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p,f,g,y,m,_,v,b,x,w,S,C,M,I,N,D){var O=s.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),P=function(e){function t(t){var r=e.call(this,t)||this;return r.screenSizeFactor=0,r.featureTarget=5e4,r.fixedFeatureTarget=!1,r.updating=!0,r.updatingProgress=1,r.leafsReached=!1,r.scaleVisibilityEnabled=!0,r.uncompressedTextureDownsamplingEnabled=!1,r._featureLOD=1,r._stableFeatureLOD=!1,r._isIdle=!1,r._cameraDirty=!0,r._invisibleDirty=!1,r._newLoadingNodes=new d({deallocator:null}),r._loadedNodeScales=new Map,r._downloadingCount=0,r._loadingNodes=new Map,r._updatingNodes=new Map,r._progressMaxNumNodes=1,r._poi=g.vec3f64.create(),r._requiredAttributes=new Array,r._requiredAttributesDirty=!0,r._updatesDisabled=!1,r.disableIDBCache=!1,r._disableMemCache=!1,r._restartNodeLoading=!1,r._fields=null,r._attributeStorageInfo=null,r._handles=new o,r._idleQueue=new v.default,r._elevationUpdateNodes=new d({deallocator:null}),r._errorCount=0,r}return r.__extends(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataController",{get:function(){var e=this.layerView.view.resourceController.createStreamDataRequester(2);return new C.default(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return M.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return M.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){if(l.isSome(this._index)){var e=this._index.rootNode;if(l.isSome(e))return this._updateViewData(),this._index.isNodeVisible(e.index)}return!0},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData,this._lodHandling=new w(this.layerView);var t=this.layerView.layer;this.layer=t,this._defaultGeometrySchema=t.store.defaultGeometrySchema,this.disableIDBCache=a("disable-feature:idb-cache"),"fields"in t&&(this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo);var r=c.all([this.layer.when(),this.layerView.when()]).then((function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var r=e.layerView.view;e._setClippingArea(r.clippingArea),e._centerOnSurface=r.pointsOfInterest.centerOnSurfaceFrequent;var i=e.layerView.view.resourceController;e._handles.add([e._centerOnSurface.watch("renderLocation",(function(){return e._pointOfInterestChanged()})),i.memoryController.events.on("quality-changed",(function(){return e._setCameraDirty()})),h.init(e.layerView,"suspended",(function(t){var r=t?function(){return e._updateViewData()}:function(){return e._updateIdleState(!0)},n=t?function(){}:function(){return e._updateIdleState(!1)};e._idleStateCallbacks?(t&&e.cancelNodeLoading(),e.restartNodeLoading(),e._idleStateCallbacks.idleBegin=r,e._idleStateCallbacks.idleEnd=n):e._idleStateCallbacks=i.scheduler.registerIdleStateCallbacks(r,n)})),b.addTask(e.layerView.view.resourceController.scheduler,{update:function(t,r){return e._frame(t,r)},needsUpdate:function(){return e.updating}}),e.watch("uncompressedTextureDownsamplingEnabled",(function(){return e.restartNodeLoading()})),e.watch(["featureTarget","fixedFeatureTarget"],(function(){e._setCameraDirty(),e._stableFeatureLOD=!1})),r.state.watch("camera",(function(){return e._setCameraDirty()})),e.layer.watch("elevationInfo",(function(){return e._elevationInfoChanged()})),e.layer.watch(["minScale","maxScale"],(function(){return e._scaleBoundsChanged()})),e.layerView.watch("lodFactor",(function(){return e._setCameraDirty()})),e.layerView.watch("availableFields?",(function(){return e._requiredFieldsChange()})),e.layerView.watch("holeFilling",(function(t){return l.isSome(e._index)&&(e._index.holeFilling=t)}))]),e._updateScaleHandles(),e._viewportQueries=new I(e.crsIndex,r.renderCoordsHelper,r.state.camera,e._clippingArea,r.elevationProvider,e.layer.elevationInfo,{progressiveLoadFactor:e._getProgressiveLoadFactor(),screenspaceErrorBias:e.lod,angleDependentLoD:e.lod<.5}),e._index=new x.I3SIndex(t,e.streamDataController,e._viewportQueries,O,e.layerView.holeFilling,(function(t){return e.layerView.isNodeLoaded(t)}),(function(t){return e._shouldLoadNode(t)}),(function(t){return e._enableFromGPUCache(t,1)}),(function(t){return e._needsUpdate(t)}),(function(){return!e.streamDataController.busy}),(function(t){return e.layerView.computeAuthorativeOBB?e.layerView.computeAuthorativeOBB(t):null}))}}));this._tmpPoint=_.makeDehydratedPoint(0,0,0,this.crsIndex),this.addResolvingPromise(r),this.when((function(){return e._startNodeLoading()}))},t.prototype.destroy=function(){this._cancelAllNodes(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,A.prune()},t.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];var e=this._attributeStorageInfo,t=this._fields,r=this.layer.objectIdField;return this.layerView.availableFields.map((function(r){var i=E(e,r),n=E(t,r);return i>=0&&n>=0?{index:i,name:t[n].name,field:t[n],attributeStorageInfo:e[i]}:null})).filter((function(e){return null!=e&&e.name!==r}))},t.prototype._requiredFieldsChange=function(){var e=this._getRequiredAttributes();T(this._requiredAttributes,e)||(this._requiredAttributes=e,this._requiredAttributesDirty=!1,this.restartNodeLoading())},t.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._setClippingArea=function(e){var t=y.create();N.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&this.camPos&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&(this._viewportQueries.setPointOfInterest(this._poi),l.isSome(this._index)&&(this._index.progressiveLoadPenalty=F.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))},t.prototype._calculatePointOfInterest=function(e){var t=this._centerOnSurface.renderLocation,r=g.vec3f64.create();f.vec3.subtract(r,t,this.camPos);var i=this.layerView.view.renderCoordsHelper,n=g.vec3f64.create();i.worldUpAtPosition(t,n);var o=f.vec3.angle(n,r)-.5*Math.PI;return f.vec3.lerp(e,this.camPos,t,Math.max(0,Math.min(1,o/(.5*Math.PI)))),e},t.prototype.updateClippingArea=function(e){this._setClippingArea(e),this._viewportQueries&&l.isSome(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this.notifyChange("rootNodeVisible"),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()},t.prototype.updateElevationChanged=function(e,t){var r=this,i=this._index;if(!l.isNone(i)){var n=i.rootNode;if(!l.isNone(n)){var o=this._elevationUpdateNodes;o.clear(),M.findIntersectingNodes(e,t,n,this.crsIndex,i,(function(e){return o.push(e.index)})),o.forEach((function(e){i.invalidateBoundingVolumeCache(e),e===n.index&&r.notifyChange("rootNodeVisible")})),o.length&&this.restartNodeLoading()}}},t.prototype.getParentIndex=function(e){return l.isSome(this._index)&&this._index.getParentIndex(e)},t.prototype._elevationInfoChanged=function(){l.isSome(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo),this._setCameraDirty()},t.prototype._updateScaleHandles=function(){var e=this;this._handles.remove("scale-bounds"),this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),"scale-bounds")},t.prototype._scaleBoundsChanged=function(){this.areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()},t.prototype._scaleUpdateHandler=function(e){this._updateScaleInBoundingRect(e.scale,e.extent,e.spatialReference),this._setCameraDirty()},t.prototype._updateScaleInBoundingRect=function(e,t,r){var i=this,n=this._index;if(!l.isNone(n)){var o=n.rootNode;!l.isNone(o)&&N.boundingRectToBoundingRect(t,r,V,this.crsIndex)&&this._loadedNodeScales.forEach((function(t,r){var o=n.getNode(r);l.isSome(o)&&m.containsPoint(V,o.mbs)&&i._loadedNodeScales.set(r,e)}))}},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()},t.prototype.schedule=function(e,t){return this._idleQueue.push((function(){return c.throwIfAborted(e),t()}))},t.prototype.reschedule=function(e,t){return this._idleQueue.unshift((function(){return c.throwIfAborted(e),t()}))},Object.defineProperty(t.prototype,"isIntegratedMesh",{get:function(){return"integrated-mesh"===this.layer.type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"areScaleBoundsActive",{get:function(){var e=D.extractSafeScaleBounds(this.layer),t=e.minScale,r=e.maxScale;return this.scaleVisibilityEnabled&&(t>0||r>0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"unloadedMemoryEstimate",{get:function(){return l.isNone(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"indexDepth",{get:function(){return l.isSome(this._index)?this._index.maxLevel:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"disableMemCache",{set:function(e){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=e},enumerable:!0,configurable:!0}),t.prototype._frame=function(e,t){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||l.isNone(this._index)?-1/0:(this._processLogError(e,t),this._index.getPriority())},t.prototype._processLogError=function(e,t){try{this._process(e,t)}catch(e){this._errorCount<50?O.error("Error during processing: "+e):50===this._errorCount&&O.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){var r=this;if(this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&!l.isNone(this._index)){for(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(e)&&(this._invisibleDirty=!1),this.isIntegratedMesh&&(e.enabled=!1),e.run((function(){return r._processIndex(e)})),this._updateFeatureLOD(),e.run((function(){return r._processCache(e)})),this.isIntegratedMesh&&(e.enabled=!0),e.run((function(){return r._processNodes(e,t)}));!e.done&&this._idleQueue.process();)e.madeProgress();e.run((function(){return r._prefetchIndex()})),t.numIndexLoading+=this._index.getIndexLoading(),t.numNodesLoading+=this._downloadingCount,e.run((function(){return r._lodHandling.lodGlobalHandling(e)})),this._evaluateUpdating()}},t.prototype._processIndex=function(e){if(l.isNone(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(n.keysOfMap(this._loadingNodes),e),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));var t=this._index.getFeatureEstimate().leafsReached;this._index.isLoading()||t===this._get("leafsReached")||this._set("leafsReached",t)}return this._index.load()},t.prototype._prefetchIndex=function(){return!(l.isNone(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()},t.prototype._updateFeatureLOD=function(){if(this.isGraphics3D&&!l.isNone(this._index)){var e=!this._index.isLoading(),t=this.featureTarget*this.baseLOD,r=this._index.getFeatureEstimate();if(r.estimate=r.estimate||t/2,this._index.getIndexMissing()>500){if(this._featureLOD<=1e-4)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(e&&r.estimate<t){if(r.leafsReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;var i=Math.min(10,Math.max(t/r.estimate,1.001));this._featureLOD*=i;var n=this.lod,o=this._index.checkFeatureTarget(t,n);o!==n&&(this._featureLOD=o/this.baseLOD,this._stableFeatureLOD=!0)}else{if(!(r.estimate>1.2*t||e&&r.estimate>t))return;if(this._featureLOD<=1e-4)return;this._featureLOD/=1+.25*(r.estimate/t-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(1e-4,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.requestUpdate()}},t.prototype._processCache=function(e){var t=this._index;if(l.isNone(t))return!1;for(;this._newLoadingNodes.length>0&&!e.done;)for(var r=this._newLoadingNodes.pop(),i=t.getParent(r);l.isSome(i)&&!this.layerView.isNodeLoaded(i.index)&&this._isNodeInScaleBounds(i);i=t.getParent(i.index))if(this._enableFromGPUCache(i,0)){e.madeProgress();break}return e.hasProgressed},t.prototype._processNodes=function(e,t){if(l.isNone(this._index))return!1;var r=(this._isIdle?100:2)-this._loadingNodes.size,i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.update.length>0&&!e.done;){var n=this._index.getNode(i.update.pop());l.isSome(n)&&(this._updateLoadedNode(n),e.madeProgress())}for(;i.add.length>0&&!e.done&&r>0&&(--r,n=this._index.getNode(i.add.back()),!l.isNone(n)&&(2===n.cacheState||this._hasNodeLoadToken(t)));)i.add.pop(),this._loadNode(n),e.madeProgress();return e.hasProgressed},t.prototype._cancelAllNodes=function(){this._loadingNodes.forEach((function(e){return e.abort()})),this._loadingNodes.clear(),this._updatingNodes.forEach((function(e){return e.abort()})),this._updatingNodes.clear()},t.prototype._cancelNode=function(e){var t=this._loadingNodes.get(e);t&&(t.abort(),this._loadingNodes.delete(e))},t.prototype._hasNodeLoadToken=function(e){return!(!this._isIdle&&e.numNodesLoading+this._loadingNodes.size>=2||this.streamDataController.busy)},t.prototype._evaluateUpdating=function(){var e=!1,t=0;if(this.layerView.suspended)t=(e=this._cameraDirty)?.5:1;else{var r=(l.isSome(this._index)?this._index.getIndexMissing():0)+3*(l.isSome(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;e=!!(r>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===r&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(r,this._progressMaxNumNodes),t=1-r/this._progressMaxNumNodes}e!==this.updating&&this._set("updating",e),t!==this.updatingProgress&&this._set("updatingProgress",t)},t.prototype._updateViewData=function(){if(this._cameraDirty&&!l.isNone(this._index)){var e=this.layerView.view,t=e.state.camera;this.camPos=g.vec3f64.clone(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/(t.perScreenPixelRatio/2),this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.setPointOfInterest(this._poi),this._viewportQueries.updateScreenSpaceErrorBias(this.lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=F.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor},Object.defineProperty(t.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"baseLOD",{get:function(){var e=this.layerView.lodFactor,t=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(e>0?e:1)*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lodDropFactor",{get:function(){if(this.fixedFeatureTarget)return 1;var e=this.layerView.view.resourceController.memoryController;return(Math.min(e.memoryFactor,.5)-e.minQuality)/(.5-e.minQuality)},enumerable:!0,configurable:!0}),t.prototype.isGeometryVisible=function(e){return l.isSome(this._index)&&this._index.isGeometryVisible(e.index)},t.prototype.updateVisibility=function(e){l.isSome(this._index)&&this._index.invalidateVisibilityCache(e)},t.prototype.updateBoundingVolume=function(e){l.isSome(this._index)&&this._index.invalidateBoundingVolumeCache(e)},t.prototype.invalidateComputedOBBs=function(){l.isSome(this._index)&&this._index.invalidateComputedOBBs()},t.prototype.recomputeAuthorativeOBBs=function(){l.isSome(this._index)&&this._index.recomputeAuthorativeOBBs()},t.prototype._shouldLoadNode=function(e){return!(!this._lodHandling.shouldLoadNode(e)||this._shouldDropNode(e)||!this._isNodeInScaleBounds(e))&&(!l.isSome(this._index)||!l.isSome(e.obb)||this._index.isGeometryVisible(e.index))},t.prototype._shouldDropNode=function(e){var t=this.lodDropFactor;return!(t>=1||!this._lodHandling.childrenEmpty(e))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(e))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*t},t.prototype._startNodeLoading=function(){var e=this;this._restartNodeLoading=!1;var t=this._index;if(!this._updatesDisabled&&null!=this.streamDataController&&!l.isNone(t)){this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var r=S.TextureFormat.Normal;this.layerView.useCompressedTextures?r=S.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(r=S.TextureFormat.Downsampled);var i={textureFormat:r,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid};this._nodeLoader=new S(this.layer,this.streamDataController,O,this._defaultGeometrySchema,this._requiredAttributes,i),t.requestUpdate(),this._lodHandling.startNodeLoading((function(e){return t.isNodeVisible(e)}),(function(e){return t.isGeometryVisible(e)}),(function(t){return e._isNodeInScaleBounds(t)}),(function(e){return t.nodeTraversalState(e)}),(function(t,r){return e._removeNodes(t,r)}),t,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this.streamDataController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())},t.prototype._removeInvisibleNodes=function(e){var t=this,r=this._index;if(l.isNone(r))return!1;A.clear(),this.layerView.getLoadedNodeIndices(A);var i=0===this._viewportQueries.maxDistance,n=i?function(){return!1}:function(e){return t._shouldDropNode(e)};return A.filterInPlace((function(e){var i=r.getNode(e);return l.isNone(i)||!r.isGeometryVisible(e)||n(i)||!t._isNodeInScaleBounds(i)})),A.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(A,e),!(i&&this.lodDropFactor<1||0!==A.length&&(A.clear(),1))},t.prototype._removeNodes=function(e,t){e.length>0&&l.isSome(this._index)&&this._index.requestUpdate();var r=e.length;if(this.layerView.removeNodeData(e,t),this._loadedNodeScales.size>0)for(var i=e.length;i<r;i++){var n=e.data[i];this._loadedNodeScales.delete(n)}},t.prototype._needsUpdate=function(e){if(!e.resources.hasFeatureData||this._updatingNodes.has(e.index))return!1;var t=this.layerView.getLoadedAttributes(e.index);return null!=t&&t!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,r=c.createAbortController();this._updatingNodes.set(e.index,r),(T(this.layerView.getLoadedAttributes(e.index),this._requiredAttributes)?c.resolve(this.layerView.getAttributeData(e.index)):this._nodeLoader.loadAttributes(e,this._requiredAttributes,r.signal)).then((function(i){return t.schedule(r.signal,(function(){return t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:i})}))})).catch((function(r){c.isAbortError(r)||t.layerView.setAttributeData(e.index,{loadedAttributes:t._requiredAttributes,attributeData:{}})})).catch((function(){})).then((function(){t._updatingNodes.delete(e.index),t._evaluateUpdating()})),this._evaluateUpdating()},t.prototype._loadNode=function(e){var t=this;if(this._loadingNodes.has(e.index))O.error("already loading node "+e.index);else{var r=c.createAbortController();this._loadingNodes.set(e.index,r),this._evaluateUpdating(),this._loadAndAddNode(e,r.signal).catch((function(e){return e})).then((function(){t._loadingNodes.get(e.index)===r&&t._loadingNodes.delete(e.index),t._evaluateUpdating()}))}},t.prototype._loadAndAddNode=function(e,t){var r=this;return 1===e.cacheState?this._loadUncached(e,t):this._loadCached(e,t).then((function(t){t||(e.cacheState=1,l.isSome(r._index)&&r._index.updates.add.push(e.index))})).catch((function(t){c.isAbortError(t)||(e.cacheState=1)}))},t.prototype._enableFromGPUCache=function(e,t){if(this._disableMemCache||l.isNone(this._index))return!1;if(0===t&&!this._index.useNodeAsHole(e.index))return!0;var r=this._loadCachedGPUData(e);return!!r&&(this.layerView.addCachedGPUData(e,r,t),this._nodeAdded(),!0)},t.prototype._loadCachedGPUData=function(e){var t=this.layerView.loadCachedGPUData(e);return l.isSome(t)&&R(t.attributeInfo)&&T(t.attributeInfo.loadedAttributes,this._requiredAttributes)?t:null},t.prototype._nodeAdded=function(){l.isSome(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()},t.prototype._loadCached=function(e,t){var r=this;if(this._enableFromGPUCache(e,1))return c.resolve(!0);var i=this.layerView;return!this.disableIDBCache&&i.loadCachedNodeData&&i.addCachedNodeData?this.schedule(t,(function(){return i.loadCachedNodeData(e,t,(function(t,i){return r._nodeLoader.loadTextures(e,t,i)}))})).then((function(n){if(l.isNone(n))return!1;var o=r._requiredAttributes;return R(n)&&T(n.loadedAttributes,o)?r.reschedule(t,(function(){return i.addCachedNodeData(e,n,n,t)})).then((function(){return r._nodeAdded(),!0})):r.reschedule(t,(function(){return r._nodeLoader.loadAttributes(e,o,t)})).then((function(a){return r.reschedule(t,(function(){return i.addCachedNodeData(e,n,{loadedAttributes:o,attributeData:a},t)}))})).then((function(){return r._nodeAdded(),!0}))})):c.resolve(!1)},t.prototype._loadUncached=function(e,t){var r=this;return this._downloadingCount++,this._nodeLoader.loadNodeData(e,t).catch((function(e){throw r._downloadingCount--,e})).then((function(i){return r._downloadingCount--,r.schedule(t,(function(){return r.layerView.addNodeData(e,i,t)}))})).then((function(){r._nodeAdded(),e.cacheState=2})).catch((function(t){c.isAbortError(t)||(O.error("Failed to load node '"+e.id+"': "+t),e.failed=!0,l.isSome(r._index)&&r._index.requestUpdate())}))},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdating(),e&&this._index&&l.isSome(this._index)&&this._index.resetFailedNodes())},t.prototype._getScale=function(e){if(this._loadedNodeScales.has(e.index))return this._loadedNodeScales.get(e.index);this._tmpPoint.x=e.mbs[0],this._tmpPoint.y=e.mbs[1],this._tmpPoint.z=e.mbs[2];var t=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);return this.layerView.isNodeLoaded(e.index)&&this._loadedNodeScales.set(e.index,t),t},t.prototype._isNodeInScaleBounds=function(e){if(!this.areScaleBoundsActive)return!0;var t=this._getScale(e),r=D.extractSafeScaleBounds(this.layer),i=r.minScale,n=r.maxScale;return D.scaleBoundsPredicate(t,i,n)},t.prototype.updateStats=function(e){e.index=l.isSome(this._index)?this._index.size:0,this.isGraphics3D&&(e.detail=this._featureLOD,e.target=this.featureTarget*this.baseLOD),l.isSome(this._index)&&this._index.updateStats(e)},Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{index:this._index,set disableUpdates(t){e._updatesDisabled=t,t?e.cancelNodeLoading():e.requestUpdate()},set disableIDBCache(t){e.disableIDBCache=t},set ignoreServiceOBB(t){l.isSome(e._index)&&(e._index.ignoreServiceOBB=t)},shouldLoadNode:function(t){return e._shouldLoadNode(t)}}},enumerable:!0,configurable:!0}),r.__decorate([p.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),r.__decorate([p.property({readOnly:!0})],t.prototype,"isGraphics3D",null),r.__decorate([p.property({readOnly:!0})],t.prototype,"streamDataController",null),r.__decorate([p.property({readOnly:!0})],t.prototype,"crsVertex",null),r.__decorate([p.property({readOnly:!0})],t.prototype,"crsIndex",null),r.__decorate([p.property()],t.prototype,"camPos",void 0),r.__decorate([p.property()],t.prototype,"screenSizeFactor",void 0),r.__decorate([p.property()],t.prototype,"featureTarget",void 0),r.__decorate([p.property()],t.prototype,"fixedFeatureTarget",void 0),r.__decorate([p.property()],t.prototype,"layerView",void 0),r.__decorate([p.property()],t.prototype,"layer",void 0),r.__decorate([p.property({readOnly:!0})],t.prototype,"updating",void 0),r.__decorate([p.property({readOnly:!0})],t.prototype,"updatingProgress",void 0),r.__decorate([p.property({readOnly:!0})],t.prototype,"leafsReached",void 0),r.__decorate([p.property({constructOnly:!0})],t.prototype,"scaleVisibilityEnabled",void 0),r.__decorate([p.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),r.__decorate([p.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],t.prototype,"uncompressedTextureDownsamplingEnabled",void 0),r.__decorate([p.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(u.EsriPromiseMixin(i)),A=new d({deallocator:null});function T(e,t){return l.isSome(e)&&e.length===t.length&&e.every((function(e){return E(t,e.name)>=0}))}function E(e,t){for(var r=t.toLowerCase(),i=0;i<e.length;i++)if(e[i].name.toLowerCase()===r)return i;return-1}var F={factorIM:.2,factor3dObject:.05,distancePenalty:10};function R(e){return l.isSome(e)&&l.isSome(e.loadedAttributes)&&l.isSome(e.attributeData)}var V=m.create();return P}.apply(null,i))||(e.exports=n)},728:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(180),r(211)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){var t=this;this.referenceCount=0,this.callbacks=[],this.runIndex=0,this.handle=e.registerTask(i.Task.I3S_CONTROLLER,(function(e){return t.update(e)}),(function(){return t.needsUpdate()}))}return e.prototype.destroy=function(){this.handle&&(this.handle.remove(),this.handle=null)},e.prototype.needsUpdate=function(){for(var e=0,t=this.callbacks;e<t.length;e++)if(t[e].needsUpdate())return!0;return!1},e.prototype.update=function(e){this.sort();for(var t=this.callbacks,r={numIndexLoading:0,numNodesLoading:0},i=0;i<t.length&&!e.done;++i)t[i].priority=t[i].update(e,r),this.runIndex=i},e.prototype.sort=function(){for(var e=this.callbacks,t=e.length,r=this.runIndex;r>0;r--){for(var i=e[r-1],n=r;n<e.length&&i.priority<=e[n].priority&&(n!==t||i.priority<e[n].priority);)e[n-1]=e[n],n++;e[n-1]=i,t=n-1}this.runIndex=0},e.prototype.add=function(e){this.sort(),e.priority=1/0,this.callbacks.unshift(e)},e.prototype.remove=function(e){r.removeUnordered(this.callbacks,e),this.runIndex=this.callbacks.length,this.sort()},e}(),o=new Map;t.addTask=function(e,t){var r=o.get(e);return null==r&&(r=new n(e),o.set(e,r)),r.add(t),{remove:function(){null!=r&&(r.remove(t),r.callbacks.length>0||(o.delete(e),r.destroy()),r=null)}}}}.apply(null,i))||(e.exports=n)},729:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(152),r(214),r(153),r(162),r(201),r(730),r(250),r(289)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d){Object.defineProperty(t,"__esModule",{value:!0});var u=function(e,t,r,i,n){this.childOffset=e,this.childCount=t,this.visibilityCache=r,this.ref=i,this.node=n,this.useAsHole=0},c=function(){function e(e,t,r,n,o,a,s,l,d,u,c){this.streamDataController=t,this.viewportQueries=r,this.logger=n,this.holeFilling=o,this._isLoaded=a,this._isSelected=s,this._enable=l,this._needsUpdate=d,this._canRequest=u,this._computeAuthorativeOBB=c,this._dirty=!0,this.nodePages=[],this.nodeCount=0,this.nodesPerPage=0,this.rootIndex=0,this.lodMetric=0,this.lodConversion=function(e){return e},this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState={},this._version=y(0),this._visibilityCacheVersion=y(0),this._maxLevel=1,this._featureEstimate={estimate:0,leafsReached:!1},this._unloadedMemoryEstimate=0,this._missing=new i({deallocator:null}),this._prefetch=new i({deallocator:null}),this._updates=new p,this.ignoreServiceOBB=!1,this.progressiveLoadPenalty=0,this.layerUrl=e.parsedUrl.path,this.rootId=e.rootNode&&e.rootNode.split("/").pop(),e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=""+e.serviceUpdateTimeStamp.lastUpdate),this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1,e.nodePages?this.initNodePages(e.nodePages):this.initNodeDocuments(this.rootId)}return e.prototype.initNodePages=function(e){switch(this.nodesPerPage=e.nodesPerPage,this.rootIndex=e.rootIndex,e.lodSelectionMetricType){case"maxScreenThreshold":this.lodMetric=1;break;case"maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=M}},e.prototype.initNodeDocuments=function(e){this.nodesPerPage=0,this.rootIndex=0,this.nodePages.push({nodes:[],children:[],parents:[]}),this.makeRefNode(new s.NodeBase(e,null),-1)},e.prototype.loadPage=function(e){var t=this;this._loading.add(e);var r=this.layerUrl+"/nodepages/"+e;this.streamDataController.request(r,"json").then((function(r){t._loading.delete(e),t.addPage(e,r)})).catch((function(r){if(t._loading.delete(e),!n.isAbortError(r)){if(0===t.nodePages.length)return t.initNodeDocuments(t.rootId);t._failedPages.add(e),t.logger.error("Error when loading page "+e,r)}}))},e.prototype.addPage=function(e,t){for(var r=this,i=this.nodePages.length;i<e;i++)this.nodePages[i]=null;var n=[],l=[],c=t.nodes.map((function(t,i){var c=n.length,h=t.children?t.children.length:0;l.push(-1);for(var p=0;p<h;p++)n.push(t.children[p]);var f=""+t.index,y=d.clone(t.obb),m=a.vec4f64.fromArray([y.center[0],y.center[1],y.center[2],o.vec3.length(y.halfSize)]),_=t.mesh&&t.mesh.attribute,v=t.mesh&&t.mesh.geometry,b=t.mesh&&t.mesh.material,x={hasSharedResource:!1,hasFeatureData:!!v,attributes:_&&null!=_.resource?""+_.resource:null,geometry:v&&null!=v.resource?""+v.resource:null,texture:b&&null!=b.resource?""+b.resource:null,geometryDefinition:v?v.definition:-1,materialDefinition:b?b.definition:-1},w=new s.Node(f,e*r.nodesPerPage+i,m,h,0,x,r.lastUpdate,r.lodMetric,r.lodConversion(t.lodThreshold),v?v.featureCount:null);return w.obb=y,w.authorativeObb=r._computeAuthorativeOBB(w),w.vertexCount=v?v.vertexCount:0,new u(c,h,g(r._visibilityCacheVersion),null,w)}));this.nodePages[e]={nodes:c,children:n,parents:l},this.nodeCount+=c.length,this.updateParentsAndLevel()},e.prototype.updateParentsAndLevel=function(){var e=this,t=[],i=function(i,n,o){var a=e.getPage(i);if(r.isSome(a)){var s=x(i,e.nodesPerPage);a.parents[s]=n;var l=a.nodes[s].node;r.isSome(l)&&(l.level=o,t.push(i))}};for(i(this.rootIndex,-1,0);t.length;){var n=t.pop(),o=this.getNode(n);if(r.isSome(o))for(var a=0;a<o.childCount;a++)i(this.getChildIndex(o,a),n,o.level+1)}},e.prototype.getPage=function(e){return this.nodePages[b(e,this.nodesPerPage)]},e.prototype.getNodeInternal=function(e){var t=this.getPage(e);return r.isNone(t)?null:t.nodes[x(e,this.nodesPerPage)]},e.prototype.addNode=function(e,t){null!=e.children&&this.populateChildren(t,e.children);var i=this.getParent(t),n=r.isSome(i)?i.level+1:1;this._maxLevel=Math.max(this._maxLevel,n);var o=S(e.lodSelection),l=o.lodMetric,u=o.maxError,c=r.unwrap(this.getNodeInternal(t));return c.node=new s.Node(e.id,t,a.vec4f64.fromArray(e.mbs),c.childCount,n,e.resources,e.version,l,u,e.numFeatures),e.obb&&(c.node.obb=d.clone(e.obb)),c.node.authorativeObb=this._computeAuthorativeOBB(c.node),r.isSome(c.ref)&&(null==c.ref.mbs&&(c.ref.mbs=e.mbs),c.node.renderMbs=c.ref.renderMbs,c.node.renderObb=c.ref.renderObb,c.ref.authorativeObb=c.node.authorativeObb),c.node},e.prototype.makeRefNode=function(e,t){var i=this.nodePages[0],n=i.nodes.length;return i.nodes.push(new u(0,0,g(this._visibilityCacheVersion),e,null)),this.nodeCount++,i.parents.push(t),e.renderMbs[3]=-1,r.isSome(e.renderObb)&&(e.renderObb.halfSize[0]=-1),n},e.prototype.populateChildren=function(e,t){var i=r.unwrap(this.getNodeInternal(e)),n=r.unwrap(this.getPage(e));i.childOffset=n.children.length,i.childCount=t.length;for(var o=0;o<t.length;o++){var a=this.makeRefNode(t[o],e);n.children.push(a)}},e.prototype.getNode=function(e){var t=this.getNodeInternal(e);return r.isSome(t)?t.node:null},e.prototype.getIndexById=function(e){var t;return this.forAllNodes((function(i,n){(r.isSome(i.node)&&i.node.id===e||r.isSome(i.ref)&&i.ref.id===e)&&(t=n)})),t},e.prototype.getNodeById=function(e){var t=this.getIndexById(e);return t>=0?this.getNode(t):null},e.prototype.getChildIndex=function(e,t){var i=this.getPage(e.index);if(r.isNone(i))return-1;var n=i.nodes[x(e.index,this.nodesPerPage)];return i.children[n.childOffset+t]},e.prototype.getParentIndex=function(e){var t=this.getPage(e);return r.isSome(t)?t.parents[x(e,this.nodesPerPage)]:-1},e.prototype.getParent=function(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null},e.prototype.isLeaf=function(e){var t=this.getNodeInternal(e);return r.isSome(t)&&0===t.childCount},Object.defineProperty(e.prototype,"rootNode",{get:function(){return this.getNode(this.rootIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this.nodeCount},enumerable:!0,configurable:!0}),e.prototype.invalidateVisibilityCache=function(e){if(null==e)this._visibilityCacheVersion=y(this._visibilityCacheVersion);else{var t=this.getNodeInternal(e);r.isSome(t)&&(t.visibilityCache=g(this._visibilityCacheVersion))}},e.prototype.invalidateBoundingVolumeCache=function(e){var t=this.getNodeInternal(e);r.isSome(t)&&(f(t),t.visibilityCache=g(this._visibilityCacheVersion))},e.prototype.invalidateComputedOBBs=function(){r.isNone(this.rootNode)||this.traverse(this.rootNode,(function(e){return e.isComputedObb&&(e.obb=null),e.renderMbs[3]=-1,r.isSome(e.renderObb)&&(e.renderObb.halfSize[0]=-1),!0}))},e.prototype.recomputeAuthorativeOBBs=function(){var e=this;r.isNone(this.rootNode)||this.traverse(this.rootNode,(function(t){return t.authorativeObb=e._computeAuthorativeOBB(t),!0}))},e.prototype.isNodeVisible=function(e){var t=this.getNodeInternal(e);if(r.isNone(t)||r.isSome(t.ref)&&!t.ref.mbs)return!0;if(!_(t.visibilityCache,this._visibilityCacheVersion)){var i=!0;return r.isSome(t.node)&&(r.isNone(t.ref)||r.isSome(t.node.authorativeObb))?i=this.viewportQueries.isNodeVisible(t.node):r.isSome(t.ref)&&(i=this.viewportQueries.isNodeVisible(t.ref)),t.visibilityCache=m(i,this._visibilityCacheVersion),i}return v(t.visibilityCache)},e.prototype.isGeometryVisible=function(e){if(!this.isNodeVisible(e))return!1;var t=this.getNodeInternal(e);return!!r.isNone(t)||!(r.isSome(t.node)&&r.isSome(t.ref)&&!t.ref.obb)||this.viewportQueries.isGeometryVisible(t.node)},e.prototype._traverseCoverage=function(e,t,i,n,o){var a=this.getPage(e);if(!r.isNone(a)&&0!==t.childCount){for(var s=t.childOffset+t.childCount,l=new Array,d=t.childOffset;d<s;++d){var u=a.children[d],c=this.getNodeInternal(u);r.isSome(c)&&r.isSome(c.node)&&this.isGeometryVisible(u)&&l.push(c)}n/=l.length;for(var h=0,p=l;h<p.length;h++)c=p[h],u=r.unwrap(c.node).index,this._isLoaded(u)?(o.delta=Math.max(o.delta,i),o.coverage+=n):this._traverseCoverage(u,c,i+1,n,o)}},e.prototype.useNodeAsHole=function(e){if("off"===this.holeFilling)return!1;var t=this.getNodeInternal(e);if(r.isNone(t))return!1;if("always"===this.holeFilling)return!0;if(_(t.useAsHole,this._version))return v(t.useAsHole);var i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);var n=i.delta*i.coverage<=.5;return t.useAsHole=m(n,this._version),n},Object.defineProperty(e.prototype,"maxLevel",{get:function(){return this._maxLevel},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dirty",{get:function(){return this._dirty},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this._updates.add.prune(),this._updates.update.prune()},e.prototype.requestUpdate=function(){this._dirty=!0,this._indexMissing=1,this._version=y(this._version)},e.prototype.update=function(e,t){var i=this;if(this._dirty){this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e,this._missing),h.clear();var n=!0,o=new C,a=new C;this.traverseVisible((function(s,l){if(!l){var d=i.entryPriority(s),u=b(s,i.nodesPerPage);return h.set(u,Math.max(d,h.get(u)||0)),i._loading.has(u)||i._failedPages.has(u)||i._missing.push(u),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,d))}var c=l.node;if(i._updateNodeFeatureEstimate(c,a),r.isNone(c)){var p=i.entryPriority(s);return i._loading.has(s)||i._failedNodes.has(s)||(i._missing.push(s),h.set(s,p)),void(i._maxProcessingPrio=Math.max(i._maxProcessingPrio,p))}var f=r.unwrap(i.getPage(s));if(0===i._missing.length&&0===i.nodesPerPage)for(var g=0;g<l.childCount;g++){var y=f.children[l.childOffset+g],m=i.getNodeInternal(y);!r.isSome(m)||m.node||i._loading.has(y)||i._failedNodes.has(y)||(h.set(y,i.entryPriority(y)),i._prefetch.push(y))}if(!c.failed&&c.resources.hasFeatureData)if(i._isLoaded(s)){if(o.known+=c.memory,++o.knownNodes,i._isSelected(c)?l.childCount>0&&(n=!1):(o.unremoved+=c.memory,n=!1),i._needsUpdate(c)){var _=i.entryPriority(s);h.set(s,_),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,_),i._updates.update.push(s)}}else if(c.memory&&(o.known+=c.memory,++o.knownNodes),i._isSelected(c)){if(l.childCount>0&&(n=!1),c.memory?(o.missing+=c.memory,o.known+=c.memory,++o.knownNodes):++o.missingNodes,e.indexOf(c.index)>=0)return i._maxProcessingPrio=Math.max(i._maxProcessingPrio,i.entryPriority(s)),void(i._updates.cancel=i._updates.cancel.filter((function(e){return e!==c.index})));if(t.done||!i._enable(c)){var v=i.entryPriority(s);h.set(s,v),i._maxProcessingPrio=Math.max(i._maxProcessingPrio,v),i._updates.add.push(s)}else t.madeProgress()}})),this._unloadedMemoryEstimate=o.missing-o.unremoved,o.knownNodes>3&&o.missingNodes>0&&(this._unloadedMemoryEstimate+=o.known/o.knownNodes*o.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(a),this._featureEstimate.leafsReached=n,this._missing.sort((function(e,t){return e-t})),this._missing.filterInPlace((function(e,t){return t<1||i._missing.data[t-1]!==e})),this._missing.sort((function(e,t){return h.get(e)-h.get(t)})),this._missing.length>0?(this._maxUnloadedPrio=h.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort((function(e,t){return h.get(e)-h.get(t)})),this._updates.add.filterInPlace((function(e){return h.get(e)>=i._maxUnloadedPrio})).sort((function(e,t){return h.get(e)-h.get(t)})),this._updates.update.sort((function(e,t){return h.get(e)-h.get(t)})),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,h.clear()}},e.prototype.checkFeatureTarget=function(e,t){for(var r=this.viewportQueries.updateScreenSpaceErrorBias(t),i=t,n=t,o=r,a=10;a--;){var s=new C;if(this._updateFeatureEstimate(i,s),this._computeFeatureEstimate(s)<=e){if(i>=t||s.missingNodes>0||0===a)break;o=i,i=.5*(i+n)}else n=i,i=.5*(i+o)}return this._version=y(this._version),this.viewportQueries.updateScreenSpaceErrorBias(r),Math.min(t,i)},e.prototype._updateFeatureEstimate=function(e,t){var r=this;this._version=y(this._version),this.viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((function(e,i){return r._updateNodeFeatureEstimate(i&&i.node,t)}))},e.prototype._updateNodeFeatureEstimate=function(e,t){if(!(r.isNone(e)||e.failed||r.isNone(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&(r.isSome(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))},e.prototype._computeFeatureEstimate=function(e){var t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)},e.prototype.load=function(){return this._load(this._missing)},e.prototype.prefetch=function(){return this._load(this._prefetch)},e.prototype._load=function(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this.nodesPerPage?this._loadNode(e.pop()):this.loadPage(e.pop());return!0},e.prototype.isLoading=function(){return this._indexMissing>0},e.prototype.getIndexLoading=function(){return this._loading.size},e.prototype.getIndexMissing=function(){return this._indexMissing},e.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate},Object.defineProperty(e.prototype,"updates",{get:function(){return this._updates},enumerable:!0,configurable:!0}),e.prototype.getFeatureEstimate=function(){return this._featureEstimate},e.prototype.nodeTraversalState=function(e){if(r.isNone(e))return null;var t=this._nodeTraversalState[e.index];if(t&&_(t.version,this._version))return t;var i=this.viewportQueries.getLodLevel(e),n=this.viewportQueries.hasLOD(e),o=!0;if(n){var a=this.getParentIndex(e.index);if(a>=0){var s=this._nodeTraversalState[a];o=s&&i>s.lodLevel}else o=i>0}else o=0===e.childCount;return t?(t.lodLevel=i,t.isChosen=o,t.version=m(!0,this._version),t):(this._nodeTraversalState[e.index]={nodeHasLOD:n,lodLevel:i,isChosen:o,version:m(!0,this._version)},this._nodeTraversalState[e.index])},e.prototype._loadNode=function(e){var t=this;this._loading.add(e);var i=r.unwrap(this.getNodeInternal(e)).ref;if(r.isNone(i))this._failedNodes.add(e);else{var o=i.id,a=this.layerUrl+"/nodes/"+o,s=function(){t._loading.delete(e),0===t._missing.length&&0===t._loading.size&&t.requestUpdate()};this.streamDataController.request(a,"json").then((function(r){var i=t._validateNode(o,r);if(null!=i){i.obb&&t.invalidateVisibilityCache(e);var n=t.addNode(i,e);t.nodeTraversalState(n),s()}else s()}),(function(r){n.isAbortError(r)||(t.logger.error("Error loading node: "+a),t._failedNodes.add(e)),s()}))}},e.prototype._validateNode=function(e,t){var r=this;if(null==t||"object"!=typeof t||t.id!==e)return this.logger.error('Invalid node. Wrong type or wrong id "'+e+'"'),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this.logger.warn('Invalid shared resource href on node "'+e+'"'),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this.logger.warn('Invalid geometry data on node "'+e+'"'),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((function(e,t){return e.href!=="./attributes/f_"+t+"/0"}))||this.logger.warn('Invalid attribute data on node "'+e+'"'),t.featureData&&t.featureData.length>1&&this.logger.warn("Node "+e+" has "+t.featureData.length+" bundles. Only the first bundle will be loaded.");var i=t.hasOwnProperty("obb")&&!this.ignoreServiceOBB?t.obb:null,n=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:null,o=Array.isArray(t.children)?t.children.map((function(t){if(null==t)return null;var i=function(t){return r.logger.error("Invalid node reference on node "+e+": "+t)};if("number"==typeof t.id)i("id "+t.id+" is a number instead of a string.");else if("string"!=typeof t.id||!Array.isArray(t.mbs))return i("Missing or invalid id."),null;if(!Array.isArray(t.mbs))return i("Invalid bounding volume on reference "+t.id+"."),null;t.href&&t.href!=="../"+t.id&&r.logger.error('Invalid node href on node "'+e+'"');var n=t.hasOwnProperty("obb")&&!r.ignoreServiceOBB?t.obb:null,o=new s.NodeBase(""+t.id,t.mbs);return o.obb=n,o})).filter((function(e){return null!=e})):null;return{id:e,mbs:t.mbs,obb:i,children:o,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:null,texture:t.textureData&&t.textureData.length>0?e:null,geometry:null!=t.geometryData?e:null},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:n}},e.prototype.resetFailedNodes=function(){this._failedNodes.clear(),this._failedPages.clear(),this.forAllNodes((function(e){r.isSome(e.node)&&(e.node.failed=!1)}))},e.prototype.entryPriority=function(e){var t=this.getNodeInternal(e),i=this.getParentIndex(e);if(r.isNone(t)||i<0&&null==t.node)return i<0?1/0:this.entryPriority(i);var n=0;if(t.node&&i>=0){var o=this._nodeTraversalState[i];null!=o&&(n=o.lodLevel)}for(var a=this.progressiveLoadPenalty,s=e;s>=0;s=this.getParentIndex(s))if(this._isLoaded(s)){a=0;break}var l=r.isSome(t.ref)?this.viewportQueries.distToPOI(t.ref):r.isSome(t.node)?this.viewportQueries.distToPOI(t.node):0;return-l-n*(l+this.progressiveLoadPenalty)+a},e.prototype.traverseVisible=function(e){var t=this.getNodeInternal(this.rootIndex);r.isNone(t)?e(this.rootIndex,null):this._traverseVisible(this.rootIndex,t,e)},e.prototype._traverseVisible=function(e,t,i){if(t.node&&0===t.childCount)this.isGeometryVisible(e)&&i(e,t);else if(this.isNodeVisible(e)&&(i(e,t),null!=t.node)){var n=this.nodeTraversalState(t.node);if(!n.nodeHasLOD||n.lodLevel!==this._maxLodLevel)for(var o=r.unwrap(this.getPage(e)),a=0;a<t.childCount;a++){var s=o.children[t.childOffset+a],l=this.getNodeInternal(s);r.isSome(l)?this._traverseVisible(s,l,i):i(s,null)}}},e.prototype.traverse=function(e,t){t(e)&&this.traverseChildren(e,t)},e.prototype.traverseChildren=function(e,t){var i=e.index,n=this.getNodeInternal(i);r.isSome(n)&&this._traverseChildren(i,n,t)},e.prototype._traverseChildren=function(e,t,i){var n=this.getPage(e);if(!r.isNone(n))for(var o=t.childOffset+t.childCount,a=t.childOffset;a<o;++a){var s=n.children[a],l=this.getNodeInternal(s);r.isSome(l)&&r.isSome(l.node)&&i(l.node)&&this._traverseChildren(s,l,i)}},e.prototype.updateStats=function(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||!1),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){var t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}},e.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)},e.prototype.updateElevationInfo=function(e){this.forAllNodes(f),this.viewportQueries.updateElevationInfo(e)},e.prototype.forAllNodes=function(e){for(var t=0;t<this.nodePages.length;t++){var r=this.nodePages[t];if(r)for(var i=t*this.nodesPerPage,n=0;n<r.nodes.length;n++)e(r.nodes[n],i+n)}},Object.defineProperty(e.prototype,"test",{get:function(){var e=this;return{addNode:function(t,r){return e.addNode(t,r)}}},enumerable:!0,configurable:!0}),e}();t.I3SIndex=c;var h=new Map,p=function(){function e(){this.update=new i({deallocator:null}),this.add=new i({deallocator:null}),this.cancel=[]}return e.prototype.reset=function(e,t){this.add.clear(),this.update.clear(),this.cancel=e,this.missing=t},e}();function f(e){r.isSome(e.node)&&(e.node.renderMbs[3]=-1,r.isSome(e.node.renderObb)&&(e.node.renderObb.halfSize[0]=-1)),r.isSome(e.ref)&&(e.ref.renderMbs[3]=-1,r.isSome(e.ref.renderObb)&&(e.ref.renderObb.halfSize[0]=-1))}function g(e){return l.addWraparound(e,-2)}function y(e){return l.addWraparound(e,2)}function m(e,t){return t+(e?1:0)}function _(e,t){return(-2&e)===t}function v(e){return 1==(1&e)}function b(e,t){return 0===t?0:e/t|0}function x(e,t){return 0===t?e:e%t}var w=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];function S(e){if(e)for(var t=0;t<e.length;t++)for(var r=0,i=w;r<i.length;r++){var n=i[r];if(n[0]===e[t].metricType)return{lodMetric:n[1],maxError:e[t].maxError}}return{lodMetric:0,maxError:0}}t.selectErrorMetric=S;var C=function(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0};function M(e){return Math.sqrt(e*(4/Math.PI))}}.apply(null,i))||(e.exports=n)},730:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(201)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e,t){this.id=e,this.mbs=t,this.isComputedObb=!1,this.renderMbs=i.vec4f64.fromArray([0,0,0,-1])};t.NodeBase=n;var o=function(e){function t(t,r,i,n,o,a,s,l,d,u){var c=e.call(this,t,i)||this;return c.index=r,c.childCount=n,c.level=o,c.resources=a,c.version=s,c.lodMetric=l,c.maxError=d,c.numFeatures=u,c.failed=!1,c.cacheState=0,c.vertexCount=0,c.memory=0,c}return r.__extends(t,e),t}(n);t.Node=o}.apply(null,i))||(e.exports=n)},731:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(152),r(214)],void 0===(n=function(e,t,r,i){var n=function(){function e(e){this.layerView=e,this._lodGlobalDirty=!1}return e.prototype.startNodeLoading=function(e,t,r,i,n,o,a){this._maxLodLevel=a.maxLodLevel,this._index=o,this._nodeTraversalState=i,this._isNodeVisible=e,this._isGeometryVisible=t,this._isNodeInScaleBounds=r,this._removeNodes=n},e.prototype.shouldLoadNode=function(e){if(r.isNone(e))return!1;var t=this._nodeTraversalState(e);return!!this.isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)},e.prototype.setLodGlobalDirty=function(){this._lodGlobalDirty=!0},Object.defineProperty(e.prototype,"requiresLODGlobalHandling",{get:function(){return null!=this._index&&!0===this._lodGlobalDirty},enumerable:!0,configurable:!0}),e.prototype.lodGlobalHandling=function(e){if(!this.requiresLODGlobalHandling)return!1;var t=this.layerView.view.resourceController.memoryController.usedMemory,r=Math.max(0,Math.floor(10*(t-1)));o.clear(),this._lodGlobalHandlingRecursion(this._index.rootNode,r);var i=o.length;this._removeNodes(o,e);var n=o.length<i;return 0===o.length&&(this._lodGlobalDirty=!1),o.clear(),n},e.prototype._lodGlobalHandlingRecursion=function(e,t){if(r.isNone(e))return!1;var i=this._nodeTraversalState(e),n=this.isChosenMaxLOD(i),a=this.layerView.isNodeLoaded(e.index);if(a){if(n)return this._removeChildrenRecursive(e),this.layerView.updateNodeState(e.index,1),!0;this.layerView.updateNodeState(e.index,0)}var s=!1;if(e.childCount>0){s=!0;for(var l=0;l<e.childCount;l++){var d=this._index.getChildIndex(e,l),u=this._index.getNode(d);r.isSome(u)?this._isGeometryVisible(d)&&!this._lodGlobalHandlingRecursion(u,t)&&this._isNodeInScaleBounds(u)&&(s=!1):this._isNodeVisible(d)&&(s=!1)}}a&&!n&&(s||o.length<t)&&(o.push(e.index),a=!1);var c=!e.resources.hasFeatureData;return s||a||c},e.prototype._removeChildrenRecursive=function(e){this._index.traverseChildren(e,(function(e){return o.push(e.index),!0}))},e.prototype.childrenEmpty=function(e){var t=this,r=!0;return this._index.traverseChildren(e,(function(e){return!(!r||!t._isNodeVisible(e.index)||t.layerView.isNodeLoaded(e.index)&&(r=!1,1))})),r},e.prototype._childrenRequireLoading=function(e){var t=this,r=!1,i=!0;return this._index.traverseChildren(e,(function(e){if(!i||!t._isNodeVisible(e.index))return!1;var n=t._nodeTraversalState(e);return t.isChosenMaxLOD(n)&&t._isGeometryVisible(e.index)&&(r=!0),!t.layerView.isNodeLoaded(e.index)||(i=!1,!1)})),i&&r},e.prototype.isChosenMaxLOD=function(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)},e}(),o=new i({deallocator:null});return n}.apply(null,i))||(e.exports=n)},732:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(226),r(164),r(118),r(152),r(153),r(172),r(403),r(733),r(250)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c){var h=function(){function e(e,t,r,i,n,o){if(this.streamDataController=t,this.logger=r,this.defaultGeometrySchema=i,this.requiredAttributes=n,this.options=o,this.layerUrl=e.parsedUrl.path,this.geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){var a=e.textureSetDefinitions;this.materialAndTextures=e.materialDefinitions.map((function(e){return u.getMaterialAndTextures(a,e)}))}}return e.prototype.load=function(e,t,r){return this.streamDataController.request(e,t,{signal:r})},e.prototype.loadAttribute=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.attributes+"/attributes/"+t.key+"/0";return this.load(i,"binary",r).then((function(e){return d.readBinaryAttribute(t,e)}))},e.prototype.loadAttributes=function(e,t,r){var i=this;return s.eachAlways(t.map((function(t){return i.loadAttribute(e,t.attributeStorageInfo,r)}))).then((function(r){for(var n={},o=0;o<t.length;++o)if(r[o].value)n[t[o].name]=r[o].value;else{if(s.isAbortError(r[o].error))throw r[o].error;i.logger.error("Failed to load attributeData for '"+t[o].name+"' on node '"+e.id+"'",r[o].error)}return n}))},e.prototype.loadNodeData=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var l,c,h,p,f,g,y,m,_,v,b,x,w,S,C,M,I,N,D,O,P,A,T,E,F,R,V,L,j;return r.__generator(this,(function(r){switch(r.label){case 0:return l=null!=this.requiredAttributes&&e.resources.attributes?i.result(this.loadAttributes(e,this.requiredAttributes,t)):null,c=function(e,t){var r={bufferDefinition:null,bufferIndex:0};if(null==e||t.resources.geometryDefinition<0)return r;var i=t.resources.geometryDefinition>=0?e[t.resources.geometryDefinition].geometryBuffers:null;if(null==i)return r;for(var o=0;o<i.length;o++)if(null==i[o].compressedAttributes)r.bufferIndex=o,r.bufferDefinition=i[o];else if("draco"===i[o].compressedAttributes.encoding&&!n("disable-feature:i3s-draco"))return r.bufferIndex=o,r.bufferDefinition=i[o],r;return r}(this.geometryDefinitions,e),h=c.bufferDefinition,p=c.bufferIndex,f=e.resources.geometry?i.result(this.loadGeometry(e,p,t)):null,e.resources.hasSharedResource?[4,this.loadShared(e,t)]:[3,2];case 1:return y=r.sent(),[3,3];case 2:y=null,r.label=3;case 3:return g=y,m=this.materialAndTextures&&e.resources.materialDefinition>=0?this.materialAndTextures[e.resources.materialDefinition]:null!=g?u.getMaterialAndTexturesFromShared(g):null,_=m&&m.material,v=m&&m.textures,this.options.loadFeatureData?[4,this.loadFeatureData(e,t)]:[3,5];case 4:return x=r.sent(),[3,6];case 5:x=null,r.label=6;case 6:return b=x,w=this.options.loadFeatureData?function(e){for(var t=0,r=e.featureData;t<r.length;t++){var i=r[t],n=i.geometries;if(null!=n)for(var o=0,a=n;o<a.length;o++){var s=a[o];return{featureIds:[i.id],featureDataPosition:i.position,geometries:[s]}}}return null}(b):function(e){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:e}}],featureDataPosition:[0,0,0]}}(_),S=a.isNone(w)&&function(e){for(var t=new Array,r=0,i=e.featureData;r<i.length;r++){var n=i[r];null!=n.position&&t.push({featureIds:[n.id],featureDataPosition:n.position,geometries:null})}return t}(b),C=null!=v&&v.length>0?i.result(this.loadTextures(e,v,t)):null,M=null,I=null,f?(D=(N=i).assertResult,[4,f]):[3,8];case 7:M=D.apply(N,[r.sent()]),O=function(e,t){if(!e||!t||!t.materialDefinitions)return e;var r=Object.keys(t.materialDefinitions)[0];return!t.materialDefinitions[r].params.vertexRegions&&e.vertexAttributes.region&&delete(e=o.clone(e)).vertexAttributes.region,e}(this.defaultGeometrySchema,g),I=d.createGeometryDescriptor(h,O),r.label=8;case 8:return C?(E=(T=i).assertResult,[4,C]):[3,10];case 9:return A=E.apply(T,[r.sent()]),[3,11];case 10:A=null,r.label=11;case 11:return P=A,l?(L=(V=i).assertResult,[4,l]):[3,13];case 12:return R=L.apply(V,[r.sent()]),[3,14];case 13:R={},r.label=14;case 14:return j=(F=R)?{attributeData:F,loadedAttributes:this.requiredAttributes}:null,a.isSome(w)?[2,{geometryData:w,attributeDataInfo:j,geometryBuffer:M,geometryDescriptor:I,requiredTextures:v,textureData:P}]:a.isSome(S)?[2,{pointData:S,attributeDataInfo:j,geometryBuffer:M,geometryDescriptor:I,requiredTextures:v,textureData:P}]:[2,s.reject()]}}))}))},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var i=0,n=Object.keys(r);i<n.length;i++)for(var o=0,a=r[n[i]].images;o<a.length;o++){var s=a[o];Array.isArray(s.href)?s.hrefConcat=s.href.map((function(e){return l.makeAbsolute(e,t)})):s.hrefConcat=l.makeAbsolute(s.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var i=t[r];if(Array.isArray(i.encoding))for(var n=0;n<i.encoding.length;n++){var o;"data:"===(o=i.encoding[n]).substring(0,5)&&(i.encoding[n]=o.substring(5))}else"data:"===(o=i.encoding).substring(0,5)&&(i.encoding=o.substring(5))}},e.prototype.loadShared=function(t,r){var i=this.layerUrl+"/nodes/"+t.resources.geometry+"/shared";return this.load(i,"json",r).then((function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,i),t}))},e.prototype.loadTexture=function(e,t,r,i,n,o){return n===c.DDS_ENCODING_STRING?this.load(e,"binary",o).then((function(e){return{id:t,usage:r,data:e,encoding:n}})):this.load(e,"image",o).then((function(e){var o=e;if(i&&e.width*e.height>=4096){var a=Math.ceil(e.width/2),s=Math.ceil(e.height/2),l=document.createElement("canvas");l.width=a,l.height=s,l.getContext("2d").drawImage(e,0,0,a,s),o=l}return{id:t,usage:r,data:o,encoding:n}}))},e.prototype.loadTextures=function(t,r,i){var n=this,o=this.options.textureFormat===e.TextureFormat.Compressed,a=this.options.textureFormat===e.TextureFormat.Downsampled,l=this.options.textureUsageMask;return s.all(r.map((function(e){if(0==(e.usage&l))return null;var r=c.selectEncoding(e.encodings,o);if(null==r)return n.logger.error("No known encoding for texture found on node "+t.id),s.reject();var d=t.resources.texture||t.id,u=n.layerUrl+"/nodes/"+d+"/textures/"+r.name;return n.loadTexture(u,e.id,e.usage,a,r.encoding,i)})))},e.prototype.loadFeatureData=function(e,t){var r=this.layerUrl+"/nodes/"+e.id+"/features/0";return this.load(r,"json",t)},e.prototype.loadGeometry=function(e,t,r){var i=this.layerUrl+"/nodes/"+e.resources.geometry+"/geometries/"+t;return this.load(i,"binary",r)},e}();return function(e){!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(e.TextureFormat||(e.TextureFormat={}))}(h||(h={})),h}.apply(null,i))||(e.exports=n)},733:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(168),r(152),r(497),r(319)],void 0===(n=function(e,t,r,i,n,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getMaterialAndTextures=function(e,t){var r=new Map,o=function(e,t){if(i.isNone(e))return-1;if(r.has(e.id)){var n=r.get(e.id);return n.usage|=t,n.id}var o=r.size;return r.set(e.id,{id:o,usage:t}),o},s=t.pbrMetallicRoughness,l=s&&s.baseColorFactor,d=t.emissiveFactor,u=null==t.normalTexture&&null==t.emissiveTexture&&null==t.occlusionTexture&&(!s||null==s.metallicRoughnessTexture&&1===s.roughnessFactor&&(1===s.metallicFactor||0===s.metallicFactor)),c=u?n.PBRSchematicMRRValues[0]:s?s.metallicFactor:1,h=u?n.PBRSchematicMRRValues[1]:s?s.roughnessFactor:1,p="mask"===t.alphaMode?33:1,f={baseColorFactor:l?[l[0],l[1],l[2],l[3]]:[1,1,1,1],baseColorTextureId:o(s&&s.baseColorTexture,p),metallicRoughnessTextureId:o(s&&s.metallicRoughnessTexture,2),metallicFactor:c,roughnessFactor:h},g={alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,cullFace:"none"===t.cullFace?0:"back"===t.cullFace?2:"front"===t.cullFace?1:void 0,normalTextureId:o(t.normalTexture,4),emissiveTextureId:o(t.emissiveTexture,16),occlusionTextureId:o(t.occlusionTexture,8),emissiveFactor:d?[d[0],d[1],d[2]]:[0,0,0],metallicRoughness:f,wrapTextures:!1,isSchematic:u},y=[];return r.forEach((function(t,r){var n=t.usage,o=i.isSome(e)&&e[r]&&e[r].formats,s=o?o.map((function(e){var t=e.name,r=e.format;return{name:t,encoding:a[r]}})):[];y.push({id:r,usage:n,encodings:s})})),{material:g,textures:y}};var a={jpg:"image/jpeg",png:"image/png",dds:"image/vnd-ms.dds","ktx-etc2":"image/ktx"};t.getMaterialAndTexturesFromShared=function(e){var t=e&&e.materialDefinitions?Object.keys(e.materialDefinitions)[0]:null,i=e&&e.textureDefinitions?Object.keys(e.textureDefinitions)[0]:null,n=t&&e.materialDefinitions[t],o=i&&e.textureDefinitions[i],a=s();if(null!=n){var l=n.params;l.diffuse&&(a.metallicRoughness.baseColorFactor=[l.diffuse[0],l.diffuse[1],l.diffuse[2],1]),null!=l.doubleSided&&(a.doubleSided=l.doubleSided,a.cullFace=l.doubleSided?0:2),"none"!==l.cullFace&&"front"!==l.cullFace&&"back"!==l.cullFace||(a.cullFace="none"===l.cullFace?0:"back"===l.cullFace?2:1),l.transparency&&(a.metallicRoughness.baseColorFactor[3]=r.clamp(1-l.transparency,0,1)),(l.useVertexColorAlpha||a.metallicRoughness.baseColorFactor[3]<1)&&(a.alphaMode="blend")}var d=[];if(null!=o){!o.wrap||"repeat"!==o.wrap[0]&&"repeat"!==o.wrap[1]||(a.wrapTextures=!0);var u=1;"rgba"===o.channels&&(a.alphaMode="blend",u|=32);var c=o.images.length-1,h=o.images[c],p=function(e){return e&&e.split("/").pop()},f=Array.isArray(o.encoding)?o.encoding.map((function(e,t){return{name:p(h.href[t]),encoding:e}})):[{name:p(h.href),encoding:o.encoding}];d.push({id:0,usage:u,encodings:f}),a.metallicRoughness.baseColorTextureId=0}return{material:a,textures:d}};var s=function(){return{alphaMode:"opaque",alphaCutoff:o.defaultMaskAlphaCutoff,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,isSchematic:!0}}}.apply(null,i))||(e.exports=n)},734:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(153)],void 0===(n=function(e,t,r,i){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this.requester=e,this.activeRequests=new Set}return Object.defineProperty(e.prototype,"busy",{get:function(){return this.requester.busy},enumerable:!0,configurable:!0}),e.prototype.request=function(e,t,n){var o=this,a=i.createAbortController();i.onAbortOrThrow(n,(function(){return a.abort()})),n=r.__assign(r.__assign({},n),{signal:a.signal});var s=this.requester.request(e,t,n),l={response:s,abortController:a};return this.activeRequests.add(l),i.always(s,(function(){return o.activeRequests.delete(l)})),s},e.prototype.cancelAll=function(){this.activeRequests.forEach((function(e){return e.abortController.abort()})),this.activeRequests.clear()},e}();t.I3SStreamDataController=n,t.default=n}.apply(null,i))||(e.exports=n)},735:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(152),r(162),r(160),r(245),r(207),r(277),r(346),r(448),r(250),r(203),r(289),r(192)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d,u,c,h,p){return function(){function e(e,t,r,i,o,s,l){void 0===l&&(l={}),this.indexSR=e,this._renderCoordsHelper=t,this.extent=i,this.elevationProvider=o,this.options=l,this.fp=c.frustum.create(),this._poi=n.vec3f64.create(),this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmp1=n.vec3f64.create(),this._tmp2=n.vec3f64.create(),this._tmp3=n.vec3f64.create(),this._tmp0=n.vec3f64.create(),this.screenspaceErrorBias=l.screenspaceErrorBias||1,this.progressiveLoadFactor=l.progressiveLoadFactor||1,this.updateCamera(r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(s),this.tmpPoint=a.makeDehydratedPoint(0,0,0,e)}return e.prototype.updateElevationInfo=function(e){null!=e?(this._elevationContext=l.ElevationContext.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext(d.createContextWithoutExpressionSupport(d.extractExpressionInfo(e,!1)))):this._elevationContext=null},e.prototype.updateCamera=function(e){c.frustum.fromMatrix(e.viewMatrix,e.projectionMatrix,this.fp),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0},e.prototype.setPointOfInterest=function(e){i.vec3.copy(this._poi,e)},e.prototype.updateScreenSpaceErrorBias=function(e){var t=this.screenspaceErrorBias;return this.screenspaceErrorBias=e,t},e.prototype.updateExtent=function(e){this.extent=e},e.prototype.getRenderMbs=function(e){var t=e.renderMbs;return t[3]<0&&(o.vec4.copy(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this.tmpPoint.x=t[0],this.tmpPoint.y=t[1],this.tmpPoint.z=t[2],t[2]=s.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)),p.mbsToMbs(t,this.indexSR,t,this.engineSR)),t},e.prototype.getRenderObb=function(e){var t=e.authorativeObb||e.obb;if(!(r.isNone(t)||t.halfSize[0]<0)){r.isNone(e.renderObb)&&(e.renderObb=h.create());var i=e.renderObb;if(i.halfSize[0]<0){if(r.isSome(e.authorativeObb))return h.set(e.authorativeObb,i),e.authorativeObb;var n=0;this._elevationContext&&e.mbs[3]<1e5&&(this.tmpPoint.x=t.center[0],this.tmpPoint.y=t.center[1],this.tmpPoint.z=t.center[2],n=s.evaluateElevationAlignmentAtPoint(this.tmpPoint,this.elevationProvider,this._elevationContext,this._renderCoordsHelper)-t.center[2]),u.transformObb(t,this.indexSR,i,this.engineSR,n,e.isComputedObb)}return i}},e.prototype.isNodeVisible=function(e){var t=this.getRenderMbs(e);if(!this.isMBSinExtent(t))return!1;var i=this.getRenderObb(e);return r.isSome(i)?h.isVisible(i,this.fp):this.isMBSVisible(t)},e.prototype.isGeometryVisible=function(e){var t=this.getRenderObb(e);return!r.isSome(t)||h.isVisible(t,this.fp)},e.prototype.isMBSinExtent=function(e){return!this.extent||0!==u.intersectBoundingBoxWithMbs(this.extent,e)},e.prototype.isMBSVisible=function(e){return c.frustum.intersectsSphere(this.fp.planes,c.sphere.wrap(e[3],e))},e.prototype.screenSpaceDiameterMbs=function(e,t){var r=this.getRenderMbs(e),n=Math.sqrt(i.vec3.squaredDistance(r,this._camPos)),o=n-r[3];return this._updateMinMaxDistance(n),o<0?.5*Number.MAX_VALUE:t/o*this._screenSizeFactor},e.prototype.calcCameraDistance=function(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]},e.prototype.calcCameraDistanceToCenter=function(e){var t=this.getRenderMbs(e),r=i.vec3.distance(t,this._camPos);return this._updateMinMaxDistance(r),r},e.prototype.calcAngleDependentLoD=function(e){var t=this.getRenderMbs(e),r=t[3],n=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/i.vec3.length(t)+r)/i.vec3.distance(t,this._camPos);return Math.min(1,n)},e.prototype.hasLOD=function(e){return 0!==e.lodMetric},e.prototype.getDistancePlanarMode=function(e,t){var r=e[0]-t[0],i=e[1]-t[1],n=e[2]-t[2],o=r*r+i*i,a=t[3];if(o<=a*a)return Math.abs(n);var s=Math.sqrt(o)-a;return Math.sqrt(n*n+s*s)},e.prototype.getDistanceGlobeMode=function(e,t){var r=i.vec3.length(t),n=i.vec3.length(e)-r;i.vec3.scale(this._tmp0,e,i.vec3.dot(e,t)/i.vec3.squaredLength(e));var o=i.vec3.squaredDistance(t,this._tmp0),a=t[3];if(o<=a*a)return Math.abs(n);var s=i.vec3.scale(this._tmp0,t,1/r),l=r,d=a*a/2/l,u=i.vec3.scale(this._tmp1,s,l-d),c=e,h=i.vec3.subtract(this._tmp2,c,u),p=i.vec3.subtract(this._tmp2,h,i.vec3.scale(this._tmp3,s,i.vec3.dot(s,h))),f=i.vec3.add(this._tmp2,u,i.vec3.scale(this._tmp2,p,a/i.vec3.length(p))),g=i.vec3.distance(c,f);if(n>=2e5){var y=i.vec3.subtract(this._tmp1,c,f),m=i.vec3.dot(y,s)/i.vec3.length(y);m<.08&&(m=1e-4),g/=m}return g},e.prototype.getDistance=function(e,t){return this.engineSR===p.SphericalECEFSpatialReference?this.getDistanceGlobeMode(e,t):this.getDistancePlanarMode(e,t)},e.prototype._updateMinMaxDistance=function(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))},e.prototype.getLodLevel=function(e){if(0===e.lodMetric||!e.resources.hasFeatureData)return 0;if(0===e.childCount)return this.maxLodLevel;if(this.progressiveLoadFactor<1){var t=this.progressiveLoadFactor*this.screenspaceErrorBias,r=this.screenspaceErrorBias;return this.evaluateLODmetric(e,t)?this.evaluateLODmetric(e,r)?2:1:0}return this.evaluateLODmetric(e,this.screenspaceErrorBias)?this.maxLodLevel:0},e.prototype.evaluateLODmetric=function(e,t){switch(e.lodMetric){case 2:var r=this.getRenderMbs(e),i=this.getDistance(this._camPos,r),n=2*i/this._screenSizeFactor,o=i+r[3];return this._updateMinMaxDistance(o),e.maxError*t<=n;case 1:var a=this.screenSpaceDiameterMbs(e,e.mbs[3]*t);return this.options.angleDependentLoD&&(a*=this.calcAngleDependentLoD(e)),a<e.maxError;case 3:return this.screenSpaceDiameterMbs(e,e.maxError)*t<10;case 4:return this.calcCameraDistance(e)>e.maxError*t}return!1},e.prototype.distToPOI=function(e){var t=this.getRenderMbs(e);return i.vec3.distance(t,this._poi)-t[3]},e.prototype.distCameraToPOI=function(){return i.vec3.distance(this._camPos,this._poi)},e}()}.apply(null,i))||(e.exports=n)},736:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(159),r(155),r(118),r(264),r(151),r(616),r(192)],void 0===(n=function(e,t,r,i,n,o,a,s,l,d){return function(e){function t(t){var r=e.call(this,t)||this;return r.geometry=null,r.type="clip",r}var n;return r.__extends(t,e),n=t,t.prototype.writeGeometry=function(e,t,r,n){if(n.layer&&n.layer.spatialReference&&!n.layer.spatialReference.equals(this.geometry.spatialReference)){if(!d.canProject(e.spatialReference,n.layer.spatialReference))return void(n&&n.messages&&n.messages.push(new a("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:n.layer.spatialReference,context:n})));var o=new i.Polygon({spatialReference:n.layer.spatialReference});d.polygonToPolygon(e,o),t[r]=o.toJSON(n)}else t[r]=e.toJSON(n);delete t[r].spatialReference},t.prototype.clone=function(){return new n({geometry:o.clone(this.geometry),type:this.type})},r.__decorate([s.property({type:i.Polygon}),l.persistable()],t.prototype,"geometry",void 0),r.__decorate([s.writer(["web-scene","portal-item"],"geometry")],t.prototype,"writeGeometry",null),r.__decorate([s.property({type:["clip","mask","replace"],nonNullable:!0}),l.persistable()],t.prototype,"type",void 0),n=r.__decorate([s.subclass("esri.layers.support.SceneModification")],t)}(n.JSONSupport)}.apply(null,i))||(e.exports=n)},737:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(190),r(210)],void 0===(n=function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._map=new Map,t}return r.__extends(t,e),t.prototype.clear=function(){if(this._map.size>0){var e=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:e})}},Object.defineProperty(t.prototype,"length",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),t.prototype.get=function(e){return this._map.get(e)},t.prototype.addMany=function(e){if(0!==e.length){for(var t=new Set,r=0;r<e.length;r++){var i=e[r],n=i.objectId,o=this._map.get(n);o?(t.add(n),i!==o&&(e[r]=o),++o.refCount):(i.refCount=1,this._map.set(n,i))}var a=t.size>0?e.filter((function(e){return!t.has(e.objectId)})):e;a.length>0&&this.emit("change",{added:a,removed:[]})}},t.prototype.removeMany=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r],o=n.objectId,a=this._map.get(o);null!=a&&--a.refCount<=0&&(this._map.delete(o),t.push(n))}t.length>0&&this.emit("change",{added:[],removed:t})},t.prototype.removeManyByObjectId=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r],o=this._map.get(n);null!=o&&--o.refCount<=0&&(this._map.delete(n),t.push(o))}t.length>0&&this.emit("change",{added:[],removed:t})},t.prototype.toArray=function(){return n.valuesOfMap(this._map)},t.prototype.find=function(e){var t;return n.someMap(this._map,(function(r){return!!e(r)&&(t=r,!0)})),t},t.prototype.forEach=function(e){this._map.forEach((function(t){return e(t)}))},t}(i);t.GraphicsMap=o}.apply(null,i))||(e.exports=n)},842:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r(117),r(182),r(174),r(169),r(164),r(156),r(210),r(168),r(152),r(153),r(231),r(120),r(200),r(157),r(151),r(272),r(413),r(189),r(185),r(162),r(160),r(245),r(193),r(727),r(191),r(492),r(736),r(247),r(246),r(431),r(581),r(1063),r(1065),r(262),r(1066),r(1067),r(613),r(1068),r(473),r(250),r(1069),r(472),r(453),r(261),r(289),r(192),r(371),r(961),r(1070),r(319),r(358),r(819),r(161)],void 0===(n=function(e,t,i,n,o,a,s,l,d,u,c,h,p,f,g,y,m,_,v,b,x,w,S,C,M,I,N,D,O,P,A,T,E,F,R,V,L,j,B,U,G,k,H,q,z,Q,W,K,Y,Z,X,J,$,ee){Object.defineProperty(t,"__esModule",{value:!0});var te=l.getLogger("esri.views.3d.layers.SceneLayerView3D"),re=[1,1,1,1],ie=function(e,t,r,i,n,o,a){this.node=e,this.featureIds=t,this.objectHandle=r,this.cachedRendererVersion=i,this.attributeInfo=n,this.material=o,this.textures=a,this.cachedEdgeMaterials=new Array,this.cachedSymbology=null};t.I3SMeshView3D=function(e){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._elevationProvider=null,t._intersectionHandler=null,t._nodeId2Meta=new Map,t._addTasks=new Map,t._rendererVersion=0,t._colorVariable=null,t._opacityVariable=null,t._rendererFields=null,t._symbologyFields=null,t._symbologyOverride=null,t._symbologyOverrideFields=null,t._symbolInfos=new Map,t._idbCache=new H.IDBCache("esri-scenelayer-cache","geometries"),t._labeler=null,t.holeFilling="auto",t._hasColors=!1,t._hasTextures=!1,t._hasData=!1,t.slicePlaneEnabled=!1,t._modifications=new Array,t._layerUrl="",t._cacheKeySuffix=null,t._arcade=null,t._tmpAttributeOnlyGraphic=new o(null,null,{}),t}return i.__extends(t,e),Object.defineProperty(t.prototype,"layerUid",{get:function(){return this.layer&&this.layer.uid},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sublayerUid",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updatingMeshView3D",{get:function(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||c.isSome(this._labeler)&&this._labeler.updating},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rendererTextureUsage",{get:function(){return k.rendererNeedsTextures(this._currentRenderer)?63:44},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=g.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=E.getMetersPerUnit(e.unit);return c.unwrapOr(e.offset,0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"useCompressedTextures",{get:function(){var e=this.layer.version,t=!s("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.renderView.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;if(this._worker=new R.I3SMeshWorkerHandle(this.view.resourceController.scheduler),this.addResolvingPromise(this._worker.promise),this._worker.setLegacySchema(this.layerUid,this.layer.store.defaultGeometrySchema),k.checkSceneLayerValid(this.layer),k.checkSceneLayerCompatibleWithView(this.layer,this.view),this._layerUrl=this.layer.parsedUrl.path,this._controller=new I({layerView:this}),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this._highlights=new L({collection:this._collection,forAllFeatures:function(t){return e._forAllFeatures(t,null,1)},forAllFeaturesOfNode:function(t,r){return e._forAllFeaturesOfNode(t,r)}}),this._isIntegratedMesh||!this.layer.store.defaultGeometrySchema)this._hasSymbolColors=!1;else{var t=this.layer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(t&&t.faceRange&&t.id)}this._hasVertexColors=null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView()),this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,(function(t){return e._deleteComponentObject(t)})),this._intersectionHandler=new U.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,forEach:function(t){return e._nodeId2Meta.forEach((function(e){return c.isSome(e)&&t(e.node,e.objectHandle)}))}}),this._elevationProvider=new j({layerView:this,intersectionHandler:this._intersectionHandler}),this.updatingHandles.add(this,"view.clippingArea",(function(){return e._clippingAreaChanged()}),2),this.updatingHandles.add(this,"fullOpacity",(function(t){return e._opacityChange(t)})),this.updatingHandles.add(this,"slicePlaneEnabled",(function(t){return e._slicePlaneEnabledChange(t)})),this.updatingHandles.add(this,"elevationOffset",(function(t,r){e._reloadAll(r),e._controller.recomputeAuthorativeOBBs()})),this.updatingHandles.add(this,"filter",(function(){return e._filterChange()}),2),this.updatingHandles.add(this,"view.qualitySettings.physicallyBasedRenderingEnabled",(function(){return e._updatePBR()}));var i=function(){e._reloadAll(),e._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",i),this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",i),this.updatingHandles.add(this,"suspended",(function(t){return e._suspendedChange(t)}),2),this.updatingHandles.add(this.layer,"labelsVisible",(function(){return e._labelingChanged()}),2),this.updatingHandles.add(this.layer,"labelingInfo",(function(){return e._labelingChanged()}),2),this.updatingHandles.add(this,"_modifications",(function(){return e._modificationsChanged()}),2),this.handles.add([y.init(Q,"I3S_TREE_SHOW_TILES",(function(t){if(t&&!e._treeDebugger){var i=e._controller.crsIndex;new Promise((function(e,t){r.e(27).then(function(){var t=[r(1088)];e.apply(null,t)}.bind(this)).catch(t.bind(this))})).then((function(t){var r=t.I3STreeDebugger;!e._treeDebugger&&Q.I3S_TREE_SHOW_TILES&&(e._treeDebugger=new r({lv:e,view:e.view,nodeSR:i}))}))}else t||!e._treeDebugger||Q.I3S_TREE_SHOW_TILES||(e._treeDebugger.destroy(),e._treeDebugger=null)})),y.init(Q,"I3S_SHOW_MODIFICATIONS",(function(){return e._showModifications()}))]),this._cacheKeySuffix=k.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch((function(e){return te.warn("Failed to initialize IndexedDB cache: "+e)})),this._componentColorManager=this._hasSymbolColors?new ee.BufferManager(this._stage.renderView.renderingContext):null},t.prototype.destroy=function(){this._clearAddTasks(),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);var e=this._worker;e&&(e.destroyContext(this.layer.uid).then((function(){return e.destroy()})),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache.destroy(),this._memCache=null,this._collection=null,this._stage=null,c.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},t.prototype.memEstimateTextureAdded=function(e){var t=e.estimatedTexMemRequired;return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},t.prototype.memEstimateTextureRemoved=function(e){var t=e.estimatedTexMemRequired;this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},t.prototype.memEstimateGeometryAdded=function(e){var t=this._collection.getObjectMemoryUsageGPU(e);return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},t.prototype.memEstimateGeometryRemoved=function(e){var t=this._collection.getObjectMemoryUsageGPU(e);this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},t.prototype.isNodeLoaded=function(e){return this._nodeId2Meta.has(e)},t.prototype.getUsedMemory=function(){var e=c.isSome(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach((function(t){return e+=c.isSome(t)?t.node.memory:0})),e},t.prototype.getUnloadedMemory=function(){return(this._controller?this._controller.unloadedMemoryEstimate:0)+(c.isSome(this._labeler)?this._labeler.unloadedMemoryEstimate:0)},t.prototype.ignoresMemoryFactor=function(){return!1},t.prototype._labelingChanged=function(){var e=this;if(D.areLabelsVisible(this.layer)&&this._supportsLabeling){if(!c.isSome(this._labeler)){var t=new F.default({view:this.view,layer:this.layer,collection:this._collection});this._nodeId2Meta.forEach((function(r){return c.isSome(r)&&e._addMetaToLabeler(t,r)})),this._labeler=t}}else c.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null)},t.prototype._modificationsChanged=function(){this._worker.setModifications(this.layer.uid,this._modifications,this.layer.spatialReference),this._reloadAll(),this._memCache.clear(),this._controller.recomputeAuthorativeOBBs(),this._showModifications()},t.prototype._showModifications=function(){if(c.isSome(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),Q.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;for(var r=0,n=this._modifications;r<n.length;r++){var a=n[r];a.geometry.spatialReference=this.layer.spatialReference;var s=i.__assign(i.__assign({},t),{color:e[a.type]});this._modificationGraphics.push(new o({geometry:a.geometry,symbol:s}))}this.view.graphics.addMany(this._modificationGraphics)}},t.prototype._addMetaToLabeler=function(e,t){var r=this;e.addNodeMeta(t,(function(e,t){return r._createAttributes(e,t)}))},t.prototype._suspendedChange=function(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))},t.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e);if(c.isSome(t)&&c.isSome(t.attributeInfo))return t.attributeInfo.loadedAttributes},t.prototype.getAttributeData=function(e){var t=this._nodeId2Meta.get(e);if(c.isSome(t)&&c.isSome(t.attributeInfo))return t.attributeInfo.attributeData},t.prototype.setAttributeData=function(e,t){var r=this,i=this._nodeId2Meta.get(e);c.isSome(i)&&(i.attributeInfo=t,i.cachedRendererVersion=this._getInvalidRendererVersion(),i.filteredIds=null,c.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(i,(function(e,t){return r._createAttributes(e,t)})),this._updateEngineObject(i))},t.prototype.getVisibleNodes=function(){var e=new Array;return this._nodeId2Meta.forEach((function(t){return c.isSome(t)&&e.push(t.node)})),e},t.prototype.getLoadedNodeIndices=function(e){this._nodeId2Meta.forEach((function(t,r){return e.push(r)}))},t.prototype._createTexture=function(e,t,r,i){if(c.isNone(r)||null==r.data)return null;var n,o=r.data,a=r.encoding,s=t.wrapTextures,l=1&r.usage?"opaque"===t.alphaMode?3:4:3,d=!0;if(a===k.DDS_ENCODING_STRING)n=$.DDS_ENCODING;else{var h=o;d=u.isPowerOfTwo(h.width)&&u.isPowerOfTwo(h.height)}var p=i,f=(p?this._enableAtlasMipMaps:this._enableMipMaps)&&d,g={mipmap:f,wrap:p||!s?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:p&&f&&this._disableAtlasAnisotropy,encoding:n,noUnpackFlip:!0,components:l},y=new $(o,e.id+"/"+r.id,g);return this._stage.add(4,y),e.memory+=this.memEstimateTextureAdded(y),y},t.prototype._getVertexBufferLayout=function(e,t){var r={hasTexture:de(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion};return Y.glLayout(Z.createVertexBufferLayout(this._getGeometryParameters(r)))},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._findGraphicNodeAndIndex=function(e){var t=q.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return d.someMap(this._nodeId2Meta,(function(e){if(c.isNone(e))return!1;var i=e.featureIds.indexOf(t);return-1!==i&&(r={node:e.node,index:i},!0)})),r},t.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.index);if(c.isNone(r))return[];for(var i=[],n=this._getObjectIdField(),o=0,a=t;o<a.length;o++){var s=a[o],l=q.attributeLookup(s.attributes,n),d=r.featureIds.indexOf(l);-1!==d&&i.push(d)}return i},t.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(!t)return h.reject();var r=this._nodeId2Meta.get(t.node.index);if(c.isNone(r))return h.reject();var i=r.objectHandle,n=B.boundingBoxCornerPoints(t.index,this._collection,i,new Float64Array(24)),o=this.view.renderSpatialReference,a=this.view.spatialReference;if(K.bufferToBuffer(n,o,0,n,a,0,8)){var s=M.empty();return M.expandWithBuffer(s,n,0,8),h.resolve({boundingBox:s,screenSpaceObjects:[]})}},t.prototype.whenGraphicAttributes=function(e,t){var r=this;return k.whenGraphicAttributes(this.layer,e,this._getObjectIdField(),t,(function(e){for(var t=new Map,i=[],n=0,o=e;n<o.length;n++){var a=o[n],s=r._findGraphicNodeAndIndex(a),l=t.get(s.node);l||(l={node:s.node,indices:[],graphics:[]},i.push(l)),l.indices.push(s.index),l.graphics.push(a)}return i}),{populateObjectId:!0})},t.prototype.getGraphicFromIntersectorMetadata=function(e){if(null==e.nodeIndex||null==e.componentIndex)return null;var t=this._nodeId2Meta.get(e.nodeIndex);return c.isNone(t)||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)},t.prototype._getCacheKey=function(e){return this._layerUrl+"/v15/"+e.id+this._cacheKeySuffix},t.prototype._getMemCacheKey=function(e,t){return void 0===t&&(t=this.elevationOffset),e+"#"+t},Object.defineProperty(t.prototype,"_idbCacheEnabled",{get:function(){return!this._controller.disableIDBCache&&0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix},enumerable:!0,configurable:!0}),t.prototype.loadCachedGPUData=function(e){return this._memCache.pop(this._getMemCacheKey(e.index))},t.prototype._cacheGPUData=function(e,t){void 0===t&&(t=this.elevationOffset);var r=this._controller.indexDepth-e.node.level+1;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,e.node.memory,r)},t.prototype.loadMissingTextures=function(e,t,r,i){var n=this,o=e.filter((function(e,r){if(0==(e.usage&n.rendererTextureUsage))return!1;if(c.isNone(t))return!0;var i=k.selectEncoding(e.encodings,n.useCompressedTextures),o=t[r];return!!(c.isNone(o)||null==o.data||i&&o.encoding!==i.encoding)}));return 0===o.length?h.resolve(!1):r(o,i).then((function(r){for(var i=0,n=0;n<e.length;n++)i<r.length&&r[i].id===e[n].id&&(t[n]=r[i],i++);return!0}))},t.prototype.loadCachedNodeData=function(e,t,r){var i=this;return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e),t).then((function(n){return null==n?null:n.nodeVersion!==e.version?(i._idbCache.remove(i._getCacheKey(e)),null):(e.obb||i._setComputedObb(e,n.nodeObb),i.loadMissingTextures(n.requiredTextures,n.textureData,r,t).then((function(r){return r&&i._idbCache.initialized&&c.isSome(n.textureData)&&(n.byteSize=ce(n.transformedGeometry,n.textureData),n.textureData.every(ue)&&he(e,n)&&i._idbCache.put(i._getCacheKey(e),n).catch((function(t){return te.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}))),h.throwIfAborted(t),n})))})):h.resolve(null)},t.prototype.addNodeData=function(e,t,r){var n=this;return function(e){return"geometryData"in e}(t)?this._addData(e,t.attributeDataInfo,(function(){return n._transformNode(e,t,r).then((function(o){return n._controller.reschedule(r,(function(){if(c.isNone(o))return n._addCachedNodeData(e,null,r);var a=o.obb,s=o.componentOffsets,l=o.featureIds,d=o.transformedGeometry,u=W.create([a.center.x,a.center.y,a.center.z],[a.extents.x,a.extents.y,a.extents.z],[a.orientation.x,a.orientation.y,a.orientation.z,a.orientation.w]),h=n._controller.crsIndex,p=n.view.renderSpatialReference,f=G.computeGlobalTransformation(e.mbs,n.elevationOffset,h,p);w.vec3.transformMat4(u.center,u.center,f),K.bufferToBuffer(u.center,p,0,u.center,h,0,1),u.center[2]-=n.elevationOffset;var g=e.obb;c.isNone(g)&&(g=n._setComputedObb(e,u)),t.geometryData.componentOffsets=s,l&&(t.geometryData.featureIds=Array.prototype.slice.call(l));var y={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:d,globalTrafo:f,nodeObb:g,byteSize:ce(d,t.textureData)};if(n._idbCacheEnabled&&n._idbCache.initialized&&he(e,y)){var m=c.isSome(y.textureData)?y.textureData.map((function(e){return ue(e)?e:null})):null;n._idbCache.put(n._getCacheKey(e),i.__assign(i.__assign({},y),{textureData:m})).catch((function(t){return te.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)}))}return n._addCachedNodeData(e,y,r)}))}))})):h.reject()},t.prototype.computeAuthorativeOBB=function(e){return k.computeAuthorativeOBB(e,this.view.renderSpatialReference,this._controller.crsIndex,this.layer.spatialReference,this.elevationOffset,this._modifications)},t.prototype._setComputedObb=function(e,t){return e.obb=W.clone(t),e.isComputedObb=!0,this._controller.updateBoundingVolume(e.index),e.obb},t.prototype._transformNode=function(e,t,r){for(var i=t.geometryData.geometries,n=new Array(i.length),o=0;o<i.length;++o)n[o]=this._getVertexBufferLayout(i[o],t.geometryDescriptor);var a=e.mbs,s=this.elevationOffset,l=this._controller.crsIndex,d=this._controller.crsVertex,u=this.view.renderSpatialReference,h=G.getLocalOrigin(a,s,l),p=G.computeGlobalTransformation(a,s,l,u),f=K.getProjectorName(l,d),g=K.getProjectorName(d,u);if(c.isNone(f)||c.isNone(g))return null;var y={context:this.layer.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:n,localOrigin:h,globalTrafo:p,mbs:a,obb:e.obb,elevationOffset:this.elevationOffset,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexToVertexProjector:f,vertexToRenderProjector:g};return this._worker.invoke(y,r)},t.prototype.addCachedGPUData=function(e,t,r){this._controller.isGeometryVisible(e)?(c.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,t),this._addNodeMeta(e.index,t),this.updateNodeState(e.index,r),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._updateEngineObject(t),this._highlights.objectCreated(t),this._treeDebugger&&this._treeDebugger.update()):this._cacheGPUData(t)},t.prototype.addCachedNodeData=function(e,t,r,i){var n=this;return this._addData(e,r,(function(){return n._addCachedNodeData(e,t,i)}))},t.prototype._addCachedNodeData=function(e,t,r){var i=this;if(this.suspended||!this._controller.isGeometryVisible(e))return h.resolve();if(c.isNone(t))return this._addNodeMeta(e.index,null),h.resolve();var n=t.geometryData,o=t.transformedGeometry,a=t.globalTrafo,s=c.isSome(t.textureData)?t.textureData.filter((function(e){return c.isSome(e)&&0!=(e.usage&i.rendererTextureUsage)})):null;e.memory=0;var l=n.componentOffsets,d=n.geometries,u=n.featureIds,p=null,f=null;if(this._hasSymbolColors){p=this._componentColorManager.getBuffer(u.length),f=new Uint16Array(u.length);for(var g=0;g<u.length;g++)f[g]=p.acquireIndex()}var y=this._collection,m=d[0],w=o.layout,C=o.indices,M=o.interleavedVertexData,I=o.positionData,N=o.hasColors,D=this._materialParameters(m,w),O=l||new Uint32Array([0,C?C.length:M.byteLength/w[0].stride]),P={vertices:{data:M,count:M.byteLength/w[0].stride,layoutParameters:D.geometryParams},positionData:{positions:I.data,indices:I.indices},indices:C,primitiveType:4,componentOffsets:O},A=m.transformation?x.mat4f64.clone(m.transformation):x.mat4f64.create();b.mat4.multiply(A,a,A);var T=b.mat4.getTranslation(S.vec3f64.create(),A),E=_.mat3.fromMat4(v.mat3f32.create(),A),F=this.view.renderSpatialReference,R=this.view.basemapTerrain.spatialReference,V=S.vec3f64.create(),L=[1,1,1];K.localLinearScaleFactors(T,F,L,R),K.vectorToVector(T,F,V,R);var j=y.createObject({toMapSpace:[V[0],V[1],L[0],L[1]],geometry:P,obb:c.unwrap(e.renderObb),transform:{position:T,rotationScale:E},visible:!1}),B={isSchematic:m.params.material.isSchematic,isOpaque:"blend"!==m.params.material.alphaMode&&m.params.material.metallicRoughness.baseColorFactor[3]>=1},U=c.isSome(s)?s.map((function(t){return i._createTexture(e,D.material,t,2===D.geometryParams.textureCoordinates)})):[];this._configureMaterial(j,m.params.material,U,s),e.memory+=this.memEstimateGeometryAdded(j);var G=this._addTasks.get(e.index),k=new ie(e,u,j,this._getInvalidRendererVersion(),G.attributeInfo,B,U);G.meta=k,!this._hasTextures&&t.requiredTextures.some((function(e){return 0!=(19&e.usage)}))&&(this._hasTextures=!0),this._hasData=!0,this._hasColors=this._hasColors||N,this._hasTextures=this._hasTextures||!!e.resources.texture,this.notifyChange("hasTexturesOrVertexColors");var H=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(k).then((function(t){return t&&i._edgeView.updateObjectVisibility(k.objectHandle,!1),i._controller.reschedule(r,(function(){var r=i._addTasks.get(e.index);if(r)if(c.isSome(i._labeler)&&i._addMetaToLabeler(i._labeler,k),i._addNodeMeta(e.index,k),i.suspended)i._removeNodeStageData(e.index,i.elevationOffset);else{y.setObjectVisibility(j,!0),t&&i._edgeView.updateObjectVisibility(k.objectHandle,!0),k.attributeInfo=r.attributeInfo;var n=k.cachedRendererVersion!==i._rendererVersion,o=H!==i.slicePlaneEnabled;i._setObjectSymbolColors(k);var a=i._applyFiltersToNode(k);(n||t&&(o||a))&&i._addOrUpdateEdgeRendering(k),i.visibleGeometryChanged(k),i._highlights.objectCreated(k),i._updateMaterial(k),i._treeDebugger&&i._treeDebugger.update()}}))})).catch((function(e){throw c.isSome(G.meta)&&i._deleteComponentObject(G.meta),e}))},t.prototype._addNodeMeta=function(e,t){if(this._nodeId2Meta.has(e)){te.error("Removing duplicated node");var r=this._nodeId2Meta.get(e);c.isSome(r)&&this._deleteComponentObject(r)}this._nodeId2Meta.set(e,t)},t.prototype._materialParameters=function(e,t){var r=e.params.material,i=t.some((function(e){return"uvRegion"===e.name})),n=t.some((function(e){return"normalCompressed"===e.name})),o=de(r);return{geometryParams:this._getGeometryParameters({hasTexture:o,hasNormals:n,hasRegions:i}),material:r}},t.prototype._configureMaterial=function(e,t,r,i){var n=this,o=this.rendererTextureUsage,a=function(e){return function(e,t,r){if(c.isNone(e)||0===r)return null;for(var i=0;i<e.length;i++){var n=e[i];if(c.isSome(n)&&0!=(n.usage&r))return t[i].id}return null}(i,r,e&o)};this._collection.updateMaterial(e,(function(e){var r=t.metallicRoughness.baseColorFactor,i=u.clamp(t.metallicRoughness.baseColorFactor[3],0,1);e.baseColor=[r[0],r[1],r[2],i],e.objectOpacity=n.fullOpacity,e.mrrFactors=[t.metallicRoughness.metallicFactor,t.metallicRoughness.roughnessFactor,t.isSchematic?.2:.5],e.emissiveFactor=t.emissiveFactor,e.usePBR=n._usePBR(t.isSchematic),e.isIntegratedMesh=n._isIntegratedMesh,e.alphaCutoff="mask"===t.alphaMode?t.alphaCutoff:J.defaultMaskAlphaCutoff,e.alphaDiscardMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:3;var o=n._stage.renderView.textureRepository,s=a(33);s&&(e.baseColorTexture=new X.RenderTexture(o,s));var l=a(2);l&&(e.metallicRoughnessTexture=new X.RenderTexture(o,l));var d=a(16);d&&(e.emissionTexture=new X.RenderTexture(o,d));var c=a(8);c&&(e.occlusionTexture=new X.RenderTexture(o,c));var h=a(4);h&&(e.normalTexture=new X.RenderTexture(o,h)),e.commonMaterialParameters.slicePlaneEnabled=n.slicePlaneEnabled,e.commonMaterialParameters.doubleSided=t.doubleSided,e.commonMaterialParameters.cullFace=t.cullFace,n._updateMaterialOverlay(e)}))},t.prototype._getGeometryParameters=function(e){return{textureCoordinates:e.hasTexture?e.hasRegions?2:1:0,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}},t.prototype._addData=function(e,t,r){var n=this,o=this._addTasks.get(e.index);return o?o.attributeInfo=t:(o=i.__assign(i.__assign({},h.createResolver()),{attributeInfo:t,meta:null}),this._addTasks.set(e.index,o),r().then(o.resolve,o.reject).then((function(){return n._addTasks.delete(e.index)})).catch((function(t){throw n._addTasks.delete(e.index),t}))),o.promise},t.prototype._clearAddTasks=function(){var e=this;this._addTasks.forEach((function(t){c.isSome(t.meta)&&e._deleteComponentObject(t.meta)})),this._addTasks.clear()},t.prototype._clippingAreaChanged=function(){var e=M.create();K.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?this._clippingArea=e:this._clippingArea=null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},t.prototype._filterChange=function(){this._applyFilters(!1)},t.prototype._applyFilters=function(e){var t=this;this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach((function(e){c.isSome(e)&&t._applyFiltersToNode(e)&&(t._addOrUpdateEdgeRendering(e),t.visibleGeometryChanged(e))}))},t.prototype.getFilters=function(){var e=this,t=[];return this._clippingArea&&t.push((function(t,r){return e._boundingboxFilter(t,r,e._clippingArea)})),t},t.prototype.addSqlFilter=function(e,t,r,i){var n=this;t&&r&&e.push((function(e,o){return n._sqlFilter(e,o,t,r,i)}))},t.prototype._sqlFilter=function(e,t,r,i,n){var o={},a=this._createLayerGraphic(o),s=this.layer.objectIdField,l=t.featureIds,d=c.isSome(t.attributeInfo)&&t.attributeInfo.attributeData;i.every((function(e){return null!=d[e]||e===s}))&&k.filterInPlace(e,l,(function(e){o[s]=l[e];for(var t=0,u=i;t<u.length;t++){var c=u[t];c!==s&&(o[c]=k.getCachedAttributeValue(d[c],e))}try{if(Array.isArray(r)){for(var h=0,p=r;h<p.length;h++)if(p[h].testFeature(a))return!0;return!1}return r.testFeature(a)}catch(e){return n(e),!1}}))},t.prototype._boundingboxNodeTest=function(e,t){return K.mbsToMbs(e.node.mbs,this._controller.crsIndex,le,this.view.renderSpatialReference),k.intersectBoundingBoxWithMbs(t,le)},t.prototype._boundingboxFeatureTest=function(e,t,r){return M.intersects(r,this._collection.getComponentAABB(e.objectHandle,t,ne))},t.prototype._boundingboxFilter=function(e,t,r){var i=this,n=this._collection,o=this._boundingboxNodeTest(t,r);if(3!==o)if(0!==o){var a=n.getComponentCount(t.objectHandle);if(a.invisible+a.visible===t.featureIds.length){var s=this._transformAABB(oe,r,t.objectHandle);k.filterInPlace(e,t.featureIds,(function(e){return i._boundingboxFeatureTest(t,e,s)}))}}else e.length=0},t.prototype._transformAABB=function(e,t,r){var i=this._collection.getObjectTransform(r),n=i.position,o=i.rotationScale;return e[0]=(t[0]-n[0])/o[0],e[1]=(t[1]-n[1])/o[4],e[2]=(t[2]-n[2])/o[8],e[3]=(t[3]-n[0])/o[0],e[4]=(t[4]-n[1])/o[4],e[5]=(t[5]-n[2])/o[8],e},t.prototype._addOrUpdateEdgeRendering=function(e,t){if(void 0===t&&(t=!0),!this._edgeView)return h.resolve(!1);var r=e.objectHandle,i=this._edgeView.hasObject(r),n=this._getFilteredEdgeMaterials(e),o=n.hasEdges,a=n.perFeatureEdgeMaterials,s={slicePlaneEnabled:this.slicePlaneEnabled};return o?i?(this._edgeView.updateAllComponentMaterials(r,a,s,t),this._edgeView.updateObjectVisibility(r,!0),h.resolve(!0)):this._collection.addEdges(r,this._edgeView,a,s).then((function(){return!0})):(i&&this._edgeView.removeObject(r),h.resolve(!1))},t.prototype._removeEdgeRendering=function(e){this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._edgeView.removeObject(e.objectHandle)},t.prototype._applyFiltersToNode=function(e){return!!this._applyFiltersToNodeComponents(e)&&(c.isSome(this._labeler)&&this._labeler.applyFilterChange(e),!0)},t.prototype._applyFiltersToNodeComponents=function(e){var t=this._collection,r=0===t.getComponentCount(e.objectHandle).invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!r;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!r;var i=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,i),!0},t.prototype._updateCachedFilteredIds=function(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)},t.prototype._computeFilteredIds=function(e){for(var t=e.featureIds.slice(),r=0,i=this._filters;r<i.length&&((0,i[r])(t,e),0!==t.length);r++);return t.length===e.featureIds.length?e.featureIds:t},t.prototype._computeFilteredComponentIndices=function(e){var t=new Array;return e.featureIds.forEach((function(r,i){e.filteredIds[t.length]===r&&t.push(i)})),t},t.prototype._removeAllNodeDataFromStage=function(e){var t=this;void 0===e&&(e=this.elevationOffset),this._nodeId2Meta.forEach((function(r,i){return t._removeNodeStageData(i,e)}))},t.prototype.removeNodeData=function(e,t){for(var r=this.elevationOffset;e.length>0&&!t.done;){var i=e.pop();this._removeNodeStageData(i,r),t.madeProgress()}},t.prototype._removeNodeStageData=function(e,t){var r=this._nodeId2Meta.get(e);c.isNone(r)?this._nodeId2Meta.delete(e):(this._collection.setObjectVisibility(r.objectHandle,!1),this.visibleGeometryChanged(r),this._removeEdgeRendering(r),c.isSome(this._labeler)&&this._labeler.removeNodeMeta(r),this._nodeId2Meta.delete(e),this._highlights.objectDeleted(r),this._cacheGPUData(r,t),this._treeDebugger&&this._treeDebugger.update())},t.prototype._deleteComponentObject=function(e){if(this._edgeView&&this._edgeView.removeObject(e.objectHandle),this.memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(var t=0,r=e.textures;t<r.length;t++){var i=r[t];this.memEstimateTextureRemoved(i),this._stage.remove(4,i.id)}},t.prototype.updateNodeState=function(e,t){var r=this._nodeId2Meta.get(e);c.isSome(r)&&this._collection.updateMaterial(r.objectHandle,(function(e){return e.polygonOffsetEnabled=0===t}))},t.prototype._invalidateAllSymbols=function(){this._rendererVersion=k.addWraparound(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()},t.prototype._getInvalidRendererVersion=function(){return k.addWraparound(this._rendererVersion,-1)},t.prototype._rendererChange=function(e){return i.__awaiter(this,void 0,void 0,(function(){var t,r,n,o,a,s,l,d,u,c;return i.__generator(this,(function(i){switch(i.label){case 0:return this._currentRenderer=e,this.notifyChange("rendererTextureUsage"),this._rendererVersion=k.addWraparound(this._rendererVersion,1),this._rendererFields=null,this._colorVariable=null,this._opacityVariable=null,this._invalidateAllSymbols(),e?(t=this,r=N.fixFields,n=[this.layer.fields],[4,e.getRequiredFields(this.layer.fields)]):[3,2];case 1:t._rendererFields=r.apply(void 0,n.concat([i.sent()])),i.label=2;case 2:return this._updateSymbologyFields(),!this._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired?(o=this,[4,A.loadArcade()]):[3,4];case 3:o._arcade=i.sent(),i.label=4;case 4:if(e&&"visualVariables"in e&&e.visualVariables)for(a=0,s=e.visualVariables;a<s.length;a++)"color"===(l=s[a]).type?this._colorVariable=l:"opacity"===l.type?this._opacityVariable=l:te.warn("Unsupported visual variable type for 3D Object Scene Services: "+l.type);if(e)for(d=0,u=e.getSymbols();d<u.length;d++)"mesh-3d"!==(c=u[d]).type&&te.error("Symbols of type '"+c.type+"' are not supported for 3D Object Scene Services.");return this._controller&&this._controller.requestUpdate(),[2]}}))}))},t.prototype._getCachedEdgeMaterials=function(e){return this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials},t.prototype._getSymbolColors=function(e){this._hasSymbolColors&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);var t=e.cachedSymbology;return function(e,r){var i=5*e;C.vec4.set(r.externalColor,t[i+0]/255,t[i+1]/255,t[i+2]/255,t[i+3]/255),r.externalColorMixMode=15&t[i+4],r.castShadows=0!=(16&t[i+4]),r.pickable=0!=(32&t[i+4])}},t.prototype._getSymbolInfo=function(e,t){var r=e&&e.getSymbol(t,{arcade:this._arcade});if(!(r instanceof T))return null;var i=r.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);var n=k.getSymbolInfo(r);return this._symbolInfos.set(i,n),n},t.prototype._setSymbologyOverride=function(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())},t.prototype._updateSymbologyFields=function(){this._symbologyFields=c.isSome(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?c.isSome(this._rendererFields)&&this._rendererFields.length>0?N.fixFields(this.layer.fields,i.__spreadArrays(this._rendererFields,this._symbologyOverrideFields)):this._symbologyOverrideFields:this._rendererFields},t.prototype._updateCachedRendererData=function(e){if(e.cachedRendererVersion=this._rendererVersion,this._hasSymbolColors){var t=this._tmpAttributeOnlyGraphic,r={};t.attributes=r;var n=this._currentRenderer,o=c.isSome(e.attributeInfo)&&e.attributeInfo.attributeData,a=null!=e.featureIds?this.layer.objectIdField:null,s=null!=o&&c.isSome(this._symbologyFields)&&this._symbologyFields.length>0,l=s?[]:null,d=s?[]:null;if(s&&c.isSome(this._symbologyFields))for(var u=0,h=this._symbologyFields;u<h.length;u++){var p=h[u],f=o[p];f&&(l.push(p),d.push(f))}e.cachedSymbology||(e.cachedSymbology=new Uint8Array(5*e.featureIds.length));for(var g={color:ae,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},y=this.fullOpacity,m=null,_=2,v=k.transparentEdgeMaterial,b=0,x=0;x<e.featureIds.length;x++){if(null!=a&&(r[a]=e.featureIds[x]),s)for(var w=0;w<l.length;w++)r[l[w]]=k.getCachedAttributeValue(d[w],x);var S=this._getSymbolInfo(n,t),C=null,M=null;if(n&&"visualVariables"in n){if(this._colorVariable){var I=P.getColor(this._colorVariable,t,{color:se,arcade:this._arcade});I&&((C=ae)[0]=I.r/255,C[1]=I.g/255,C[2]=I.b/255,this._opacityVariable||null===I.a||(M=I.a))}this._opacityVariable&&(M=P.getOpacity(this._opacityVariable,t,{arcade:this._arcade}))}if(S&&S.material){var N=S.material;C=c.isNone(C)||c.isNone(M)?V.overrideColor(C,M,N.color,N.alpha,re,ae):V.overrideColor(C,M,null,null,re,ae)}if(c.isNone(C)&&((C=ae)[0]=1,C[1]=1,C[2]=1,C[3]=1),g.pickable=!0,g.castShadows=!S||S.castShadows,g.colorMixMode=S&&S.material?S.material.colorMixMode:1,g.edgeMaterial=S?S.edgeMaterial:null,c.isSome(this._symbologyOverride)&&(g.color=C,this._symbologyOverride(t,g),C=g.color),c.isSome(g.edgeMaterial)){var D=C[3]<=0?0:C[3]>=1&&(e.material.isOpaque||3===g.colorMixMode)?2:1;g.edgeMaterial===m&&D===_||(v=i.__assign(i.__assign({},g.edgeMaterial),{opacity:y,objectTransparency:D}),m=g.edgeMaterial,_=D),e.cachedEdgeMaterials[x]=v}else e.cachedEdgeMaterials[x]=k.transparentEdgeMaterial;e.cachedSymbology[b+0]=Math.round(255*C[0]),e.cachedSymbology[b+1]=Math.round(255*C[1]),e.cachedSymbology[b+2]=Math.round(255*C[2]),e.cachedSymbology[b+3]=Math.round(255*C[3]),e.cachedSymbology[b+4]=g.colorMixMode|+g.castShadows<<4|+g.pickable<<5,b+=5}}},t.prototype._getFilteredEdgeMaterials=function(e){var t=this,r=this._getCachedEdgeMaterials(e);if(r.forEach((function(e){return e.opacity=t.fullOpacity})),c.isNone(e.filteredIds))return{hasEdges:r.some((function(e){return e!==k.transparentEdgeMaterial})),perFeatureEdgeMaterials:r};var i=0,n=!1,o=r.map((function(t,r){return e.featureIds[r]!==e.filteredIds[i]?k.transparentEdgeMaterial:(n=n||t!==k.transparentEdgeMaterial,i++,t)}));return{hasEdges:n,perFeatureEdgeMaterials:o}},t.prototype._setObjectSymbolColors=function(e){if(this._hasSymbolColors){var t=e.objectHandle,r=this._getSymbolColors(e);this._collection.setComponentData(t,r),this._stage.renderView.setNeedsRender()}},t.prototype._reloadAll=function(e){void 0===e&&(e=this.elevationOffset),this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()},t.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach((function(r){c.isNone(r)||(t._collection.updateMaterial(r.objectHandle,(function(t){return t.objectOpacity=e})),t._updateEdgeRendering(r))}))},t.prototype._updateMaterial=function(e){var t=this;this._collection.updateMaterial(e.objectHandle,(function(r){r.commonMaterialParameters.slicePlaneEnabled=t.slicePlaneEnabled,r.usePBR=t._usePBR(e.material.isSchematic),r.objectOpacity=t.fullOpacity,t._updateMaterialOverlay(r)}))},t.prototype._updateMaterialOverlay=function(e){},t.prototype._updateEngineObject=function(e){this._setObjectSymbolColors(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this.visibleGeometryChanged(e)},t.prototype._slicePlaneEnabledChange=function(e){var t=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=e),c.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach((function(r){c.isNone(r)||(t._collection.updateMaterial(r.objectHandle,(function(t){t.commonMaterialParameters.slicePlaneEnabled=e})),t._updateEdgeRendering(r,!1))}))},t.prototype._updatePBR=function(){var e=this;this._nodeId2Meta.forEach((function(t){c.isNone(t)||e._collection.updateMaterial(t.objectHandle,(function(r){r.usePBR=e._usePBR(t.material.isSchematic)}))}))},t.prototype._usePBR=function(e){return!this._isIntegratedMesh&&(!e||this.view.qualitySettings.physicallyBasedRenderingEnabled)},t.prototype._updateEdgeRendering=function(e,t){void 0===t&&(t=!0),this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)},t.prototype._forAllNodes=function(e){this._nodeId2Meta.forEach(e)},t.prototype._forAllFeatures=function(e,t,r){var i=this;void 0===r&&(r=0),d.someMap(this._nodeId2Meta,(function(n){if(c.isNone(n))return!1;if(c.isSome(t))switch(t(n)){case 0:return!0;case 2:return!1}var o=1;switch(r){case 1:o=i._forAllFeaturesOfNode(n,e);break;case 0:o=i._forVisibleFeaturesOfNode(n,e);break;case 2:o=i._forAllFeaturesOfNodeInClippingArea(n,e)}return 0===o}))},t.prototype._forAllFeaturesOfNode=function(e,t){for(var r=1,i=e.featureIds,n=0;n<i.length;n++)if(0===(r=t(i[n],n,e)))return r;return r},t.prototype._forVisibleFeaturesOfNode=function(e,t){var r=1,i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,(function(n){return 1===(r=t(i[n],n,e))})),r},t.prototype._forAllFeaturesOfNodeInClippingArea=function(e,t){if(null==this._clippingArea)return this._forAllFeaturesOfNode(e,t);var r=this._boundingboxNodeTest(e,this._clippingArea);if(0===r)return 1;if(3===r)return this._forAllFeaturesOfNode(e,t);for(var i=e.featureIds,n=e.objectHandle,o=k.getClipAABB(this._clippingArea,this._collection.getObjectTransform(n)),a=0;a<i.length;a++)if(this._boundingboxFeatureTest(e,a,o)){var s=t(i[a],a,e);if(0===s)return s}return 1},t.prototype._createAttributes=function(e,t){var r={};null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]);var i=c.isSome(t.attributeInfo)&&t.attributeInfo.attributeData;if(c.isSome(i))for(var n=0,o=Object.keys(i);n<o.length;n++){var a=o[n];r[a]=k.getCachedAttributeValue(i[a],e)}return r},t.prototype._createGraphic=function(e,t){return this._createLayerGraphic(this._createAttributes(e,t))},t.prototype.highlight=function(e){var t=this,r=this._highlights;if("number"==typeof e||e instanceof o?e=[e]:e instanceof a&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof o){var i=e.map((function(e){return q.attributeLookup(e.attributes,t._getObjectIdField())})),n=r.acquireSet(),s=n.set,l=n.handle;return r.setFeatureIds(s,i),l}if("number"==typeof e[0]){i=e;var d=r.acquireSet();return s=d.set,l=d.handle,r.setFeatureIds(s,i),l}}return pe},t.prototype.visibleGeometryChanged=function(e){var t=this;this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=p.schedule((function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))))},Object.defineProperty(t.prototype,"performanceInfo",{get:function(){var e={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};return this._controller&&(this._idbCacheEnabled&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){var e=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){var t=[];return e._forAllFeatures((function(e){return t.push(e),1}),null,0),t.sort((function(e,t){return e-t})),t},get numNodes(){return e._nodeId2Meta.size}}},enumerable:!0,configurable:!0}),i.__decorate([m.property()],t.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),i.__decorate([m.property()],t.prototype,"view",void 0),i.__decorate([m.property()],t.prototype,"layer",void 0),i.__decorate([m.property()],t.prototype,"_controller",void 0),i.__decorate([m.property()],t.prototype,"_labeler",void 0),i.__decorate([m.property({dependsOn:["updatingMeshView3D"]})],t.prototype,"updating",void 0),i.__decorate([m.property({dependsOn:["_controller.updating","_visibleGeometryChangedSchedulerHandle","_labeler.updating"]})],t.prototype,"updatingMeshView3D",null),i.__decorate([m.property({dependsOn:["_controller.rootNodeVisible"]})],t.prototype,"suspended",void 0),i.__decorate([m.property()],t.prototype,"holeFilling",void 0),i.__decorate([m.property(z.updatingProgress)],t.prototype,"updatingProgress",void 0),i.__decorate([m.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],t.prototype,"updatingProgressValue",void 0),i.__decorate([m.property({readOnly:!0})],t.prototype,"hasTexturesOrVertexColors",null),i.__decorate([m.property({readOnly:!0})],t.prototype,"rendererTextureUsage",null),i.__decorate([m.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],t.prototype,"elevationOffset",null),i.__decorate([m.property({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),i.__decorate([m.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],t.prototype,"uncompressedTextureDownsamplingEnabled",null),i.__decorate([m.property({dependsOn:["layer.version"]})],t.prototype,"useCompressedTextures",null),i.__decorate([m.property({type:[O]})],t.prototype,"_modifications",void 0),i.__decorate([m.subclass("esri.views.3d.layers.I3SMeshView3D")],t)}(e)};var ne=M.create(),oe=M.create(),ae=[0,0,0,0],se=new n([0,0,0,0]),le=[0,0,0,0];function de(e){var t=e.metallicRoughness;return t&&t.baseColorTextureId>=0||t&&t.metallicRoughnessTextureId>=0||e.normalTextureId>=0||e.emissiveTextureId>=0||e.occlusionTextureId>=0}function ue(e){return c.isSome(e)&&f.isArrayBuffer(e.data)}function ce(e,t){var r=1024+e.interleavedVertexData.byteLength+(e.indices?e.indices.byteLength:0)+e.positionData.data.byteLength+e.positionData.indices.byteLength;if(c.isSome(t))for(var i=0,n=t;i<n.length;i++){var o=n[i];c.isSome(o)&&f.isArrayBuffer(o.data)&&(r+=o.data.byteLength)}return r}function he(e,t){return t.byteSize>104857600?(te.warn("Node is too big to store in IndexedDB cache: "+e.id+" ("+t.byteSize+" bytes)"),!1):t.byteSize>0}var pe={remove:function(){},pause:function(){},resume:function(){}}}.apply(null,i))||(e.exports=n)}}]);
//# sourceMappingURL=18.js.map