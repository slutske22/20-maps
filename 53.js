(function(){var e={"esri/views/3d/layers/i3s/I3SUtil":250,"esri/views/layers/support/popupUtils":281,"esri/layers/support/PromiseQueue":383,"esri/views/3d/layers/i3s/I3SProjectionUtil":473,"esri/views/3d/layers/support/PopupSceneLayerView":739,"esri/views/3d/webgl-engine/shaders/PointRenderer.glsl":1351,"esri/views/3d/layers/PointCloudLayerView3D":2142,"esri/views/3d/layers/PointCloudWorkerHandle":2143,"esri/views/3d/layers/i3s/LoDUtil":2144,"esri/views/3d/layers/i3s/PagedNodeIndex":2145,"esri/views/3d/layers/i3s/PointCloudRendererUtil":2146,"esri/views/3d/layers/i3s/PointGraphic":2147,"esri/views/3d/layers/i3s/PointRenderer":2148,"esri/views/3d/layers/i3s/PointHighlights":2149,"esri/views/3d/webgl-engine/shaders/PointRendererTechnique":2150},t=this||window,r=t.webpackJsonp=t.webpackJsonp||[];r.registerAbsMids?r.registerAbsMids(e):(r.absMidsWaiting=r.absMidsWaiting||[]).push(e)})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{1351:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(117),r(223),r(345),r(494),r(175),r(252)],void 0===(i=function(e,t,r,n,i,o,a,s){var u,l,d,c,h,p,f,g,v;Object.defineProperty(t,"__esModule",{value:!0}),t.build=function(e){var t=new s.ShaderBuilder,_=0===e.output,m=1===e.output,y=4===e.output;return t.extensions.add("GL_OES_standard_derivatives"),t.include(n.Slice,e),t.attributes.add("position","vec3"),t.attributes.add("color","vec3"),t.vertex.uniforms.add("uModelViewMatrix","mat4").add("uProjectionMatrix","mat4").add("uScreenMinMaxSize","vec2").add("uPointScale","vec2").add("uClipMin","vec3").add("uClipMax","vec3"),m?(t.vertex.uniforms.add("nearFar","vec2"),t.varyings.add("depth","float")):4!==e.output&&t.varyings.add("vColor","vec3"),t.vertex.code.add(a.glsl(h||(h=r.__makeTemplateObject(["\n    void main(void) {\n      // Move clipped points outside of clipspace\n      if (position.x < uClipMin.x || position.y < uClipMin.y || position.z < uClipMin.z ||\n        position.x > uClipMax.x || position.y > uClipMax.y || position.z > uClipMax.z) {\n        gl_Position = vec4(0.0,0.0,0.0,2.0);\n        gl_PointSize = 0.0;\n        return;\n      }\n\n      if (rejectBySlice(position)) {\n        gl_Position = vec4(0.0,0.0,0.0,2.0);\n        gl_PointSize = 0.0;\n        return;\n      }\n\n      // Position in camera space\n      vec4 camera = uModelViewMatrix * vec4(position, 1.0);\n\n      float pointSize = uPointScale.x;\n      vec4 position = uProjectionMatrix * camera;\n     ","\n\n     gl_PointSize = clampedScreenSize;\n     gl_Position = position;\n\n     ","\n     ","\n    }\n  "],["\n    void main(void) {\n      // Move clipped points outside of clipspace\n      if (position.x < uClipMin.x || position.y < uClipMin.y || position.z < uClipMin.z ||\n        position.x > uClipMax.x || position.y > uClipMax.y || position.z > uClipMax.z) {\n        gl_Position = vec4(0.0,0.0,0.0,2.0);\n        gl_PointSize = 0.0;\n        return;\n      }\n\n      if (rejectBySlice(position)) {\n        gl_Position = vec4(0.0,0.0,0.0,2.0);\n        gl_PointSize = 0.0;\n        return;\n      }\n\n      // Position in camera space\n      vec4 camera = uModelViewMatrix * vec4(position, 1.0);\n\n      float pointSize = uPointScale.x;\n      vec4 position = uProjectionMatrix * camera;\n     ","\n\n     gl_PointSize = clampedScreenSize;\n     gl_Position = position;\n\n     ","\n     ","\n    }\n  "])),e.drawScreenSize?a.glsl(u||(u=r.__makeTemplateObject(["\n      float clampedScreenSize = pointSize;"],["\n      float clampedScreenSize = pointSize;"]))):a.glsl(l||(l=r.__makeTemplateObject(["\n      float pointRadius = 0.5 * pointSize;\n      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);\n      vec4 positionOffset = uProjectionMatrix * cameraOffset;\n      float radius = abs(positionOffset.y - position.y);\n      float viewHeight = uPointScale.y;\n      // screen diameter = (2 * r / w) * (h / 2)\n      float screenPointSize = (radius / position.w) * viewHeight;\n      float clampedScreenSize = clamp(screenPointSize, uScreenMinMaxSize.x, uScreenMinMaxSize.y);\n      // Shift towards camera, to move rendered point out of terrain i.e. to\n      // the camera-facing end of the virtual point when considering it as a\n      // 3D sphere.\n      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;\n      position = uProjectionMatrix * camera;"],["\n      float pointRadius = 0.5 * pointSize;\n      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);\n      vec4 positionOffset = uProjectionMatrix * cameraOffset;\n      float radius = abs(positionOffset.y - position.y);\n      float viewHeight = uPointScale.y;\n      // screen diameter = (2 * r / w) * (h / 2)\n      float screenPointSize = (radius / position.w) * viewHeight;\n      float clampedScreenSize = clamp(screenPointSize, uScreenMinMaxSize.x, uScreenMinMaxSize.y);\n      // Shift towards camera, to move rendered point out of terrain i.e. to\n      // the camera-facing end of the virtual point when considering it as a\n      // 3D sphere.\n      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;\n      position = uProjectionMatrix * camera;"]))),m?a.glsl(d||(d=r.__makeTemplateObject(["depth = (-camera.z - nearFar[0]) / (nearFar[1] - nearFar[0]);"],["depth = (-camera.z - nearFar[0]) / (nearFar[1] - nearFar[0]);"]))):"",_?a.glsl(c||(c=r.__makeTemplateObject(["vColor = color;"],["vColor = color;"]))):"")),t.include(o.RgbaFloatEncoding,e),y&&t.include(i.OutputHighlight),t.fragment.code.add(a.glsl(v||(v=r.__makeTemplateObject(["\n    void main(void) {\n      vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);\n      float r2 = dot(vOffset, vOffset);\n\n      if (r2 > 0.25) {\n        discard;\n      }\n      ","\n      ","\n      ","\n    }\n  "],["\n    void main(void) {\n      vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);\n      float r2 = dot(vOffset, vOffset);\n\n      if (r2 > 0.25) {\n        discard;\n      }\n      ","\n      ","\n      ","\n    }\n  "])),m?a.glsl(p||(p=r.__makeTemplateObject(["gl_FragColor = float2rgba(depth);"],["gl_FragColor = float2rgba(depth);"]))):"",y?a.glsl(f||(f=r.__makeTemplateObject(["outputHighlight();"],["outputHighlight();"]))):"",_?a.glsl(g||(g=r.__makeTemplateObject(["gl_FragColor = vec4(vColor, 1.0);"],["gl_FragColor = vec4(vColor, 1.0);"]))):"")),t}}.apply(null,n))||(e.exports=i)},2142:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(117),r(180),r(180),r(226),r(169),r(156),r(152),r(153),r(171),r(198),r(120),r(200),r(151),r(162),r(389),r(193),r(173),r(207),r(1103),r(622),r(191),r(383),r(581),r(308),r(2143),r(250),r(2144),r(2145),r(2146),r(1334),r(2147),r(2148),r(453),r(739),r(203),r(289),r(192),r(218),r(529),r(211)],void 0===(i=function(e,t,r,n,i,o,a,s,u,l,d,c,h,p,f,g,v,_,m,y,b,S,P,x,w,M,C,z,N,O,I,R,A,F,k,V,E,T,j,q,L,D){var U=s.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),W=E.plane.create(),H=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.maximumPointCount=4e6,t.slicePlaneEnabled=!1,t._renderer=null,t._rendererAdded=!1,t._renderedNodes=new Set,t._nodeScales=new Map,t._updateViewNeeded=!0,t._lodFactor=1,t._maxLoggedBoxWarnings=5,t._pageMultiplier=1,t._nodeLoadEpoch=0,t._indexQueue=[],t._workQueue=new Array,t._idleQueue=new x.default,t._indexPagesLoading=new Map,t._loadingNodes=new Map,t._recalcWork=!0,t._layerIsVisible=!1,t._codedDomainPopulationPromise=null,t._codedDomainPopulationAbortController=null,t._totalWork=0,t._index=null,t._loadingInitNodePage=!1,t._nodeIdArray=[],t}return r.__extends(t,e),Object.defineProperty(t.prototype,"pointScale",{get:function(){var e=I.getSplatSizeAlgorithm(this.layer&&this.layer.renderer);return e&&null!=e.scaleFactor?e.scaleFactor:1},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"useRealWorldSymbolSizes",{get:function(){var e=I.getFixedSizeAlgorithm(this.layer&&this.layer.renderer);return!(!e||null==e.useRealWorldSymbolSizes)&&e.useRealWorldSymbolSizes},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pointSize",{get:function(){var e=I.getFixedSizeAlgorithm(this.layer&&this.layer.renderer);return e&&null!=e.size?e.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"inverseDensity",{get:function(){return this.layer&&this.layer.renderer?96/this.layer.renderer.pointsPerInch:5},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"availableFields",{get:function(){var e=I.getRendererInfo(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.primaryAttribute.name);var r=I.getFilterInfo(this.layer);if(r)for(var n=0,i=r;n<i.length;n++){var o=i[n];t.add(o.attributeInfo.name)}if(this.layer.outFields)for(var a=0,s=P.unpackFieldNames(this.layer.fields,this.layer.outFields);a<s.length;a++){var u=s[a];t.add(u)}return c.valuesOfSet(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_clippingBox",{get:function(){if(!this.view||!this.view.clippingArea)return null;var e=_.create(),t=this.view.renderSpatialReference;return j.extentToBoundingBox(this.view.clippingArea,e,t)?e:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_elevationOffset",{get:function(){var e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){var t=p.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=w.getMetersPerUnit(e.unit);return u.unwrapOr(e.offset,0)*r/t}return 0},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this,t=this.view.resourceController,r=t.scheduler;this._worker=new C.PointCloudWorkerHandle(r),this.addResolvingPromise(this._worker.promise),this._tmpPoint=y.makeDehydratedPoint(0,0,0,this.layer.spatialReference),z.checkPointCloudLayerValid(this.layer),z.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._streamDataRequester=t.createStreamDataRequester(2),this._initRenderer();var n=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.getMemCache(this.layer.uid),this.updatingHandles.add(this,"_clippingBox",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this,"_elevationOffset",(function(){return e._elevationOffsetChanged()}),2),this.updatingHandles.add(this.layer,"renderer",(function(){return e._rendererChanged()}),2),this.updatingHandles.add(this.layer,"filters",(function(){return e._reload()}),2),this.updatingHandles.add(this.layer,"outFields",(function(){return e._reload()}),2),this.updatingHandles.add(this.layer,"scaleRangeId",(function(){return e._setUpdateViewNeeded()})),this.updatingHandles.add(this,"clippingArea",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this.view.state,"camera",(function(){return e._setUpdateViewNeeded()})),this.handles.add([this.view.basemapTerrain.on("scale-change",(function(t){return e._scaleUpdateHandler(t)})),i.events.on("quality-changed",(function(){return e._setUpdateViewNeeded()}))]),this.addResolvingPromise(n),this.when((function(){e.handles.add([r.registerTask(D.Task.POINT_CLOUD_LAYER,(function(t){return e._process(t)}),(function(){return e._needsUpdate()})),r.registerIdleStateCallbacks((function(){return e._idleBegin()}),(function(){return e._idleEnd()})),e.updatingHandles.add(e,"suspended",(function(t){t?e._clearNodeState():e._setUpdateViewNeeded()}),2)])}),(function(){e.updatingHandles.removeAll(),e.handles.removeAll()}))},t.prototype._setUpdateViewNeeded=function(){this._updateViewNeeded=!0,this._updateLoading()},t.prototype.destroy=function(){this.cancelLoading(),this._worker&&(this._worker.destroy(),this._worker=null),this._destroyRenderer(),this._memCache.destroy(),this._memCache=null,this._codedDomainPopulationAbortController&&(this._codedDomainPopulationAbortController.abort(),this._codedDomainPopulationAbortController=null),this._codedDomainPopulationPromise=null},t.prototype._initRenderer=function(){var e=this;this._renderer=new F.PointRenderer({createGraphic:function(t,r,n){return e._createGraphic(t,r,n)}}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(this,"_clippingBox",(function(t){return e._renderer.clippingBox=t}),2),this.updatingHandles.add(this,"suspended",(function(t){return e._setPointsVisible(!t)}),2),this.updatingHandles.add(this,"pointScale",(function(t){return e._renderer.scaleFactor=t}),2),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(this,"useRealWorldSymbolSizes",(function(t){return e._renderer.useRealWorldSymbolSizes=t}),2),this.updatingHandles.add(this,"pointSize",(function(t){var r=d.pt2px(t);e._renderer.size=t,e._renderer.sizePx=r}),2),this.updatingHandles.add(this,"slicePlaneEnabled",(function(t){return e._renderer.slicePlane=t}),2),this.updatingHandles.add(this,"inverseDensity",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this,"maximumPointCount",(function(){return e._setUpdateViewNeeded()}),2),this.updatingHandles.add(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",(function(t){e._lodFactor=t,e._setUpdateViewNeeded()}),2)},t.prototype._destroyRenderer=function(){this._renderer.removeAll(),this._setPointsVisible(!1)},t.prototype._createGraphic=function(e,t,r){var n=u.isSome(e.pointIdFilterMap)?e.pointIdFilterMap[t]:t,i=this.view.computeMapPointFromVec3d(r),o=this._createGraphicAttributes(e,n);return new A.PointGraphic({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:n,epoch:this._nodeLoadEpoch},geometry:i,attributes:o,layer:this.layer,sourceLayer:this.layer})},t.prototype._createGraphicAttributes=function(e,t){for(var r={},n=0,i=e.attributes;n<i.length;n++){var o=i[n];this._encodeGraphicAttribute(o.attributeInfo,o.values,t,r)}return r},t.prototype._encodeGraphicAttribute=function(e,t,r,n){var i=e.storageInfo&&e.storageInfo.attributeValues,o=i?i.valuesPerElement:1;if(1===o)n[e.name]=t[r];else if("UInt8"===i.valueType&&o<=4){for(var a=0,s=r*o,u=s;u<s+o;u++)a=(a<<8)+t[u];n[e.name]=a}else n[e.name]=void 0},t.prototype._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin([4],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)},t.prototype._rendererChanged=function(){this._renderer.useFixedSizes=I.rendererUsesFixedSizes(this.layer.renderer),this._reload()},t.prototype._reload=function(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()},t.prototype._elevationOffsetChanged=function(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()},t.prototype._scaleUpdateHandler=function(e){var t=this;this.layer.minScale||this.layer.maxScale?j.boundingRectToBoundingRect(e.extent,e.spatialReference,B,this.layer.spatialReference)&&(this._nodeScales.forEach((function(r,n){if(t._renderedNodes.has(n)){var i=t._index.getNode(n);m.containsPoint(B,i.obb.center)&&t._nodeScales.set(n,e.scale)}else t._nodeScales.delete(n)})),this._setUpdateViewNeeded()):this._nodeScales.clear()},t.prototype.displayNodes=function(e){this._workQueue=N.nodeDiff(n.keysOfSet(this._renderedNodes),e,this._index),N.sortFrontToBack(this._workQueue,this.view.state.camera.viewForward,this._index),N.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")},t.prototype.cancelLoading=function(){this._cancelNodeLoading(),this._cancelIndexLoading()},t.prototype._cancelNodeLoading=function(){var e=new Array;this._loadingNodes.forEach((function(t){var r=t.abortController;return e.push(r)})),this._loadingNodes.clear();for(var t=0,r=e;t<r.length;t++)r[t].abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._updateQueues=function(){var e=this,t=new Set;this._workQueue.forEach((function(e){return e.load.forEach((function(e){return t.add(e)}))}));var r=new Array,n=new Map;this._loadingNodes.forEach((function(e,i){t.has(i)?n.set(i,e):r.push(e)})),this._loadingNodes=n;for(var i=0,o=r;i<o.length;i++)o[i].abortController.abort();this._workQueue=this._workQueue.filter((function(t){for(var r=0,n=t.load;r<n.length;r++){var i=n[r];if(e._loadingNodes.has(i))return e._recalcWork=!0,!1}return!0})),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._cancelIndexLoading=function(){this._indexQueue=[],this._indexPagesLoading.forEach((function(e){return e.abortController.abort()})),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()},t.prototype._clearNodeState=function(){var e=this;this._nodeLoadEpoch++,this._renderedNodes.forEach((function(t){return e._removeFromRenderer(t)})),this._cancelNodeLoading()},t.prototype._idleBegin=function(){this._setUpdateViewNeeded()},t.prototype._idleEnd=function(){this._setUpdateViewNeeded()},t.prototype._needsUpdate=function(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.length>0},t.prototype._process=function(e){var t=this;if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;var r=this._isRootNodeVisible();r!==this._layerIsVisible&&(this._layerIsVisible=r,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run((function(){return t._updateWorkQueues()}));this._indexQueue.length>0&&e.run((function(){return t._processIndexQueue()})););for(this._processWorkQueue(e);this._idleQueue.length>0&&e.run((function(){return t._idleQueue.process()})););}},t.prototype._processIndexQueue=function(){var e=this,t=this._indexQueue.shift(),r=this._loadNodePage(t);return this._indexPagesLoading.set(t,r),r.promise.then((function(r){e._index.addPage(t,r,e._elevationOffset),e._setUpdateViewNeeded()})).then((function(){e._indexPagesLoading.delete(t)}),(function(){e._indexPagesLoading.delete(t)})),!0},t.prototype._processWorkQueue=function(e){for(;!e.done;){var t=this._scheduleWorkEntry();if(u.isNone(t))return;this._processWorkEntry(t),e.madeProgress()}},t.prototype._scheduleWorkEntry=function(){for(var e=this,t=this._workQueue.length;t--;){var r=this._workQueue.shift();if(!i.find(r.remove,(function(t){return!e._renderedNodes.has(t)})))return r;this._workQueue.push(r)}return null},t.prototype._processWorkEntry=function(e){var t=this;if(0!==e.load.length)l.all(e.load.map((function(e){var r=l.createAbortController(),n=t._memCache.pop(e.toString());return u.isSome(n)?t._loadingNodes.set(e,{abortController:r,promise:l.resolve(n)}):t._loadingNodes.has(e)||t._loadingNodes.set(e,{abortController:r,promise:t.loadNode(e,r.signal)}),t._loadingNodes.get(e).promise}))).then((function(r){for(var n=0;n<e.load.length;n++)if(r[n]){var i=t._setupRendererData(e.load[n],r[n]);t._addToRenderer(i)}for(var o=0,a=e.remove;o<a.length;o++){var s=a[o];t._removeFromRenderer(s)}})).catch((function(){})).then((function(){for(var r=0,n=e.load;r<n.length;r++){var i=n[r];t._loadingNodes.delete(i)}t._updateLoading(),t._recalcWork&&0===t._idleQueue.length&&0===t._indexQueue.length&&0===t._loadingNodes.size&&(t._recalcWork=!1,t._setUpdateViewNeeded())})),this._updateLoading();else for(var r=0,n=e.remove;r<n.length;r++){var i=n[r];this._removeFromRenderer(i)}},t.prototype.populateClassCodeCodedDomain=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,a,s;return r.__generator(this,(function(r){switch(r.label){case 0:return!(n=this.layer.fieldsIndex.get("CLASS_CODE"))||n.domain||-1===e.indexOf(n.name)?[2]:[4,o.result(this.layer.queryCachedStatistics("CLASS_CODE",{signal:t}))];case 1:return!1===(i=r.sent()).ok?[2]:(a=i.value,(s=a&&a.labels&&a.labels.labels)&&Array.isArray(s)?(n.domain=new S.CodedValueDomain({name:"CLASS_CODE",codedValues:s.map((function(e){return new b.default({code:e.value,name:e.label})}))}),[2]):[2])}}))}))},t.prototype.prepareFetchPopupFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t=this;return r.__generator(this,(function(r){return this._codedDomainPopulationPromise||(this._codedDomainPopulationAbortController=l.createAbortController(),this._codedDomainPopulationPromise=this.populateClassCodeCodedDomain(e,this._codedDomainPopulationAbortController.signal).then((function(){t._codedDomainPopulationAbortController=null}))),[2,this._codedDomainPopulationPromise]}))}))},t.prototype.whenGraphicAttributes=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,a,s,u,d=this;return r.__generator(this,(function(c){switch(c.label){case 0:return n=this._splitGraphicsPerNode(e),i=this.layer.attributeStorageInfo,a=t.map((function(e){return I.getAttributeInfo(i,e)})),s=function(e,t){return r.__awaiter(d,void 0,void 0,(function(){var n,i=this;return r.__generator(this,(function(s){switch(s.label){case 0:return n=this._index.getNode(t),[4,o.forEach(a,(function(t){return r.__awaiter(i,void 0,void 0,(function(){var i,o,a,s,u,l;return r.__generator(this,(function(r){switch(r.label){case 0:return t.useElevation?[4,this._loadElevationAttributeFromGeometry(n.resourceId)]:[3,2];case 1:return o=r.sent(),[3,4];case 2:return[4,this._loadAndParseAttribute(n,t)];case 3:o=r.sent(),r.label=4;case 4:if(!(i=o))return[2];for(a=0,s=e;a<s.length;a++)u=s[a],this._isValidPointGraphic(u)&&(l=u.pointCloudMetadata.attributePointIndexInNode,this._encodeGraphicAttribute(t,i,l,u.attributes));return[2]}}))}))}))];case 1:return s.sent(),[2]}}))}))},u=[],n.forEach((function(e,t){u.push(s(e,t))})),[4,l.eachAlways(u)];case 1:return c.sent(),[2,e]}}))}))},t.prototype._isValidPointGraphic=function(e){return e instanceof A.PointGraphic&&e.pointCloudMetadata&&e.pointCloudMetadata.epoch===this._nodeLoadEpoch},t.prototype._splitGraphicsPerNode=function(e){for(var t=new Map,r=0,n=e;r<n.length;r++){var i=n[r];if(this._isValidPointGraphic(i)){var o=i.pointCloudMetadata,a=t.get(o.nodeId);a?a.push(i):t.set(o.nodeId,[i])}}return t},t.prototype._loadAndParseAttribute=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._loadAttribute(e.resourceId,t,null)];case 1:return n=r.sent(),[2,u.isSome(n)?R.getAttributeValues({attributeInfo:t,buffer:n},null,e.vertexCount):null]}}))}))},t.prototype._loadElevationAttributeFromGeometry=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this.layer.store.defaultGeometrySchema,i=R.readGeometry,o=[t],[4,this._loadGeometry(e,null)];case 1:return n=i.apply(void 0,o.concat([r.sent()])),[2,R.elevationFromPositions(n,n.length/3)]}}))}))},t.prototype.highlight=function(e){var t=this;if(!e)return{remove:function(){},pause:function(){},resume:function(){}};var r=a.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(r.map((function(e){return t._graphicToPointDefinition(e)})))},t.prototype._graphicToPointDefinition=function(e){if(!this._isValidPointGraphic(e))return null;var t=e.pointCloudMetadata,r=t.nodeId,n=t.pointIndexInNode;return null!=r&&null!=n?{nodeId:r,pointId:n}:null},t.prototype._computeWork=function(){for(var e=0,t=0,r=this._workQueue;t<r.length;t++){var n=r[t];e+=n.load.length+n.remove.length}return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,(e+=this._loadingInitNodePage?100:0)+(this._updateViewNeeded?100:0)},Object.defineProperty(t.prototype,"updatingProgressValue",{get:function(){if(this.suspended)return this._updateViewNeeded?0:1;var e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork},enumerable:!0,configurable:!0}),t.prototype._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")},t.prototype.canResume=function(){return e.prototype.canResume.call(this)&&this._layerIsVisible},t.prototype.isUpdating=function(){return this.suspended?this._updateViewNeeded:this._computeWork()>0},t.prototype._initNodePages=function(){var e=this,t=this.layer.store.index,r=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new O(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,r),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then((function(t){e._index.addPage(0,t,e._elevationOffset),e._loadingInitNodePage=!1,e._setUpdateViewNeeded()}))},t.prototype._loadNodePage=function(e){var t=this,r=l.createAbortController(),n=this.baseUrl+"/nodepages/"+e*this._pageMultiplier;return{promise:this._requestJSON(n,r.signal).then((function(r){return r.nodes.map((function(r,n){return{resourceId:null!=r.resourceId?r.resourceId:e*t._index.pageSize+n,obb:r.obb,firstChild:r.firstChild,childCount:r.childCount,vertexCount:null!=r.vertexCount?r.vertexCount:r.pointCount,lodThreshold:null!=r.lodThreshold?r.lodThreshold:r.effectiveArea}}))})),abortController:r}},t.prototype._updateWorkQueues=function(){if(!this._updateViewNeeded)return!1;for(var e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor(),t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor(),r=this._computeNodesForMinimumDensity(e),n=this._computePointCount(r),i=Math.sqrt(n/(.75*t));n>t;)e*=i,r=this._computeNodesForMinimumDensity(e),n=this._computePointCount(r),i=Math.sqrt(2);return this.displayNodes(r),this._updateViewNeeded=!1,this._updateLoading(),!0},t.prototype._computePointCount=function(e){for(var t=0,r=0;r<e.length;r++){var n=this._index.getNode(e[r]);n&&(t+=n.vertexCount)}return t},t.prototype._getLodMemoryFactor=function(){return this.view.resourceController.memoryController.memoryFactor},t.prototype._isRootNodeVisible=function(){var e=!1;return this._traverseVisible({frustumPlanes:this.view.state.camera.frustum.planes,clippingBox:this._clippingBox},{predicate:function(t,r,n){return e=n,!1},pageMiss:function(){}}),e},t.prototype._computeNodesForMinimumDensity=function(e){var t=this,r=this.view.state.camera,n=r.frustum,i=this._clippingBox,o=r.viewForward,a=g.vec3.dot(o,r.eye),s=E.plane.fromNormalAndOffset(o,-a,W),u=r.perScreenPixelRatio/2,l=e*e,d=this._nodeIdArray;d.length=0;var c=L.extractSafeScaleBounds(this.layer),h=c.minScale,p=c.maxScale,f=0===h&&0===p?function(e){return d.push(e)}:function(e){var r=t._getScale(e);L.scaleBoundsPredicate(r,h,p)&&d.push(e)};return this._traverseVisible({frustumPlanes:n.planes,clippingBox:i},{predicate:function(e,r,n){if(!n)return!1;if(0===r.childCount)return f(e),!1;var i=t._index.getRenderObb(e);return!(t._computeAveragePixelArea(i,r.lodThreshold,r.vertexCount,s,u)<=l&&(f(e),1))},pageMiss:function(e,r){f(e),t._indexQueue.indexOf(r)<0&&t._indexQueue.push(r)}}),d},t.prototype._getScale=function(e){var t=this._nodeScales.get(e);if(null==t){var r=this._index.getNode(e).obb.center;this._tmpPoint.x=r[0],this._tmpPoint.y=r[1],this._tmpPoint.z=r[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t},t.prototype._computeAveragePixelArea=function(e,t,r,n,i){var o=Math.max(1e-7,T.minimumDistancePlane(e,n));return t/(o*o)/(4*i*i)/r},t.prototype.loadNode=function(e,t){try{return this.loadNodeAsync(e,t)}catch(e){throw l.isAbortError(e)||U.error(e),e}},t.prototype.loadAdditionalUserAttributes=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,o,a,s,d,h,p,f,g,v;return r.__generator(this,(function(r){switch(r.label){case 0:if(!(i=this.layer.outFields))return[2,[]];for(o=P.unpackFieldNames(this.layer.fields,i),a=c.SetFromValues(e.map((function(e){return u.isSome(e)?e.name:null}))),s=this.layer.attributeStorageInfo,d=[],h=0,p=o;h<p.length;h++)f=p[h],a.has(f)||(g=I.getAttributeInfo(s,f))&&d.push(t(g));return[4,l.eachAlwaysValues(d)];case 1:return v=r.sent(),l.throwIfAborted(n),[2,u.mapSome(v,(function(e){return e}))]}}))}))},t.prototype.loadNodeAsync=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var n,i,o,a,s,d=this;return r.__generator(this,(function(c){return n=this._index.getNode(e),i=I.getRendererInfo(this.layer),o=I.getFilterInfo(this.layer),a=n.resourceId,s=function(e){return r.__awaiter(d,void 0,void 0,(function(){var n;return r.__generator(this,(function(r){switch(r.label){case 0:return u.isNone(e)?[2,null]:e.useElevation?[2,{attributeInfo:e,buffer:null}]:[4,this._loadAttribute(a,e,t)];case 1:return n=r.sent(),[2,u.isSome(n)?{attributeInfo:e,buffer:n}:null]}}))}))},[2,this._idleQueue.push((function(){return r.__awaiter(d,void 0,void 0,(function(){var n,u,d,c,h,p,f,g,v,_,m,y,b,S,P;return r.__generator(this,(function(x){switch(x.label){case 0:return n=this._loadGeometry(a,t),u=i.primaryAttribute,d=i.modulationAttribute,c=s(u),h=s(d),p=o.map((function(e){return e.attributeInfo})),f=p.map((function(e){return s(e)})),g=this.loadAdditionalUserAttributes(r.__spreadArrays([u,d],p),s,t),[4,l.all([n,c,h,l.all(f),g])];case 1:return v=x.sent(),_=v[0],m=v[1],y=v[2],b=v[3],S=v[4],l.throwIfAborted(t),P={geometryBuffer:_,primaryAttributeData:m,modulationAttributeData:y,filterAttributesData:b,userAttributesData:S,schema:this.layer.store.defaultGeometrySchema,rendererInfo:i,filterInfo:o,obb:this._index.getRenderObb(e),elevationOffset:this._elevationOffset,inSR:this.layer.spatialReference.toJSON(),outSR:this.view.renderCoordsHelper.spatialReference.toJSON()},[2,this._worker.invoke(P,t)]}}))}))}))]}))}))},t.prototype._loadGeometry=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,this._requestBinary(this.baseUrl+"/nodes/"+e+"/geometries/0",t)]}))}))},t.prototype._loadAttribute=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){return u.isNone(t)||!t.storageInfo?[2,null]:(i=t.storageInfo.key,[2,this._requestBinary(this.baseUrl+"/nodes/"+e+"/attributes/"+i,n)])}))}))},t.prototype._requestJSON=function(e,t){return this._streamDataRequester.request(e,"json",{query:{f:"json"},signal:t})},t.prototype._requestBinary=function(e,t){return this._streamDataRequester.request(e,"binary",{signal:t})},t.prototype._removeFromRenderer=function(e){if(this._renderedNodes.has(e)){var t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,function(e){return 5*e.coordinates.length+128}(t))}},t.prototype._addToRenderer=function(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))},t.prototype._setupRendererData=function(e,t){var r=this._index.getNode(e),n=Math.sqrt(r.lodThreshold/r.vertexCount),i=this._index.getRenderObb(e);if(F.PointRenderer.isInstanceOfNode(t))return t.splatSize=n,t.obb=i,t.origin=v.vec3f32.clone(t.obb.center),t;if(t.obb.halfSize[0]>1.001*i.halfSize[0]||t.obb.halfSize[1]>1.001*i.halfSize[1]||t.obb.halfSize[2]>1.001*i.halfSize[2]){if(this._maxLoggedBoxWarnings>0){var o=function(e){return"["+e.halfSize[0]+", "+e.halfSize[1]+", "+e.halfSize[2]+"]"};U.warn("Node "+e+" reported bounding box too small. got "+o(i)+" but points cover "+o(t.obb)),0==--this._maxLoggedBoxWarnings&&U.warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,t.obb)}return{id:e,coordinates:t.points,origin:v.vec3f32.clone(i.center),rgb:t.rgb,attributes:t.attributes,pointIdFilterMap:t.pointIdFilterMap,highlights:null,splatSize:n,obb:i,isLeaf:0===r.childCount}},t.prototype.getUsedMemory=function(){var e=0;return this._renderer.forEachNode((function(t){e+=G,e+=h.estimateSize(t.coordinates);for(var r=0,n=t.attributes;r<n.length;r++){var i=n[r].values;h.isArrayBuffer(i.buffer)&&(e+=h.estimateSize(i))}})),e},t.prototype.getUnloadedMemory=function(){var e=this,t=this._renderedNodes.size;if(t<4)return 0;for(var r=n.keysOfSet(this._renderedNodes).reduce((function(t,r){return t+e._index.getNode(r).vertexCount})),i=this._loadingNodes.size,o=0;o<this._workQueue.length;o++)i+=this._workQueue[o].load.length,i-=this._workQueue[o].remove.length;return i<0?0:i*r/t*((this.getUsedMemory()-t*G)/r)+i*G},t.prototype.ignoresMemoryFactor=function(){return!1},Object.defineProperty(t.prototype,"performanceInfo",{get:function(){var e=this;return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:n.keysOfSet(this._renderedNodes).reduce((function(t,r){return t+e._index.getNode(r).vertexCount}),0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"test",{get:function(){return{index:this._index,visibleNodes:this._renderedNodes}},enumerable:!0,configurable:!0}),r.__decorate([f.property()],t.prototype,"layer",void 0),r.__decorate([f.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],t.prototype,"baseUrl",void 0),r.__decorate([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointScale",null),r.__decorate([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"useRealWorldSymbolSizes",null),r.__decorate([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"pointSize",null),r.__decorate([f.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"inverseDensity",null),r.__decorate([f.property()],t.prototype,"maximumPointCount",void 0),r.__decorate([f.property({readOnly:!0,dependsOn:["layer.renderer","layer.filters","layer.outFields"]})],t.prototype,"availableFields",null),r.__decorate([f.property({readOnly:!0,dependsOn:["view.clippingArea"]})],t.prototype,"_clippingBox",null),r.__decorate([f.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],t.prototype,"_elevationOffset",null),r.__decorate([f.property({type:Boolean})],t.prototype,"slicePlaneEnabled",void 0),r.__decorate([f.property()],t.prototype,"updating",void 0),r.__decorate([f.property(k.updatingProgress)],t.prototype,"updatingProgress",void 0),r.__decorate([f.property({readOnly:!0,dependsOn:["suspended"]})],t.prototype,"updatingProgressValue",null),r.__decorate([f.subclass("esri.views.3d.layers.PointCloudLayerView3D")],t)}(V.PopupSceneLayerView(M.LayerView3D(q))),B=m.create(),G=160;return H}.apply(null,n))||(e.exports=i)},2143:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(117),r(152),r(662)],void 0===(i=function(e,t,r,n,i){Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(t){return e.call(this,"PointCloudWorker","transform",t)||this}return r.__extends(t,e),t.prototype.getTransferList=function(e){var t=[e.geometryBuffer];if(n.isSome(e.primaryAttributeData)&&e.primaryAttributeData.buffer&&t.push(e.primaryAttributeData.buffer),n.isSome(e.modulationAttributeData)&&e.modulationAttributeData.buffer&&t.push(e.modulationAttributeData.buffer),n.isSome(e.filterAttributesData))for(var r=0,i=e.filterAttributesData;r<i.length;r++){var o=i[r];n.isSome(o)&&o.buffer&&t.push(o.buffer)}for(var a=0,s=e.userAttributesData;a<s.length;a++)(o=s[a]).buffer&&t.push(o.buffer);return t},t}(i.WorkerHandle);t.PointCloudWorkerHandle=o}.apply(null,n))||(e.exports=i)},2144:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(162)],void 0===(i=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.nodeDiff=function(e,t,r){for(var u=0;u<t.length;u++)o[u]=!1,a[u]=null;for(u=0;u<e.length;u++)n[u]=!1,i[u]=null;for(u=0;u<t.length;u++)(l=s(t[u],e,r))>=0&&(o[u]=!0,null!=i[l]?i[l].push(t[u]):i[l]=[t[u]]);for(u=0;u<e.length;u++){var l;(l=s(e[u],t,r))>=0&&(n[u]=!0,null!=a[l]?a[l].push(e[u]):a[l]=[e[u]])}var d=[];for(u=0;u<e.length;u++)null!=i[u]||n[u]||d.push({load:[],remove:[e[u]]});for(u=0;u<t.length;u++)null!=a[u]||o[u]||d.push({load:[t[u]],remove:[]});for(u=0;u<t.length;u++)null!=a[u]&&(a[u].length>1||a[u][0]!==t[u])&&d.push({load:[t[u]],remove:a[u]});for(u=0;u<e.length;u++)null!=i[u]&&(i[u].length>1||i[u][0]!==e[u])&&d.push({load:i[u],remove:[e[u]]});return d};var n=[!1],i=[null],o=[!1],a=[null];function s(e,t,r){for(var n=e;n>0;){var i=t.indexOf(n);if(i>=0)return i;n=r.getParentId(n)}return t.indexOf(n)}function u(e,t,r){for(var n=[t.remove[0]],i=[];1===n.length;){var o=n.pop();i.length=0;for(var a=0;a<t.load.length;a++){for(var s=t.load[a],u=r.getParentId(s);u!==o;)s=u,u=r.getParentId(s);var l=n.indexOf(s);l<0&&(l=n.length,n.push(s),i.push([])),i[l].push(t.load[a])}}for(t.load=n,a=0;a<n.length;a++)i[a].length>1?e.push({remove:[n[a]],load:i[a]}):n[a]=i[a][0]}t.sortFrontToBack=function(e,t,n){return e.sort((function(e,i){if(0===e.load.length&&0===i.load.length)return 0;if(0===e.load.length)return-1;if(0===i.load.length)return 1;if(0===e.remove.length&&0===i.remove.length){var o=n.getRenderCenter(e.load[0]),a=n.getRenderCenter(i.load[0]);return r.vec3.dot(o,t)-r.vec3.dot(a,t)}return 0===e.remove.length?-1:0===i.remove.length?1:1===e.load.length&&1===i.load.length?(o=n.getRenderCenter(e.load[0]),a=n.getRenderCenter(i.load[0]),r.vec3.dot(o,t)-r.vec3.dot(a,t)):1===e.load.length?-1:1===i.load.length?1:(o=n.getRenderCenter(e.remove[0]),a=n.getRenderCenter(i.remove[0]),r.vec3.dot(o,t)-r.vec3.dot(a,t))}))},t.splitWorkEntries=function(e,t,r){for(var n=0;n<e.length;++n){var i=e[n];i.load.length>t&&1===i.remove.length&&u(e,i,r)}},t.splitWorkEntry=u}.apply(null,n))||(e.exports=i)},2145:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(193),r(250),r(289)],void 0===(i=function(e,t,r,n,i){function o(e,t){return e/t|0}function a(e,t){return e%t}return function(){function e(e,t,r){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=r}return e.prototype.addPage=function(e,t,r){for(void 0===r&&(r=0);this._pages.length<e;)this._pages.push(null);var s=function(e,t,r,o){for(var a=new i.ObbArray(e.length),s=0;s<e.length;s++)n.transformObb(e[s].obb,t,a.obbs[s],r,o);return a.obbs}(t,this._nodeSR,this._renderSR,r);this._pages[e]={nodes:t,renderObbs:s,parents:new Uint32Array(this.pageSize)},function(e,t){for(var r=[0];r.length;)for(var n=r.pop(),i=e[o(n,t)].nodes[a(n,t)],s=0;s<i.childCount;s++){var u=i.firstChild+s;null!=e[o(u,t)]&&(e[o(u,t)].parents[a(u,t)]=n,r.push(u))}}(this._pages,this.pageSize)},e.prototype.hasPage=function(e){return!!this._pages[e]},e.prototype.getNode=function(e){var t=this.pageSize;return this._pages[o(e,t)].nodes[a(e,t)]},e.prototype.getRenderObb=function(e){var t=this.pageSize;return this._pages[o(e,t)].renderObbs[a(e,t)]},e.prototype.getRenderCenter=function(e){return this.getRenderObb(e).center},e.prototype.setRenderObb=function(e,t){var r=this.pageSize;i.set(t,this._pages[o(e,r)].renderObbs[a(e,r)])},e.prototype.getParentId=function(e){var t=this.pageSize;return this._pages[o(e,t)].parents[a(e,t)]},e.prototype.hasNodes=function(e,t){for(var r=o(e,this.pageSize),n=o(e+t-1,this.pageSize),i=r;i<=n;i++)if(null==this._pages[i])return!1;return!0},e.prototype.forEachNodeId=function(e){for(var t=0;t<this._pages.length;t++){var r=this._pages[t];if(r)for(var n=0;n<r.nodes.length;n++)e(t*this.pageSize+n)}},e.prototype.createVisibilityTraverse=function(){var e={index:this,queue:[],masks:[],tempAabb:r.create()};return function(t,n){return function(e,t,n){var a=e.index;if(a.hasNodes(0,1)){var s=e.queue;s.length=0,s.push(0);var u=e.masks;for(u.length=0,u.push(0);s.length>0;){var l=s.pop(),d=u.pop(),c=a.getNode(l),h=a.getRenderObb(l),p=!0;if(null!=t.clippingBox){var f=1<<t.frustumPlanes.length;if(0==(d&f)){var g=i.toAaBoundingBox(h,e.tempAabb);r.contains(t.clippingBox,g)?d|=f:r.intersects(t.clippingBox,g)||(p=!1)}}for(var v=0;v<t.frustumPlanes.length&&p;v++)if(0==(d&(f=1<<v))){var _=i.intersectPlane(h,t.frustumPlanes[v]);_>0?p=!1:_<0&&(d|=f)}if(n.predicate(l,c,p)){for(var m=c.firstChild,y=c.childCount,b=!1,S=o(m,a.pageSize),P=o(m+y-1,a.pageSize),x=S;x<=P;x++)if(!a.hasPage(x)){n.pageMiss(l,x),b=!0;break}if(!b)for(v=0;v<y;v++)s.push(m+v),u.push(d)}}}}(e,t,n)}},e}()}.apply(null,n))||(e.exports=i)},2146:function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=function(e,t){function r(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.name===t&&null!=i.attributeValues&&"UInt8"===i.attributeValues.valueType&&3===i.attributeValues.valuesPerElement)return{name:t,storageInfo:i,useElevation:!1}}return null}function n(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.name===t){var o="embedded-elevation"===i.encoding;return{name:t,storageInfo:o?null:i,useElevation:o}}}return"elevation"===t.toLowerCase()?{name:t,storageInfo:null,useElevation:!0}:null}Object.defineProperty(t,"__esModule",{value:!0}),t.getRendererInfo=function(e){var t=e.renderer,i=t&&t.type,o=t&&e.renderer.toJSON()||null,a=null,s=!1;"point-cloud-unique-value"===i||"point-cloud-stretch"===i||"point-cloud-class-breaks"===i?a=n(e.attributeStorageInfo,t.field):s="point-cloud-rgb"===i?null!=(a=r(e.attributeStorageInfo,t.field)):null!=(a=r(e.attributeStorageInfo,"RGB"));var u=null;return t&&t.colorModulation&&(u=n(e.attributeStorageInfo,t.colorModulation.field)),{rendererJSON:o,isRGBRenderer:s,primaryAttribute:a,modulationAttribute:u}},t.getFilterInfo=function(e){var t=e.filters;return t?t.map((function(t){return{filterJSON:t.toJSON(),attributeInfo:n(e.attributeStorageInfo,t.field)}})):[]},t.getSplatSizeAlgorithm=function(e){var t=e&&e.pointSizeAlgorithm;return t&&"splat"===t.type?t:null},t.getFixedSizeAlgorithm=function(e){var t=e&&e.pointSizeAlgorithm;return t&&"fixed-size"===t.type?t:null},t.rendererUsesFixedSizes=function(e){var t=e&&e.pointSizeAlgorithm;return!(!t||!t.type)&&"fixed-size"===t.type},t.getAttributeInfo=n}.apply(null,n))||(e.exports=i)},2147:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(117),r(174),r(151)],void 0===(i=function(e,t,r,n,i){Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(t){return e.call(this,t)||this}var n;return r.__extends(t,e),n=t,t.prototype.clone=function(){return new n(this.cloneProperties())},t.prototype.cloneProperties=function(){var t=this.pointCloudMetadata;return r.__assign(r.__assign({},e.prototype.cloneProperties.call(this)),{pointCloudMetadata:t})},r.__decorate([i.property({constructOnly:!0})],t.prototype,"pointCloudMetadata",void 0),n=r.__decorate([i.subclass("esri.views.3d.layers.i3s.PointGraphic")],t)}(n);t.PointGraphic=o}.apply(null,n))||(e.exports=i)},2148:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(152),r(189),r(646),r(185),r(162),r(389),r(160),r(245),r(193),r(2149),r(203),r(203),r(289),r(223),r(345),r(228),r(391),r(2150),r(307),r(318)],void 0===(i=function(e,t,r,n,i,o,a,s,u,l,d,c,h,p,f,g,v,_,m,y,b,S){Object.defineProperty(t,"__esModule",{value:!0});var P={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]},x=function(){function e(e){var t=this;this._params=e,this.type="Point",this.isGround=!1,this._highlights=new c.PointHighlights({forEachNode:function(e){return t.forEachNode(e)},addHighlight:function(e,r,n){return t.addHighlight(e,r,n)},removeHighlight:function(e,r){return t.removeHighlight(e,r)}}),this.canRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._slicePlaneEnabled=!1,this._clipBox=d.create(d.POSITIVE_INFINITY),this._techniqueConfig=new y.PointRendererTechniqueConfiguration,this.tempMatrix4=i.mat4f32.create(),this.tempVec3=s.vec3f32.create(),this.nodes=[]}return Object.defineProperty(e.prototype,"needsHighlight",{get:function(){return this._highlights.hasHighlights},enumerable:!0,configurable:!0}),e.prototype.initializeRenderContext=function(e){this._initContext=e,this._techniqueRep=this._initContext.shaderTechniqueRep,e.requestRender()},e.prototype.uninitializeRenderContext=function(){},e.prototype.intersect=function(e,t,r,n){var i=this,s=u.vec3f64.create(),c=u.vec3f64.create(),g=u.vec3f64.create(),v=u.vec3f64.create(),_=p.plane.create(),y=e.camera.perScreenPixelRatio/2,b=e.camera.near,S=this._getSizeParams();a.vec3.subtract(c,n,r);var P=1/a.vec3.length(c);a.vec3.scale(c,c,P),a.vec3.negate(g,c),l.vec4.set(_,c[0],c[1],c[2],-a.vec3.dot(c,r));var x=function(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""},w=new x,z=new x,N=[],O=d.create(),I=d.create(this._clipBox);d.offset(I,-r[0],-r[1],-r[2],I);for(var R=function(o){var l=o.splatSize*A._scaleFactor,h=f.minimumDistancePlane(o.obb,_),p=f.maximumDistancePlane(o.obb,_);h-=C(l,h+b,S,y,o.isLeaf);var m=(p-=C(l,p+b,S,y,o.isLeaf))<0,R=null!=w.dist&&null!=z.dist&&w.dist<h*P&&z.dist>p*P;if(m||R)return"continue";var F=M(l,p+b,S,y,o.isLeaf);if(!f.intersectLine(o.obb,r,c,F))return"continue";var k=F*F;f.toAaBoundingBox(o.obb,O),d.offset(O,-r[0],-r[1],-r[2],O);var V=!d.contains(I,O);a.vec3.subtract(v,o.origin,r);for(var E=o.coordinates.length/3,T=function(h){if(s[0]=v[0]+o.coordinates[3*h],s[1]=v[1]+o.coordinates[3*h+1],s[2]=v[2]+o.coordinates[3*h+2],V&&!d.containsPoint(I,s))return"continue";var p=a.vec3.dot(s,c),f=a.vec3.squaredLength(s)-p*p;if(f>k)return"continue";var _=p+b,m=C(l,_,S,y,o.isLeaf);if(p-m<0)return"continue";var O=M(l,_-=m,S,y,o.isLeaf);if(f>O*O)return"continue";var R=(p-m)*P,A=function(e){e.point=function(e,t,r){return null==r&&(r=u.vec3f64.create()),r[0]=e.origin[0]+e.coordinates[3*t],r[1]=e.origin[1]+e.coordinates[3*t+1],r[2]=e.origin[2]+e.coordinates[3*t+2],r}(o,h,e.point),e.dist=R,e.normal=g,e.node=o,e.pointId=h,e.layerUid=i.layerUid};if((null==w.dist||R<w.dist)&&(null==t||t(r,n,R))&&A(w),0!==e.options.store&&(null==z.dist||R>z.dist)&&(null==t||t(r,n,R))&&A(z),2===e.options.store&&(null==t||t(r,n,R))){var F=new x;A(F),N.push(F)}},j=0;j<E;j++)T(j)},A=this,F=0,k=this.nodes;F<k.length;F++)R(k[F]);var V=function(e,t){var r=function(e){var t=e.layerUid,r=e.node,n=e.pointId;return{type:"external",point:e.point,metadata:{layerUid:t,createGraphic:function(){return i._params.createGraphic(r,n,e.point)}}}}(t),n=t.layerUid+"/"+t.node.id+"/"+t.pointId;e.set(r,n,t.dist,t.normal,o.mat4f64.IDENTITY,void 0),e.intersector="PointRenderer"};if(null!=w.dist){var E=e.results.min;(null==E.dist||w.dist<E.dist)&&V(E,w)}if(null!=z.dist&&0!==e.options.store){var T=e.results.max;(null==T.dist||z.dist>T.dist)&&V(T,z)}if(2===e.options.store)for(var j=h.ray.fromPoints(r,n),q=0,L=N;q<L.length;q++){var D=L[q],U=new m.IntersectorResult(j);V(U,D),e.results.all.push(U)}},e.prototype.render=function(e){if(0!==e.pass&&1!==e.pass&&4!==e.pass)return!1;for(var t=1===e.pass,r=e.rctx,i=0,o=this.nodes;i<o.length;i++)null==(b=o[i]).vao&&this._initNode(e,b);var s=this._getSizeParams(),u=this.selectTechnique(e,s),l=u.program;if(null==l||0===this.nodes.length)return!0;var c=this._clipBox,h=!d.equals(c,d.POSITIVE_INFINITY,(function(e,t){return e===t}));if(h||(a.vec3.set(this.tempVec3,-1/0,-1/0,-1/0),l.setUniform3fv("uClipMin",this.tempVec3),a.vec3.set(this.tempVec3,1/0,1/0,1/0),l.setUniform3fv("uClipMax",this.tempVec3)),r.bindProgram(l),u.bindPipelineState(r),l.setUniformMatrix4fv("uProjectionMatrix",e.camera.projectionMatrix),t&&l.setUniform2f("nearFar",e.camera.near,e.camera.far),e.isHighlightPass){var p={viewport:e.camera.fullViewport,highlightDepthTexture:e.highlightDepthTexture};v.OutputHighlight.bindOutputHighlight(r,l,p)}var f=e.camera.pixelRatio;s.drawFixedSize&&l.setUniform2f("uPointScale",s.fixedSize*f,e.camera.fullHeight);for(var _=this._slicePlaneEnabled?e.sliceHelper&&e.sliceHelper.plane:null,m=0,y=this.nodes;m<y.length;m++){var b;if(0!==(b=y[m]).coordinates.length&&(!e.isHighlightPass||b.highlights)){if(l.setUniform2f("uScreenMinMaxSize",s.screenMinSize*f,w(b.isLeaf)*f),!s.drawFixedSize){var S=b.splatSize*this._scaleFactor;l.setUniform2f("uPointScale",S*f,e.camera.fullHeight/f)}var P=b.origin;h&&(a.vec3.set(this.tempVec3,c[0]-P[0],c[1]-P[1],c[2]-P[2]),l.setUniform3fv("uClipMin",this.tempVec3),a.vec3.set(this.tempVec3,c[3]-P[0],c[4]-P[1],c[5]-P[2]),l.setUniform3fv("uClipMax",this.tempVec3)),n.mat4.identity(this.tempMatrix4),n.mat4.translate(this.tempMatrix4,this.tempMatrix4,P),n.mat4.multiply(this.tempMatrix4,e.camera.viewMatrix,this.tempMatrix4),l.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),g.Slice.bindUniforms(l,u.configuration,_,P),r.bindVAO(b.vao),e.isHighlightPass?this._renderHighlightFragments(r,b):r.drawArrays(0,0,b.coordinates.length/3)}}return!0},e.prototype._renderHighlightFragments=function(e,t){var n=t.highlights;if(!r.isNone(n)){for(var i=r.unwrap(n[0].component),o=i+1,a=1;a<n.length;a++){var s=r.unwrap(n[a].component);if(s!==o){var u=o-i;u>0&&e.drawArrays(0,i,u),i=s}o=s+1}var l=o-i;l>0&&e.drawArrays(0,i,l)}},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){d.set(this._clipBox,e||d.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"slicePlane",{get:function(){return this._slicePlaneEnabled},set:function(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()},e.prototype.removeNode=function(e){var t=this,r=null;return this.nodes=this.nodes.filter((function(n){return n.id!==e||(r=n,n.vao&&(n.vao.dispose(!0),n.vao=null),t._highlights.nodeRemoved(n),!1)})),this._requestRender(),r},e.prototype.forEachNode=function(e){this.nodes.forEach(e)},e.prototype.removeAll=function(){this.nodes.forEach((function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)})),this._highlights.removeAll(),this.nodes=[],this._requestRender()},e.prototype.highlight=function(e){return this._highlights.add(e)},e.prototype.addHighlight=function(e,t,n){e.highlights=function(e,t,n){var i;r.isNone(e)&&(e=[]);var o={component:t,id:n};e.push(o);for(var a=z(o),s=e.length-1;s>0&&a<z(e[s-1]);)i=[e[s],e[s-1]],e[s-1]=i[0],e[s]=i[1],--s;return e}(e.highlights,t,n),this._requestRender()},e.prototype.removeHighlight=function(e,t){e.highlights=function(e,t){if(r.isNone(e))return e;var n=e.filter((function(e){return e.id!==t}));return 0===n.length?null:n}(e.highlights,t),this._requestRender()},e.prototype._initNode=function(e,t){var r=e.rctx;t.vao=new S(r,_.Default3D,P,{positions:b.createVertex(r,35044,t.coordinates),colors:b.createVertex(r,35044,t.rgb)})},e.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,r=t?this._sizePx:this._size,n=this._minSizePx;return e&&(n=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:r,screenMinSize:n}},e.prototype.selectTechnique=function(e,t){return this._techniqueConfig.drawScreenSize=t.drawScreenSpace,this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled,this._techniqueConfig.sceneHasOcludees=e.hasOccludees,this._techniqueConfig.output=1===e.pass?1:4===e.pass?4:0,this._techniqueRep.acquireAndReleaseExisting(y.PointRendererTechnique,this._techniqueConfig,this._technique)},e}();function w(e){return e?256:64}function M(e,t,r,n,i){if(r.drawScreenSpace)return r.fixedSize*t*n;var o=w(i)*t*n;return r.drawFixedSize?Math.min(r.fixedSize/2,o):r.screenMinSize>0?Math.min(Math.max(r.screenMinSize*t*n,e/2),o):Math.min(e/2,o)}function C(e,t,r,n,i){return r.drawScreenSpace?0:M(e,t,r,n,i)}function z(e){return r.isSome(e.component)?e.component:-1}t.PointRenderer=x,function(e){e.isInstanceOfNode=function(e){return e.hasOwnProperty("splatSize")}}(x=t.PointRenderer||(t.PointRenderer={})),t.PointRenderer=x}.apply(null,n))||(e.exports=i)},2149:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(152),r(198),r(445)],void 0===(i=function(e,t,r,n,i){Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e){this.context=e,this.highlights=new Set}return Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this.highlights.size>0},enumerable:!0,configurable:!0}),e.prototype.destroy=function(){this.highlights=null},e.prototype.add=function(e){var t=this,r=new a(e);return this.highlights.add(r),this.enableSet(r),{remove:function(){return t.removeSet(r)},pause:function(){t.disableSet(r)},resume:function(){t.enableSet(r)}}},e.prototype.removeSet=function(e){this.disableSet(e),this.highlights.delete(e)},e.prototype.enableSet=function(e){var t=this;e.enabled||(e.enabled=!0,this.context.forEachNode((function(r){return t.enableSetForNode(e,r)})))},e.prototype.enableSetForNode=function(e,t){var r=this;if(e.enabled){var n=e.ids.get(t.id);n&&n.forEach((function(n){return r.context.addHighlight(t,n,e.id)}))}},e.prototype.disableSet=function(e){var t=this;e.enabled&&(e.enabled=!1,this.context.forEachNode((function(r){return t.disableSetForNode(e,r)})))},e.prototype.disableSetForNode=function(e,t){e.enabled||this.context.removeHighlight(t,e.id)},e.prototype.nodeAdded=function(e){var t=this;this.highlights.forEach((function(r){return t.enableSetForNode(r,e)}))},e.prototype.nodeRemoved=function(e){var t=this;this.highlights.forEach((function(r){return t.disableSetForNode(r,e)}))},e.prototype.removeAll=function(){var e=this;this.highlights.forEach((function(t){return e.disableSet(t)}))},e}();t.PointHighlights=o;var a=function(){function e(e){this.id=i.generateObject3DStateId(0),this.ids=new Map,this.enabled=!1;for(var t=0,n=e;t<n.length;t++){var o=n[t];r.isSome(o)&&this.add(o.nodeId,o.pointId)}}return e.prototype.add=function(e,t){var r=this.ids.get(e);r?r.add(t):this.ids.set(e,n.SetFromValues([t]))},e}()}.apply(null,n))||(e.exports=i)},2150:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(117),r(253),r(257),r(260),r(228),r(373),r(1351),r(242),r(217),r(161)],void 0===(i=function(e,t,n,i,o,a,s,u,l,d,c){Object.defineProperty(t,"__esModule",{value:!0});var h=function(e){function t(t,r){return e.call(this,t,r)||this}return n.__extends(t,e),t.prototype.initializeProgram=function(e){var r=t.shader.get(),n=this.configuration,i=r.build({output:n.output,slicePlaneEnabled:n.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!0,drawScreenSize:n.drawScreenSize});return new d(e.rctx,i.generateSource("vertex"),i.generateSource("fragment"),s.Default3D)},t.prototype.initializePipeline=function(){return c.makePipelineState({depthTest:{func:513},depthWrite:c.defaultDepthWriteParams,colorWrite:c.defaultColorWriteParams,stencilWrite:this.configuration.sceneHasOcludees?u.stencilWriteMaskOn:null,stencilTest:this.configuration.sceneHasOcludees?u.stencilBaseAllZerosParams:null})},t.shader=new i.ReloadableShaderModule(l,(function(){return new Promise((function(e,t){Promise.resolve().then(function(){var t=[r(1351)];e.apply(null,t)}.bind(this)).catch(t.bind(this))}))})),t}(o.ShaderTechnique);t.PointRendererTechnique=h;var p=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.output=0,t.slicePlaneEnabled=!1,t.drawScreenSize=!1,t.sceneHasOcludees=!1,t}return n.__extends(t,e),n.__decorate([a.parameter({count:7})],t.prototype,"output",void 0),n.__decorate([a.parameter()],t.prototype,"slicePlaneEnabled",void 0),n.__decorate([a.parameter()],t.prototype,"drawScreenSize",void 0),n.__decorate([a.parameter()],t.prototype,"sceneHasOcludees",void 0),t}(a.ShaderTechniqueConfiguration);t.PointRendererTechniqueConfiguration=p}.apply(null,n))||(e.exports=i)},250:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(165),r(180),r(154),r(152),r(153),r(120),r(478),r(189),r(185),r(444),r(600),r(162),r(201),r(170),r(193),r(173),r(197),r(199),r(403),r(473),r(539),r(596),r(289),r(192)],void 0===(i=function(e,t,r,n,i,o,a,s,u,l,d,c,h,p,f,g,v,_,m,y,b,S,P,x,w,M){function C(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}Object.defineProperty(t,"__esModule",{value:!0}),t.DDS_ENCODING_STRING="image/vnd-ms.dds",t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],t.extractWkid=C,t.selectEncoding=function(e,r){if(r)for(var n=0;n<e.length;n++)if(e[n].encoding===t.DDS_ENCODING_STRING)return e[n];for(n=0;n<e.length;n++)if(t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[n].encoding)>-1)return e[n];return null},t.findIntersectingNodes=function(e,t,r,n,i,o){i.traverse(r,(function(r){var i=r.mbs;t!==n&&(i=N,M.mbsToMbs(r.mbs,n,i,t));var a=O(e,i);return 0!==a&&(o(r,a),!0)}))},t.filterInPlace=function(e,t,r){for(var n=0,i=0,o=0;o<t.length&&n<e.length;o++)e[n]===t[o]&&(r(o)&&(e[i]=e[n],i++),n++);e.length=i};var z=v.create();t.getClipAABB=function(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return z[0]=(e[0]-t.position[0])/t.rotationScale[0],z[1]=(e[1]-t.position[1])/t.rotationScale[4],z[2]=(e[2]-t.position[2])/t.rotationScale[8],z[3]=(e[3]-t.position[0])/t.rotationScale[0],z[4]=(e[4]-t.position[1])/t.rotationScale[4],z[5]=(e[5]-t.position[2])/t.rotationScale[8],z};var N=f.vec4f64.create();function O(e,t){var r=t[0],n=t[1],i=t[3],o=e[0]-r,a=r-e[2],s=e[1]-n,u=n-e[3],l=Math.max(o,a,0),d=Math.max(s,u,0),c=l*l+d*d;return c>i*i?0:c>0?1:-Math.max(o,a,s,u)>i?3:2}function I(e,t,r){for(var n=[],i=r&&r.missingFields,o=r&&r.originalFields,a=0,s=e;a<s.length;a++){for(var u=s[a],l=u.toLowerCase(),d=!1,c=0,h=t;c<h.length;c++){var p=h[c];if(l===p.name.toLowerCase()){n.push(p.name),d=!0,o&&o.push(u);break}}!d&&i&&i.push(u)}return n}t.intersectBoundingRectWithMbs=O,t.intersectBoundingBoxWithMbs=function(e,t){var r=t[0],n=t[1],i=t[2],o=t[3],a=e[0]-r,s=r-e[3],u=e[1]-n,l=n-e[4],d=e[2]-i,c=i-e[5],h=Math.max(a,s,0),p=Math.max(u,l,0),f=Math.max(d,c,0),g=h*h+p*p+f*f;return g>o*o?0:g>0?1:-Math.max(a,s,u,l,d,c)>o?3:2},t.findFieldsCaseInsensitive=I,t.whenGraphicAttributes=function(e,t,o,s,u,l){var d;if(!0===(l&&l.populateObjectId)&&(d=o,s=s.filter((function(e){return e!==d})).concat([d])),0===t.length)return a.resolve(t);var c=e.associatedLayer,h=e.attributeStorageInfo;if(c)return function(e,t,r,n){t.sort((function(e,t){return e.attributes[r]-t.attributes[r]}));var o=t.map((function(e){return e.attributes[r]})),s=[],u=I(n,e.fields,{originalFields:s});return function e(t,r,n){var o=t.capabilities.query.maxRecordCount;if(null!=o&&r.length>o){var s=function(e,t){for(var r=e.length,n=Math.ceil(r/t),i=[],o=0;o<n;o++){var a=Math.floor(r*o/n),s=Math.floor(r*(o+1)/n);i.push(e.slice(a,s))}return i}(r,o);return a.all(s.map((function(r){return e(t,r,n)}))).then(k)}var u=new y({objectIds:r,outFields:n,orderByFields:[t.objectIdField]});return t.queryFeatures(u).then((function(e){if(e&&e.features&&e.features.length===r.length)return e.features.map((function(e){return e.attributes}));throw new i("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")}))}(e,o,u).then((function(e){for(var r=0;r<t.length;r++){var n=t[r],i=e[r],o={};if(n.attributes)for(var a in n.attributes)o[a]=n.attributes[a];for(var l=0;l<s.length;l++)o[s[l]]=i[u[l]];n.attributes=o}return t}))}(c,t,o,s);if(h){var p=u(t);if(!p)return a.reject(new i("scenelayer:features-not-loaded","Tried to query attributes for unloaded features"));var f=e.parsedUrl.path;return a.all(p.map((function(e){return function(e,t,n,i,o){for(var s=[],u=0,l=t;u<l.length;u++){var d=l[u];if(d&&-1!==o.indexOf(d.name)){var c=e+"/nodes/"+n.resources.attributes+"/attributes/"+d.key+"/0";s.push({url:c,storageInfo:d})}}return a.eachAlways(s.map((function(e){return r(e.url,{responseType:"array-buffer"}).then((function(t){return b.readBinaryAttribute(e.storageInfo,t.data)}))}))).then((function(e){for(var t=[],r=0,n=i;r<n.length;r++){for(var o=n[r],a={},u=0;u<e.length;u++)null!=e[u].value&&(a[s[u].storageInfo.name]=F(e[u].value,o));t.push(a)}return t}))}(f,h,e.node,e.indices,s).then((function(t){for(var r=0;r<e.graphics.length;r++){var n=e.graphics[r],i=t[r];if(n.attributes)for(var o in n.attributes)o in i||(i[o]=n.attributes[o]);n.attributes=i}return e.graphics}))}))).then(n.flatten)}return a.reject(new i("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var R=-Math.pow(2,15),A=-Math.pow(2,31);function F(e,t){if(!e)return null;var r=e[t];return s.isInt16Array(e)?r===R?null:r:s.isInt32Array(e)?r===A?null:r:r!=r?null:r}function k(e){for(var t=[],r=0,n=e;r<n.length;r++){var i=n[r];t=t.concat(i)}return t}function V(e){var t=new g(C(e.store.indexCRS||e.store.geographicCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function E(e){var t=new g(C(e.store.vertexCRS||e.store.projectedCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function T(e,t,r){if(!m.canProject(e,t))throw new i("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&e.isGeographic)throw new i("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function j(e,t,r){var n=V(e),i=E(e);T(n,t,r),T(i,t,r)}function q(e){return"mesh-3d"===e.type}t.getCachedAttributeValue=F,t.getIndexCrs=V,t.getVertexCrs=E,t.getCacheKeySuffix=function(e,t){return t===M.SphericalECEFSpatialReference?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null},t.checkSpatialReference=T,t.checkSpatialReferences=j,t.checkSceneLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||null!=(t=e.store.defaultGeometrySchema).geometryType&&"triangles"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new i("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path});var t},t.checkSceneLayerCompatibleWithView=function(e,t){j(e,t.spatialReference,t.viewingMode)},t.checkPointCloudLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||null==(t=e.store.defaultGeometrySchema).geometryType||"points"!==t.geometryType||null!=t.topology&&"PerAttributeArray"!==t.topology||null!=t.encoding&&""!==t.encoding&&"lepcc-xyz"!==t.encoding||null==t.vertexAttributes||null==t.vertexAttributes.position)throw new i("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});var t},t.checkPointCloudLayerCompatibleWithView=function(e,t){T(e.spatialReference,t.spatialReference,t.viewingMode)},t.rendererNeedsTextures=function(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var t=e.getSymbols();if(0===t.length)return!0;for(var r=0,n=t;r<n.length;r++){var i=n[r];if(!q(i)||0===i.symbolLayers.length)return!0;for(var a=0,s=i.symbolLayers.items;a<s.length;a++){var u=s[a];if("fill"!==u.type||o.isNone(u.material)||o.isNone(u.material.color)||"replace"!==u.material.colorMixMode)return!0}}return!1},t.transparentEdgeMaterial=P.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});var L=function(){this.edgeMaterial=null,this.material=null,this.castShadows=!0};function D(e,t,r,n,i,o){void 0===i&&(i=0),void 0===o&&(o=!1),n!==U||o?e===r?(r.center[2]+=i,M.bufferToBuffer(r.center,t,0,r.center,n,0,1)):(p.vec3.set(r.center,e.center[0],e.center[1],e.center[2]+i),M.bufferToBuffer(r.center,t,0,r.center,n,0,1),c.quat.copy(r.quaternion,e.quaternion),p.vec3.copy(r.halfSize,e.halfSize)):t.isGeographic?function(e,t,r,n){var i=1+Math.max(0,n)/(u.wgs84Radius+e.center[2]);p.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+n),M.bufferToBuffer(t.center,r,0,t.center,U,0,1),c.quat.copy(t.quaternion,e.quaternion),c.quat.conjugate(B,e.quaternion),p.vec3.set(Z,0,0,1),p.vec3.transformQuat(Z,Z,B),p.vec3.set(Z,e.halfSize[0]*Math.abs(Z[0]),e.halfSize[1]*Math.abs(Z[1]),e.halfSize[2]*Math.abs(Z[2])),p.vec3.scale(Z,Z,W),p.vec3.add(t.halfSize,e.halfSize,Z),p.vec3.scale(t.halfSize,t.halfSize,i)}(e,r,t,i):function(e,t,r,n){w.corners(e,G),p.vec3.set(t.center,e.center[0],e.center[1],e.center[2]+n),M.computeLinearTransformation(r,t.center,H,U),p.vec3.set(t.center,H[12],H[13],H[14]);var i=2*Math.sqrt(1+H[0]+H[5]+H[10]);B[0]=(H[6]-H[9])/i,B[1]=(H[8]-H[2])/i,B[2]=(H[1]-H[4])/i,B[3]=.25*i,c.quat.multiply(t.quaternion,B,e.quaternion),c.quat.conjugate(B,t.quaternion);for(var o=0,a=0,s=0,u=0,l=G;u<l.length;u++){var d=l[u];d[2]+=n,M.bufferToBuffer(d,r,0,d,U,0,1),p.vec3.sub(Z,d,t.center),p.vec3.transformQuat(Z,Z,B),o=Math.max(o,Math.abs(Z[0])),a=Math.max(a,Math.abs(Z[1])),s=Math.max(s,Math.abs(Z[2]))}p.vec3.set(t.halfSize,o,a,s)}(e,r,t,i)}t.SymbolInfo=L,t.getSymbolInfo=function(e){for(var t=new L,r=!1,n=!1,i=0,a=e.symbolLayers.items;i<a.length;i++){var s=a[i];if("fill"===s.type&&s.enabled){var u=s.material,l=s.edges;if(o.isSome(u)&&!r){var d=u.color,c=x.parseColorMixMode(u.colorMixMode);o.isSome(d)?t.material={color:[d.r/255,d.g/255,d.b/255],alpha:d.a,colorMixMode:c}:t.material={color:[1,1,1],alpha:1,colorMixMode:1},t.castShadows=s.castShadows,r=!0}o.isSome(l)&&!n&&(t.edgeMaterial=P.createMaterialFromEdges(l,{}),n=!0)}}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1}),t},t.addWraparound=function(e,t){return(0|e)+(0|t)|0},t.transformObb=D,t.computeAuthorativeOBB=function(e,t,r,n,i,a){var s,u=S.computeGlobalTransformation(e.mbs,i,r,t);l.mat4.invert(X,u);var d=1/0,c=-1/0,h=function(a){if("replace"===a.type){var u=a.geometry;if(u.hasZ){_.empty(Q);var l=u.spatialReference||n,h=u.rings.reduce((function(e,r){return r.reduce((function(e,r){return M.vectorToVector(r,l,Z,t),p.vec3.transformMat4(Z,Z,X),_.expandPointInPlace(Q,Z),Math.min(Z[2],e)}),e)}),1/0);!function(){if(!s)if(s=G,_.empty(J),o.isSome(e.obb)&&!e.isComputedObb){D(e.obb,r,Y,t,i,e.isComputedObb),w.corners(Y,s);for(var n=0,a=s;n<a.length;n++){var u=a[n];p.vec3.transformMat4(u,u,X),_.expandPointInPlace(J,u)}}else{var l=e.mbs,d=l[3];M.vectorToVector(l,r,Z,t),p.vec3.transformMat4(Z,Z,X),Z[2]+=i;for(var c=0;c<8;++c){var h=1&c?d:-d,f=2&c?d:-d,g=4&c?d:-d;u=s[c],p.vec3.copy(u,[Z[0]+h,Z[1]+f,Z[2]+g]),_.expandPointInPlace(J,u)}}}(),_.intersects(J,Q)&&(d=Math.min(d,h),c=Math.max(c,h))}}};if(a.forEach((function(e){return h(e)})),d===1/0)return null;for(var f,g,v,m=0;m<8;++m)f=K.data,g=3*m,v=s[m],p.vec3.transformMat4(Z,v,u),f[g+0]=Z[0],f[g+1]=Z[1],f[g+2]=Z[2],g+=24,v[2]=d,p.vec3.transformMat4(Z,v,u),f[g+0]=Z[0],f[g+1]=Z[1],f[g+2]=Z[2],g+=24,v[2]=c,p.vec3.transformMat4(Z,v,u),f[g+0]=Z[0],f[g+1]=Z[1],f[g+2]=Z[2];return w.compute(K)};var U=M.SphericalECEFSpatialReference,W=1/(1-u.wgs84Flattening)-1,H=d.mat4f64.create(),B=h.quatf32.create(),G=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],Q=_.create(),J=_.create(),Y=w.create(),Z=[0,0,0],K={data:new Array(72),size:3,offsetIdx:0,strideIdx:3},X=d.mat4f64.create()}.apply(null,n))||(e.exports=i)},281:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(117),r(296),r(152),r(191)],void 0===(i=function(e,t,r,n,i,o){Object.defineProperty(t,"__esModule",{value:!0}),t.getRequiredFields=function(e,t){return void 0===t&&(t=e.popupTemplate),r.__awaiter(this,void 0,void 0,(function(){var a,s,u,l,d,c,h,p,f;return r.__generator(this,(function(g){switch(g.label){case 0:return i.isSome(t)?[4,t.getRequiredFields(e.fields)]:[2,[]];case 1:return a=g.sent(),s=t.lastEditInfoEnabled,u=e.objectIdField,l=e.typeIdField,d=e.globalIdField,c=e.relationships,n.includes(a,"*")?[2,["*"]]:s?[4,o.getFeatureEditFields(e)]:[3,3];case 2:return p=g.sent(),[3,4];case 3:p=[],g.label=4;case 4:return h=p,f=o.fixFields(e.fields,r.__spreadArrays(a,h)),l&&f.push(l),f&&u&&o.hasField(e.fields,u)&&-1===f.indexOf(u)&&f.push(u),f&&d&&o.hasField(e.fields,d)&&-1===f.indexOf(d)&&f.push(d),c&&c.forEach((function(t){var r=t.keyField;f&&r&&o.hasField(e.fields,r)&&-1===f.indexOf(r)&&f.push(r)})),[2,f]}}))}))},t.getFetchPopupTemplate=function(e,t){return e.popupTemplate?e.popupTemplate:i.isSome(t)&&t.defaultPopupTemplateEnabled&&i.isSome(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}}.apply(null,n))||(e.exports=i)},383:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(153)],void 0===(i=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._tasks=new Array}return Object.defineProperty(e.prototype,"length",{get:function(){return this._tasks.length},enumerable:!0,configurable:!0}),e.prototype.push=function(e){var t=this;return r.create((function(r,n){return t._tasks.push(new i(r,n,e))}))},e.prototype.unshift=function(e){var t=this;return r.create((function(r,n){return t._tasks.unshift(new i(r,n,e))}))},e.prototype.process=function(){if(0===this._tasks.length)return!1;var e=this._tasks.shift();try{var t=e.callback();t&&"then"in t&&"function"==typeof t.then?t.then(e.resolve,e.reject):e.resolve(t)}catch(t){e.reject(t)}return!0},e.prototype.cancelAll=function(){for(var e=r.createAbortError(),t=0,n=this._tasks;t<n.length;t++)n[t].reject(e);this._tasks.length=0},e}();t.default=n;var i=function(e,t,r){this.resolve=e,this.reject=t,this.callback=r}}.apply(null,n))||(e.exports=i)},473:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(185),r(160),r(238),r(192)],void 0===(i=function(e,t,r,n,i,o){function a(e,t,r){var o=n.vec3f64.create(),a=e[3],s=Math.ceil(Math.log(a)*Math.LOG2E/4),u=Math.pow(2,4*s+1);if(r.isGeographic){var l=u/i.earthRadius*180/Math.PI,d=Math.round(e[1]/l),c=Math.max(-90,Math.min(90,d*l)),h=l/Math.cos((Math.abs(c)-l/2)/180*Math.PI),p=(f=Math.round(e[0]/h))*h;o[0]=p,o[1]=c}else{var f=Math.round(e[0]/u);d=Math.round(e[1]/u),o[0]=f*u,o[1]=d*u}var g=e[2]+t,v=Math.round(g/u);return o[2]=v*u,o}Object.defineProperty(t,"__esModule",{value:!0}),t.computeGlobalTransformation=function(e,t,n,i){var s=a(e,t,n),u=r.mat4f64.create();return o.computeLinearTransformation(n,s,u,i),u},t.getLocalOrigin=a}.apply(null,n))||(e.exports=i)},739:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(117),r(154),r(152),r(153),r(198),r(151),r(191),r(281)],void 0===(i=function(e,t,r,n,i,o,a,s,u,l){Object.defineProperty(t,"__esModule",{value:!0}),t.PopupSceneLayerView=function(e){return function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r.__extends(t,e),t.prototype._validateFetchPopupFeatures=function(e){var t=this.layer;return t.popupEnabled?l.getFetchPopupTemplate(t,e)?void 0:new n("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new n("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})},t.prototype.prepareFetchPopupFeatures=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){return[2]}))}))},t.prototype.fetchPopupFeatures=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var e,n,s,d,c,h,p,f,g,v,_;return r.__generator(this,(function(r){switch(r.label){case 0:return(e=this._validateFetchPopupFeatures(t))?[2,o.reject(e)]:(n=i.isSome(t)?t.clientGraphics:null)&&0!==n.length?(s=[],d=[],h=u.unpackFieldNames,p=[this.layer.fields],[4,l.getRequiredFields(this.layer,l.getFetchPopupTemplate(this.layer,t))]):[2,o.resolve([])];case 1:return c=h.apply(void 0,p.concat([r.sent()])),[4,this.prepareFetchPopupFeatures(c)];case 2:for(r.sent(),f=new Set,g=0,v=n;g<v.length;g++)_=v[g],u.populateMissingFields(c,_,f)?d.push(_):s.push(_);return 0===d.length?[2,o.resolve(s)]:[2,this.whenGraphicAttributes(d,a.valuesOfSet(f)).catch((function(){return d})).then((function(e){return s.concat(e)}))]}}))}))},r.__decorate([s.subclass("esri.views.3d.layers.support.PopupSceneLayerView")],t)}(e)}}.apply(null,n))||(e.exports=i)}}]);
//# sourceMappingURL=53.js.map