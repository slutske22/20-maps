// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/accessorSupport/decorators","../../../../../geometry/SpatialReference","../../../../../layers/support/LabelClass","../../../../../layers/support/labelFormatUtils","../../../../../renderers/support/jsonUtils","../../../engine","../../../arcade/utils","../../../engine/webgl/util/vvFlagUtils","../batchUtils","../textUtils","./BaseProcessor","../support/AttributeStore"],(function(e,t,r,n,i,o,a,s,l,u,c,f,p,d,h,y,g,_,b,v){Object.defineProperty(t,"__esModule",{value:!0});var m=o.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");var w=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._symbolToMosaicItemMap=new Map,t._visualSetPromises=new Map,t.type="symbol",t}return r.__extends(t,e),t.prototype.initialize=function(){this._factory=this._createFactory()},t.prototype.destroy=function(){this._visualSetPromises.clear(),this._symbolToMosaicItemMap.clear(),this.notifyChange("updating")},Object.defineProperty(t.prototype,"supportsTileUpdates",{get:function(){return!0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelingInfo",{get:function(){return!this.config||a.isNone(this.config.labelingInfo)?null:this.config.labelingInfo.map((function(e){return c.fromJSON(e)}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"labelingInfoFeatureReduction",{get:function(){var e,t;if(!this.config||a.isNone(this.config.featureReduction))return null;var r=this.config.featureReduction;return"cluster"===r.type&&a.isSome(null===(e=r.drawingInfo)||void 0===e?void 0:e.labelingInfo)?null===(t=r.drawingInfo)||void 0===t?void 0:t.labelingInfo.map((function(e){return c.fromJSON(e)})):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasLabels",{get:function(){return!(!this.labelingInfo&&!this.labelingInfoFeatureReduction)},enumerable:!0,configurable:!0}),t.prototype._updateLabelClassInfos=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,o,l,u=this;return r.__generator(this,(function(c){switch(c.label){case 0:return a.isNone(this.labelingInfo)&&a.isNone(this.labelingInfoFeatureReduction)?[2,s.resolve()]:(e=function(e){return r.__awaiter(u,void 0,void 0,(function(){var t,i,o;return r.__generator(this,(function(r){switch(r.label){case 0:t=null,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,f.createLabelFunction(e,this.service.fields,this.spatialReference)];case 2:return t=r.sent(),[3,4];case 3:return i=r.sent(),o=e.where?"where":"arcade",m.error(new n("mapview-labeling","Failed to evaluate "+o+" expression",{labelClass:e,error:i})),[3,4];case 4:return[2,t]}}))}))},t=[],a.isSome(this.labelingInfo)&&t.push.apply(t,this.labelingInfo.map((function(t,n){return r.__awaiter(u,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return i=a.andThen,[4,e(t)];case 1:return[2,i.apply(void 0,[r.sent(),function(e){return{type:"feature",labelClass:t,index:n,minScale:t.minScale,maxScale:t.maxScale,builder:e,symbol:t.symbol,symbolJSON:t.symbol.toJSON()}}])]}}))}))}))),a.isSome(this.labelingInfoFeatureReduction)&&(i=t.length,t.push.apply(t,this.labelingInfoFeatureReduction.map((function(t,n){return r.__awaiter(u,void 0,void 0,(function(){var o;return r.__generator(this,(function(r){switch(r.label){case 0:return o=a.andThen,[4,e(t)];case 1:return[2,o.apply(void 0,[r.sent(),function(e){return{type:"aggregate",labelClass:t,index:i+n,minScale:t.minScale,maxScale:t.maxScale,builder:e,symbol:t.symbol,symbolJSON:t.symbol.toJSON()}}])]}}))}))})))),[4,s.all(t)]);case 1:return o=c.sent(),l=o.filter((function(e){return e})),this._labelClassInfos=l,[2]}}))}))},Object.defineProperty(t.prototype,"hydrate",{get:function(){return h.createHydrateFactory(this.service.geometryType)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderer",{get:function(){return this.config?p.fromJSON(this.config.renderer):(i("esri-2d-debug")&&console.debug("Unable to create renderer for undefined configuration"),null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._visualSetPromises.size>0},enumerable:!0,configurable:!0}),t.prototype.update=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,n;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this._getMeshHash(),this._set("config",e),[4,this._updateLabelClassInfos()];case 1:return r.sent(),t!==this._getMeshHash()&&(this._factory=this._createFactory()),n=this._labelClassInfos,this._factory.update(n,this.renderer,this.tileStore.tileScheme.tileInfo),[2]}}))}))},t.prototype.onTileData=function(e,t,r){var n=this,i=this._onTileData(e,t,r);return this._visualSetPromises.set(e,i),s.always(i,(function(){return n._cleanPromise(e)})),this.notifyChange("updating"),i},t.prototype.onTileError=function(e,t,r){var n=this,i=r.signal,o={tileKey:e.id,error:t},a=this.remoteClient.invoke("tileRenderer.onTileError",o,{signal:i});return this._visualSetPromises.set(e,a),s.always(a,(function(){return n._cleanPromise(e)})),this.notifyChange("updating"),a},t.prototype._getMeshHash=function(){var e=y.getVVFlags("visualVariables"in this.renderer&&this.renderer.visualVariables||[]);return this.renderer.getMeshHash()+"."+e},t.prototype._createFactory=function(){var e=this,t=this.service,r=t.geometryType,n=t.objectIdField,i={geometryType:r,fields:t.fields,spatialReference:u.fromJSON(this.spatialReference)},o=new d.WGLTemplateStore((function(t,r){return e.remoteClient.invoke("tileRenderer.getMaterialItems",t,r)}),!1);return this._store=o,this._matcher=d.createMatcher(o,i,this.renderer),new d.WGLMeshFactory(r,n,this.renderer,o)},t.prototype._cleanPromise=function(e){this._visualSetPromises.delete(e),this.notifyChange("updating")},t.prototype._onTileData=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,o,s,l,u,c,f,p,d,h,y;return r.__generator(this,(function(r){switch(r.label){case 0:i=t.addOrUpdate,o=t.remove,s=t.clear,l=this._processFeatures(e,i,t.transformParams,n),u=n.signal,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,l];case 2:return c=r.sent(),f=a.andThen(c,(function(e){return e.message})),p=a.andThen(c,(function(e){return e.transferList}))||[],d={addOrUpdate:f,remove:o,clear:s},h={transferList:a.unwrap(p)||[],signal:u},[2,this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:d},h)];case 3:return y=r.sent(),this._handleError(e,y,n),[3,4];case 4:return[2]}}))}))},t.prototype._processFeatures=function(e,t,n,i){return r.__awaiter(this,void 0,void 0,(function(){var o,a,l,u,c;return r.__generator(this,(function(r){switch(r.label){case 0:return t&&t.length?(o=this._factory,a={viewingMode:"",scale:e.scale},[4,this._matcher]):[2,null];case 1:return l=r.sent(),[4,this._getLabelInfos(e,t,n)];case 2:return u=r.sent(),[4,o.analyze(t,l,n,a)];case 3:return c=r.sent(),s.throwIfAborted(i),[2,this._writeFeatures(e,c,n,u,o,i)]}}))}))},t.prototype._writeFeatures=function(e,t,o,s,l,u){return r.__awaiter(this,void 0,void 0,(function(){var c,f,p;return r.__generator(this,(function(d){switch(d.label){case 0:return c=l.createMeshData(t.length),f={viewingMode:"",scale:e.scale},p=r.__assign(r.__assign({},u),{batchSize:200}),[4,g.executeForEachAsync(t,(function(t){try{var r=a.isSome(s)?s.get(t.localId):null;l.write(c,t,o,f,e.level,r)}catch(e){i("esri-2d-debug")&&m.error(new n("mapview-mesh-factory","Failed to write feature",{error:e,feature:t}))}}),p)];case 1:return d.sent(),[2,this._encodeDisplayData(c)]}}))}))},t.prototype._encodeDisplayData=function(e){var t={},r=new Array;return e.encode(t,r),{message:t,transferList:r}},t.prototype._handleError=function(e,t,r){if(!s.isAbortError(t)){var n={tileKey:e.id,error:t.message};return this.remoteClient.invoke("tileRenderer.onTileError",n,{signal:r.signal})}},t.prototype._getLabelClassInfosForScale=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){return[2,this._labelClassInfos.filter((function(t){var r=t.minScale,n=t.maxScale;return(!r||r>=e||0===r)&&(!n||n<=e||0===n)}))]}))}))},t.prototype._shouldDiscard=function(e,t){switch(this.service.geometryType){case"esriGeometryPoint":var r=t.geometry,n=r.x,i=r.y;return e.checkOverlap(n,i);case"esriGeometryPolygon":var o=t.centroid;n=o.x,i=o.y;return e.checkOverlap(n,i);default:return!1}},t.prototype._markUsed=function(e,t){switch(this.service.geometryType){case"esriGeometryPoint":var r=t.geometry,n=r.x,i=r.y;return e.markUsed(n,i);case"esriGeometryPolygon":var o=t.centroid;n=o.x,i=o.y;return e.markUsed(n,i)}},t.prototype._getLabelInfos=function(e,t,n){return r.__awaiter(this,void 0,void 0,(function(){var i,o,s,l,c,f,p,h,y;return r.__generator(this,(function(g){switch(g.label){case 0:return this.hasLabels&&t&&0!==t.length?[4,this._getLabelClassInfosForScale(e.scale)]:[2,null];case 1:if(0===(i=g.sent()).length)return[2,null];for(o=new Map,s=new d.CollisionGrid(d.definitions.COLLISION_EARLY_REJECT_BUCKET_SIZE),l=function(e){var t=e.localId;if(c._shouldDiscard(s,e))return o.has(t)||o.set(t,null),"continue";for(var l=function(e,t){for(var r=new Array(e),n=0;n<r.length;n++)r[n]=t;return r}(i.length,null),f=!1,p=function(o){var s=i[o],p=s.type,h=s.index,y=s.builder,g=s.symbolJSON;if((v.isAggregateId(t)&&e.attributes.cluster_count>1?"aggregate":"feature")!==p)return"continue";var b;if(!n)return m.error("mapview-labeling","Tried to evaluate geometry expression but no transformation found"),{value:void 0};var w=n.transform,I=n.hasZ,S=n.hasM,O=c.hydrate(e.geometry,w,I,S),F=r.__assign(r.__assign({},e),{geometry:O});O.spatialReference=u.fromJSON(c.spatialReference),b=F;var P=y.evaluate(b);if(a.isNone(P)||""===P)return"continue";var T=d.bidiText(P),C=T[0],L=T[1];f=!0,c._store.getMosaicItem(g,!1,_.codepoints(C)).then((function(e){l[h]={glyphs:e.glyphMosaicItems,rtl:L,classIndex:h}}))},h=0;h<i.length;h++){var y=p(h);if("object"==typeof y)return y}o.set(t,l),f&&c._markUsed(s,e)},c=this,f=0,p=t;f<p.length;f++)if(h=p[f],"object"==typeof(y=l(h)))return[2,y.value];return[2,o]}}))}))},r.__decorate([l.property({readOnly:!0})],t.prototype,"supportsTileUpdates",null),r.__decorate([l.property()],t.prototype,"config",void 0),r.__decorate([l.property({dependsOn:["config"]})],t.prototype,"labelingInfo",null),r.__decorate([l.property({dependsOn:["config"]})],t.prototype,"labelingInfoFeatureReduction",null),r.__decorate([l.property({dependsOn:["labelingInfo","labelingInfoFeatureReduction"]})],t.prototype,"hasLabels",null),r.__decorate([l.property({dependsOn:["service"]})],t.prototype,"hydrate",null),r.__decorate([l.property({dependsOn:["config"],readOnly:!0})],t.prototype,"renderer",null),r.__decorate([l.property({readOnly:!0})],t.prototype,"updating",null),t=r.__decorate([l.subclass("esri.views.2d.layers.features.processors.SymbolProcessor")],t)}(b.default);t.default=w}));