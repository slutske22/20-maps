// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../geometry","../../../../../core/has","../../../../../core/maybe","../../../../../core/promiseUtils","../../../../../core/screenUtils","../../../../../geohash/GeohashTree","../../../../../geohash/geohashUtils","../../../../../geometry/support/spatialReferenceUtils","../../../../../geometry/support/webMercatorUtils","../../../../../layers/graphics/OptimizedFeature","../../../../../layers/graphics/OptimizedGeometry","../../../../../layers/graphics/data/FeatureStore","../../../../../layers/graphics/data/projectionSupport","../../../../../layers/graphics/data/QueryEngine","../../../../../layers/graphics/data/utils","../../../../../support/arcadeOnDemand","../../../arcade/utils","../../../engine/webgl/definitions"],(function(e,t,r,s,i,a,o,n,u,l,h,c,g,d,_,f,p,v,y,I,m){Object.defineProperty(t,"__esModule",{value:!0});var x=function(e){return a.andThen(e,(function(e){return"cluster"!==e.type?null:r.__assign(r.__assign({},e),{clusterRadius:n.pt2px(e.clusterRadius/2)})}))};function S(e,t,s){return r.__awaiter(this,void 0,void 0,(function(){var i,a,n,u;return r.__generator(this,(function(r){for(i=[],a=0,n=e;a<n.length;a++)u=n[a],i.push(b(u,t,s));return[2,o.all(i)]}))}))}function b(e,t,s){return r.__awaiter(this,void 0,void 0,(function(){var i,a,o;return r.__generator(this,(function(r){switch(r.label){case 0:return"onStatisticValueExpression"in e.outStatistic?(a=(i=e).outStatistic.onStatisticValueExpression,o=i,[4,y.createRendererExpression(a,t,s)]):[3,2];case 1:return o.expression=r.sent(),[2,i];case 2:return[2,e]}}))}))}var R=function(e){function t(t,r,s,i,a){var o=this,n=new d.default([],[r,s]);return(o=e.call(this,n,i,null,t)||this).invalid=!1,o.canDelete=!1,o.geohashBoundsInfo=a,o}return r.__extends(t,e),Object.defineProperty(t.prototype,"count",{get:function(){return this.attributes.cluster_count},enumerable:!0,configurable:!0}),t.create=function(e,r,s,i,a,o,n){var u=new t(r,s,i,o,n);return u.localId=e.createLocalId(u.objectId,!0),u.tileLevel=a,u},t.prototype.update=function(e,t,r,s,i){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=s,this.geohashBoundsInfo=i,this.referenceId=null,this.invalid=!1,this},t.prototype.toJSON=function(){return{objectId:this.objectId,referenceId:this.referenceId,attributes:r.__assign(r.__assign({},this.attributes),{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}},t}(g.default),L=function(e){function t(t,r,i,a){var o=e.call(this,t)||this;return o._deferredDeletionQueue=[],o._invalidated=!1,o._aggregateFieldsHash=null,o._geohashLevel=0,o._aggregateValueRanges={},o._aggregateValueRangesChanged=!1,o._aggregateFields=[],o._hasAggregateValueExpression=!1,o._hasViewExpression=!1,o._$view={scale:0,viewingMode:"none"},o._clusters=new Map,o._tiles=new Map,o._spatialReference=r,o._attributeStore=i,o._featureReduction=x(a),o._projectionSupportCheck=f.checkProjectionSupport(r,s.SpatialReference.WGS84),o}return r.__extends(t,e),t.prototype.setScale=function(e){var t=e!==this._$view.scale&&this._hasViewExpression,r=this._featureReduction;this._$view.scale=e,a.isSome(r)&&t&&(this._tree=new u.GeohashTree(this._aggregateFields),this._unindexFeatures(),this._reindexFeatures(!0))},t.prototype.update=function(e,t,s){return r.__awaiter(this,void 0,void 0,(function(){var i,o,n,l,h,c,g,d,_,f,p,v=this;return r.__generator(this,(function(r){switch(r.label){case 0:return i=this._featureReduction,o=a.andThen(t.featureReduction,x),n=t.aggregateFields.reduce((function(e,t){return e+JSON.stringify(t)}),""),l=null===i&&t.featureReduction,h=n!==this._aggregateFieldsHash,c=l||h,h?(g=this,[4,S(t.aggregateFields,this._spatialReference,s)]):[3,2];case 1:for(g._aggregateFields=r.sent(),this._hasViewExpression=!1,d=0,_=this._aggregateFields;d<_.length;d++)"onStatisticValueExpression"in(f=_[d]).outStatistic&&(p=f,this._hasAggregateValueExpression=!0,this._hasViewExpression=this._hasViewExpression||p.expression.referencesScale());r.label=2;case 2:return[4,this._projectionSupportCheck];case 3:return r.sent(),this._featureReduction=o,this._aggregateFieldsHash=n,this._aggregateValueRanges={},this._invalidated=!0,a.isNone(o)?(this._tree=null,[2]):(a.isSome(i)&&i.clusterRadius!==o.clusterRadius&&this._clusters.forEach((function(e){return e.canDelete=!0})),c&&(this._tree=new u.GeohashTree(t.aggregateFields),this._unindexFeatures()),(c||e)&&this._reindexFeatures(h),this._handleClusterUpdates(),this._tiles.forEach((function(e){return v._getClustersForTile(e,0,o.clusterRadius,null,!1)})),[2])}}))}))},t.prototype._ensureAggregateFields=function(e){if(this._hasAggregateValueExpression)for(var t=this._$view,r=0,s=this._aggregateFields;r<s.length;r++){var i=s[r];if("onStatisticValueExpression"in i.outStatistic){var a=i,o=a.expression,n=a.outStatistic.onStatisticField;e.attributes[n]=I.callWithOptimizedFeature(o,e,{$view:t},this.geometryInfo)}}},t.prototype._unindexFeatures=function(){this._featuresById.forEach((function(e){e.geohashIndexed=!1}))},t.prototype._reindexFeatures=function(e){var t=this;this._featuresById.forEach((function(r){r.geohashX||r.geohashY||t._setGeohash(r),e&&t._ensureAggregateFields(r),t._attributeStore.isVisible(r)?t._insertIntoIndex(r):t._removeFromIndex(r)}))},t.prototype.onTileUpdate=function(e){var t=this,r=e.added,s=e.removed;if(r.length){var i=Math.max.apply(Math,r.map((function(e){return e.level})));this._setGeohashLevel(i),r.forEach((function(e){return t._tiles.set(e.key.id,e)}))}if(!a.isNone(this._featureReduction)){var o=this._featureReduction.clusterRadius;s.forEach((function(e){t._tiles.delete(e.key.id),t._markTileClustersForDeletion(e,o)}))}},t.prototype.sweepClusters=function(){var e=this;this._clusters.forEach((function(t,r){t.canDelete&&(e._attributeStore.freeLocalId(t.objectId),e._clusters.delete(r))}));for(var t=0,r=this._deferredDeletionQueue;t<r.length;t++){var s=r[t];this._attributeStore.addLocalId(s)}this._deferredDeletionQueue=[]},t.prototype.executeTileQuery=function(t,s,i){return r.__awaiter(this,void 0,void 0,(function(){var o,n,u;return r.__generator(this,(function(r){switch(r.label){case 0:return a.isNone(this._featureReduction)?[2,e.prototype.executeTileQuery.call(this,t,s,i)]:[4,this._projectionSupportCheck];case 1:return r.sent(),this._handleClusterUpdates(),o=this._featureReduction.clusterRadius,n=this._getTransforms(t,s),u=this._getClustersForTile(t,i.pixelBuffer,o,n),this._aggregateValueRangesChanged&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),[2,u]}}))}))},t.prototype.getAggregate=function(e){var t=null;return this._clusters.forEach((function(r){r.localId===e&&(t=r.toJSON())})),t},t.prototype.getAggregateValueRanges=function(){return this._aggregateValueRanges},t.prototype._getClustersForTile=function(e,t,o,n,u){var l=this;void 0===u&&(u=!0),t=Math.max(t,50);for(var h=2*o,g=new Set,d=this._getGeohashLevel(e.key.level),_=Math.pow(2,e.key.level)*Math.ceil(m.TILE_SIZE/h),y=Math.ceil(t/h)+2,I=Math.ceil(m.TILE_SIZE/h)+2*y,x=e.key,S=x.row,b=x.col*m.TILE_SIZE,R=S*m.TILE_SIZE,L=Math.floor(b/h)-y,E=Math.floor(R/h)-y,w=L+I,F=E+I,T=new Array,V=e.tileInfoView.getLODInfoAt(e.key.level),C=L;C<=w;C++)for(var M=function(t){var o,h,y=C;V.wrap&&(y=C<0?C+_:C%_);var I=V.wrap&&C<0,m=V.wrap&&C%_!==C,x=j._lookupCluster(V,e.key.level,y,t,d);if(a.isSome(x)){var S=a.andThen(n,(function(e){return I?e.left:m?e.right:e.tile}));if(u&&a.isNone(S))return"continue";if(!x.count)return"continue";if(u&&1===x.count){var b=x.geohashBoundsInfo,R=b.xLL,L=b.yLL,E=b.xTR,w=b.yTR,F=b.level,M=a.unwrap(j._tree).findSingleOccupancyNode(R,L,E,w,F),G=a.unwrap(M).getLngLatBounds(),k={x:G[0],y:G[1]},D={x:G[2],y:G[3]},X=0,Y=0,A=0,Z=0;if(j._spatialReference.isWebMercator)X=(o=c.lngLatToXY(k.x,k.y))[0],Y=o[1],A=(h=c.lngLatToXY(D.x,D.y))[0],Z=h[1];else{var B=f.project(k,s.SpatialReference.WGS84,j._spatialReference),N=f.project(D,s.SpatialReference.WGS84,j._spatialReference);if(!B||!N)return i("esri-2d-debug")&&console.debug("Failed to reproject known tree node"),"continue";X=B.x,Y=B.y,A=N.x,Z=N.y}var O=[X,Y,A,Z],U=null;if(j.forEachInBounds(O,(function(e){l._attributeStore.isVisible(e)&&(U&&i("esri-2d-debug")&&console.debug("Expected to find only one feature, but found multiple"),U=e)})),!U)return i("esri-2d-debug")&&console.debug("Expected to find a feature, but found none"),"continue";var W=v.getGeometry(j.geometryInfo.geometryType,j.geometryInfo.hasZ,j.geometryInfo.hasM,U.geometry,0,a.unwrap(S)),Q=r.__assign(r.__assign({},U.attributes),x.attributes);x.referenceId=U.localId,g.add(x.objectId),T.push(new p.Feature(Q,x.localId,W))}else if(u){g.add(x.objectId);W=v.getGeometry(j.geometryInfo.geometryType,j.geometryInfo.hasZ,j.geometryInfo.hasM,x.geometry,0,a.unwrap(S));T.push(new p.Feature(x.attributes,x.localId,W))}}},j=this,G=E;G<=F;G++)M(G);return{features:T,objectIds:g}},t.prototype._getGeohashLevel=function(e){return Math.min(Math.ceil(e/2+2),12)},t.prototype._setGeohashLevel=function(e){var t=this,r=this._geohashLevel,s=this._getGeohashLevel(e),i=2*(Math.floor(s/2)+1)-1,o=this._tree;this._geohashLevel=i,a.isNone(o)||(i>r?(o.dropLevels(0),this._featuresById.forEach((function(e){e.geohashIndexed&&(t._setGeohash(e),o.insert(e,t._geohashLevel),e.geohashIndexed=!0)}))):i<r&&o.dropLevels(this._geohashLevel))},t.prototype._insertIntoIndex=function(e){e.geohashIndexed||(this._invalidated=!0,e.geohashIndexed=!0,a.unwrap(this._tree).insert(e,this._geohashLevel))},t.prototype._removeFromIndex=function(e){e.geohashIndexed&&(this._invalidated=!0,a.unwrap(this._tree).remove(e,this._geohashLevel),e.geohashIndexed=!1)},t.prototype._handleClusterUpdates=function(){var e=this;this._invalidated&&this._clusters.size&&this._clusters.forEach((function(t){a.isSome(t)&&(t.invalid=t.invalid||e._invalidated)})),this._invalidated=!1},t.prototype._getTransforms=function(e,t){var s={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},i=h.getInfo(t);if(!i)return{tile:s,left:null,right:null};var a=i.valid,o=a[0],n=a[1];return{tile:s,left:r.__assign(r.__assign({},s),{translate:[n,e.bounds[3]]}),right:r.__assign(r.__assign({},s),{translate:[o-n+e.bounds[0],e.bounds[3]]})}},t.prototype._getClusterId=function(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r},t.prototype._markForDeletion=function(e,t,r){var s=this._getClusterId(e,t,r);if(this._clusters.has(s)){var i=this._clusters.get(s);a.isSome(i)?i.canDelete=!0:this._clusters.delete(s)}},t.prototype._getClusterBounds=function(e,t,r){if(a.isNone(this._featureReduction))return null;var s=this._featureReduction.clusterRadius,i=2*s,o=r%2?t*i:t*i+s,n=r*i,u=o/m.TILE_SIZE,l=n/m.TILE_SIZE,h=(o+i)/m.TILE_SIZE,c=(n-i)/m.TILE_SIZE;return[e.getXForColumn(u),e.getYForRow(l),e.getXForColumn(h),e.getYForRow(c)]},t.prototype._lookupCluster=function(e,t,i,o,n){var u,h;if(a.isNone(this._featureReduction)||a.isNone(this._tree))return null;var g=this._getClusterId(t,i,o),d=this._clusters.get(g);if(d&&a.isSome(d)&&!d.invalid&&!d.canDelete)return d;var _=this._getClusterBounds(e,i,o),p=_[0],v=_[1],y=_[2],I=_[3],m={x:p,y:v},x={x:y,y:I},S=0,b=0,L=0,E=0;if(this._spatialReference.isWebMercator)S=(u=c.xyToLngLat(m.x,m.y))[0],b=u[1],L=(h=c.xyToLngLat(x.x,x.y))[0],E=h[1];else{var w=f.project(m,this._spatialReference,s.SpatialReference.WGS84),F=f.project(x,this._spatialReference,s.SpatialReference.WGS84);if(!w||!F)return null;S=w.x,b=w.y,L=F.x,E=F.y}S>L&&(L=180);var T={geohashX:0,geohashY:0},V={geohashX:0,geohashY:0};l.setGeohashXY(T,b,S,n),l.setGeohashXY(V,E,L,n);var C=T.geohashX,M=T.geohashY,j=V.geohashX,G=V.geohashY,k={xLL:C,yLL:M,xTR:j,yTR:G,level:n},D=this._tree.getRegionStatistics(C,M,j,G,n),X=D.count,Y=D.xTotal,A=D.yTotal,Z=X?Y/X:0,B=X?A/X:0;if(a.isSome(d)&&d.canDelete){var N=this._attributeStore.removeLocalId(d.objectId);this._deferredDeletionQueue.push(N)}var O=a.isSome(d)&&!d.canDelete&&d.invalid,U=r.__assign({cluster_count:X},D.attributes),W=this._attributeStore,Q=O?d.update(Z,B,t,U,k):R.create(W,g,Z,B,t,U,k);return 0===X&&(Q.geometry.coords[0]=(p+y)/2,Q.geometry.coords[1]=(v+I)/2),this._attributeStore.setAttributeData(Q.localId,Q,this.geometryInfo,null),this._clusters.set(g,Q),this._updateAggregateValueRangeForCluster(Q,Q.tileLevel),Q},t.prototype._updateAggregateValueRangeForCluster=function(e,t){var r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},s=r.minValue,i=r.maxValue;r.minValue=Math.min(s,e.count),r.maxValue=Math.max(i,e.count),this._aggregateValueRanges[t]=r,s===r.minValue&&i===r.maxValue||(this._aggregateValueRangesChanged=!0)},t.prototype._markTileClustersForDeletion=function(e,t){for(var r=2*t,s=Math.ceil(m.TILE_SIZE/r),i=e.key,a=i.row,o=i.col*m.TILE_SIZE,n=a*m.TILE_SIZE,u=Math.floor(o/r),l=Math.floor(n/r),h=u;h<u+s;h++)for(var c=l;c<l+s;c++)this._markForDeletion(e.key.level,h,c)},t.prototype._setGeohash=function(e){var t=e.geometry;if(t&&t.coords.length){var r={x:t.coords[0],y:t.coords[1]},a=f.project(r,this._spatialReference,s.SpatialReference.WGS84);a?l.setGeohashXY(e,a.y,a.x,12):i("esri-2d-debug")&&console.debug("Tried to project feature geometry, but got back `null`")}},t.prototype._add=function(t){var r=this._featuresById.get(t.objectId);e.prototype._add.call(this,t),this._ensureAggregateFields(t),a.isSome(this._featureReduction)&&a.isSome(this._tree)&&(r?(t.geohashIndexed=r.geohashIndexed,t.geohashX=r.geohashX,t.geohashY=r.geohashY):this._setGeohash(t),!t.geohashIndexed&&this._attributeStore.isVisible(t)&&this._insertIntoIndex(t))},t.prototype._remove=function(t){return a.isSome(this._featureReduction)&&a.isSome(this._tree)&&this._removeFromIndex(t),e.prototype._remove.call(this,t)},t}(_.default);t.ClusterStore=L}));