// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.16/esri/copyright.txt for details.

define(["require","exports","tslib","../../../../../core/ArrayPool","../../../../../core/Error","../../../../../core/has","../../../../../core/Logger","../../../../../core/promiseUtils","../../../../../core/watchUtils","../../../../../core/workers","../../../../../core/accessorSupport/decorators","../../../../../geometry/Extent","../../../../../geometry/support/jsonUtils","../../../../../layers/graphics/featureConversionUtils","../../../../../layers/ogc/ogcFeatureUtils","../../../../../tasks/operations/query","../../../../../tasks/support/QuantizationParameters","../../../engine","./BaseController","./EditsQueue","../support/DataTile","../support/DataTileFeaturesIndex","../support/Tile","../support/TileUpdateQueue","../../../tiling/TileQueue"],(function(e,t,r,i,n,s,a,o,u,c,l,d,h,f,p,_,y,g,v,b,m,S,I,T,w){Object.defineProperty(t,"__esModule",{value:!0});var x=a.getLogger("esri.views.2d.layers.features.controllers.OnDemandController"),Q=s("esri-featurelayer-webgl"),F=s("esri-mobile"),E={maxDrillLevel:Q&&"object"==typeof Q&&null!=Q.maxDrillLevel?Q.maxDrillLevel:F?1:4,maxRecordCountFactor:Q&&"object"==typeof Q&&null!=Q.maxRecordCountFactor?Q.maxRecordCountFactor:F?1:3,enablePBFQuery:!Q||"object"!=typeof Q||null==Q.enablePBFQuery||Q.enablePBFQuery},C=new Set,O=[],q=function(){function e(e,t){var r=this;this.objectIdField=t,c.openWithPorts(e).then((function(e){return r.client=e}))}return e.prototype.destroy=function(){this.client.close(),this.client=null},e.prototype.executeQuery=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this.client.invoke("queryFeatures",e.toJSON(),t)];case 1:return i=r.sent(),[2,f.convertFromFeatureSet(i,this.objectIdField)]}}))}))},e}(),j=function(){function e(e,t){this.source=e,this.sourceSpatialReference=t}return e.prototype.destroy=function(){},e.prototype.executeQuery=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,_.executeQueryPBF(this.source,e,{type:"optimized",sourceSpatialReference:this.sourceSpatialReference},t)];case 1:return[2,r.sent().data]}}))}))},e}(),P=function(){function e(e,t,r){this.source=e,this.objectIdField=t,this.sourceSpatialReference=r}return e.prototype.destroy=function(){},e.prototype.executeQuery=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,_.executeQuery(this.source,e,this.sourceSpatialReference,t)];case 1:return i=r.sent().data,[2,f.convertFromFeatureSet(i,this.objectIdField)]}}))}))},e}(),A=function(){function e(e,t){this.source=e,this.objectIdField=t}return e.prototype.destroy=function(){},e.prototype.executeQuery=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){return[2,p.queryOptimizedFeatureSet(this.source,e,t)]}))}))},e}(),D=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="on-demand",t._queryInfoHash=null,t._dataTileIndex=new S.default,t._editsQueue=new b.EditsQueue({processEdits:t._processEdits.bind(t)}),t._featuresInFlight=new Map,t.service=null,t}return r.__extends(t,e),t.prototype.initialize=function(){var e=this,t=this._createFeatureStore();t.onFeatureAdd=this.onFeatureAdd.bind(this),t.onFeatureRemove=this.onFeatureRemove.bind(this),this._set("featureStore",t),this._dataTileIndex.featureStore=this.featureStore,this._dataTileIndex.forEach((function(e){return e.done=!1})),this._fetchQueue=new w({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,i){return r.__awaiter(e,void 0,void 0,(function(){var e;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,this._fetchTile(t,this.queryInfo,i)];case 1:return e=r.sent(),[2,{dataTile:t,featureSet:e}]}}))}))}}),this._patchQueue=new w({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t.dataTile,t.queryInfo,r)}}),this._updateQueue=new T.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r,i){return e._updateTile(t,r,i)}});var i,n=this.service,s=n.capabilities,a=n.source,o=n.objectIdField,u=n.spatialReference;(i=a)&&i.capabilities&&i.collectionId&&i.layerDefinition&&i.url?this.sourceAdapter=new A(a,o):Array.isArray(a)?this.sourceAdapter=new q(a,o):E.enablePBFQuery&&s.query.supportsFormatPBF?this.sourceAdapter=new j(a,u):this.sourceAdapter=new P(a,o,u),this.handles.add([this.watch("updating",(function(t){return!t&&e.onIdle()}))]),this.featureStore.events.on("valueRangesChanged",(function(t){e.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}})}))},t.prototype.destroy=function(){this._fetchQueue.clear(),this._patchQueue.clear(),this._updateQueue.clear(),this._editsQueue.destroy(),this.queryEngine.destroy(),this.sourceAdapter.destroy()},Object.defineProperty(t.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.featureStore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.viewState||this._fetchQueue.updating||this._patchQueue.updating||this._updateQueue.updating||this._editsQueue.updating},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i,n,s,a,o,u,c=this;return r.__generator(this,(function(r){switch(r.label){case 0:return this.validateConfig(e),i=JSON.stringify(this.config.filters),n=this.renderer.getAttributeHash(),s=e.availableFields.filter((function(e){return-1===c.availableFields.indexOf(e)})),a=this.config.definitionExpression,this._set("config",e),a!==this.config.definitionExpression&&this._set("queryEngine",this._createQueryEngine(this.featureStore)),[4,this.updatePixelBuffer()];case 1:return r.sent(),o=i!==JSON.stringify(e.filters),u=n!==this.renderer.getAttributeHash(),t?u?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,3]:[3,6];case 2:r.sent(),r.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return r.sent(),[4,this.featureStore.update(o,e,this.service.fields)];case 5:return r.sent(),this.refresh(),[2];case 6:return s.length?[4,this._handleAttributeChange(s)]:[3,8];case 7:r.sent(),r.label=8;case 8:return"heatmap"===this.renderer.type?[2]:u?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,10];case 9:r.sent(),this.featureStore.forEach((function(e){return c.attributeStore.setAttributeData(e.localId,e,c.geometryInfo,c.viewParams)})),r.label=10;case 10:return[4,this.attributeStore.updateFilters(this)];case 11:return r.sent(),[4,this.featureStore.update(o,e,this.service.fields)];case 12:return r.sent(),[4,this.attributeStore.sendUpdates()];case 13:return r.sent(),[2]}}))}))},t.prototype.invalidate=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i;return r.__generator(this,(function(r){for(e=0,t=this.tileStore.tiles;e<t.length;e++)i=t[e],this._updateQueue.push(i.id,Date.now());return[2]}))}))},t.prototype.onIdle=function(){this.featureStore.sweepClusters()},t.prototype.onEdits=function(e){var t=this;return this._fetchQueue.pause(),this._fetchQueue.reset(),this._editsQueue.push(e).then((function(){t._editsQueue.updating||t._fetchQueue.resume()}))},t.prototype.queryFeatures=function(e){return this.queryEngine.executeQuery(e)},t.prototype.queryFeatureCount=function(e){return this.queryEngine.executeQueryForCount(e)},t.prototype.queryObjectIds=function(e){return this.queryEngine.executeQueryForIds(e)},t.prototype.queryExtent=function(e){return this.queryEngine.executeQueryForExtent(e)},t.prototype.queryStatistics=function(){return r.__awaiter(this,void 0,void 0,(function(){var e,t,i,n=this;return r.__generator(this,(function(s){switch(s.label){case 0:return e=0,t=0,i=0,[4,o.all(this.tileStore.tiles.map((function(s){return r.__awaiter(n,void 0,void 0,(function(){var n,a,o,u,c,l,d,f,p,_,y;return r.__generator(this,(function(r){switch(r.label){case 0:return n=this.queryInfo,a=n.returnCentroid,o=n.returnGeometry,u=this._pixelBuffer,c={pixelBuffer:u,returnGeometry:o,returnCentroid:a,returnOutline:this.returnOutline},l=performance.now(),[4,this.featureStore.executeTileQuery(s,this.spatialReference,c)];case 1:for(d=r.sent().features,f=performance.now(),i+=f-l,e+=d.length,p=0,_=d;p<_.length;p++)(y=_[p]).geometry&&(h.isPolygon(y.geometry)?t+=y.geometry.rings.reduce((function(e,t){return e+t.length}),0):h.isPolyline(y.geometry)&&(t+=y.geometry.paths.reduce((function(e,t){return e+t.length}),0)));return[2]}}))}))})))];case 1:return s.sent(),[2,r.__assign(r.__assign({},this.featureStore.storeStatistics),{displayedFeatureCount:e,displayedVertexCount:t,displayPreProcessTime:i})]}}))}))},t.prototype.refresh=function(){return r.__awaiter(this,void 0,void 0,(function(){var e=this;return r.__generator(this,(function(t){switch(t.label){case 0:return this._queryInfoHash=Math.random().toString(),this._dataTileIndex.clear(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.clear(),[4,u.whenFalseOnce(this._fetchQueue,"updating")];case 1:return t.sent(),this._updateQueue.clear(),[4,u.whenFalseOnce(this._updateQueue,"updating")];case 2:return t.sent(),this.featureStore.startMarkingUsedFeatures(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),[4,u.whenFalseOnce(this._fetchQueue,"updating")];case 3:return t.sent(),this.featureStore.sweep(),this.featureStore.forEach((function(t){return e.attributeStore.setAttributeData(t.localId,t,e.geometryInfo,e.viewParams)})),this.attributeStore.sendUpdates(),this._updateQueue.resume(),[2]}}))}))},t.prototype.setViewState=function(t){var r=this,i=this.viewState&&this.viewState.scale;e.prototype.setViewState.call(this,t),this._fetchQueue.state=t,this._updateQueue.state=t,i!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.featureStore.forEach((function(e){return r.attributeStore.setAttributeData(e.localId,e,r.geometryInfo,r.viewParams)})),this.attributeStore.sendUpdates()),this.featureStore.setScale(this.viewState.scale)},t.prototype.getAggregate=function(e){return this.featureStore.getAggregate(e)},t.prototype.getAggregateValueRanges=function(){return this.featureStore.getAggregateValueRanges()},t.prototype.onTileUpdate=function(e){this._manageTiles(e.added,e.removed),this.featureStore.onTileUpdate(e)},t.prototype.onFeatureAdd=function(e){if(this._featuresInFlight.has(e.objectId)){var t=this._featuresInFlight.get(e.objectId).attributes;e.attributes=r.__assign(r.__assign({},t),e.attributes),this._featuresInFlight.delete(e.objectId)}e.localId=this.attributeStore.createLocalId(e.objectId),this.attributeStore.setAttributeData(e.localId,e,this.geometryInfo,this.viewParams)},t.prototype._handleAttributeChange=function(e){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(t){switch(t.label){case 0:return[4,this._fetchChangedFields(e)];case 1:return t.sent(),[2]}}))}))},t.prototype._fetchChangedTileFields=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){return(i=this._dataTileIndex.get(e.id))?(!1,[2,this._fetchChangedTileFieldsDrill(i,t)]):[2]}))}))},t.prototype._fetchChangedTileFieldsDrill=function(e,t,i){return void 0===i&&(i=0),r.__awaiter(this,void 0,void 0,(function(){var n,s,a,u,c,l,d,h,f,p,_=this;return r.__generator(this,(function(y){switch(y.label){case 0:return n=r.__assign(r.__assign({},this.queryInfo),{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField])}),e.returnExceeded=e.returnExceeded||i>=E.maxDrillLevel,s=e.key,a={key:s,dataTile:e,queryInfo:n},[4,this._patchQueue.push(a)];case 1:return(u=y.sent()).exceededTransferLimit&&i<E.maxDrillLevel?(c=e.tile.createChildTiles(),l=c.map((function(t){var r=new m.default;return r.tile=t,r.displayTile=e.displayTile,r})),[4,o.all(l.map((function(e){return _._fetchChangedTileFieldsDrill(e,t,i+1)})))]):[3,3];case 2:return y.sent(),[2];case 3:for(d=0,h=u.features;d<h.length;d++)f=h[d],this.featureStore.has(f.objectId)?(p=this.featureStore.getFeature(f.objectId)).attributes=r.__assign(r.__assign({},p.attributes),f.attributes):this._featuresInFlight.set(f.objectId,f);return[2]}}))}))},t.prototype._fetchChangedTileFieldsPaged=function(e,t,i){return void 0===i&&(i=0),r.__awaiter(this,void 0,void 0,(function(){var n,s,a,o,u,c,l,d,h,f,p;return r.__generator(this,(function(_){switch(_.label){case 0:return n=this.service.capabilities.query.supportsMaxRecordCountFactor,s=this.service.tileMaxRecordCount,a=s*(n?1:E.maxRecordCountFactor),o=r.__assign(r.__assign({},this.queryInfo),{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField]),resultOffset:i*a,num:a}),e.returnExceeded=!0,u=e.key,c={key:u,dataTile:e,queryInfo:o},[4,this._patchQueue.push(c)];case 1:for(l=_.sent(),d=0,h=l.features;d<h.length;d++)f=h[d],this.featureStore.has(f.objectId)?(p=this.featureStore.getFeature(f.objectId)).attributes=r.__assign(r.__assign({},p.attributes),f.attributes):this._featuresInFlight.set(f.objectId,f);return l.exceededTransferLimit?[2,this._fetchChangedTileFieldsPaged(e,t,i+1)]:[2]}}))}))},t.prototype._fetchChangedFields=function(e){return r.__awaiter(this,void 0,void 0,(function(){var t,i,n=this;return r.__generator(this,(function(r){switch(r.label){case 0:return t=this.tileStore.tiles,i=t.map((function(t){return n._fetchChangedTileFields(t,e)})),[4,o.all(i)];case 1:return r.sent(),[2]}}))}))},t.prototype._manageTiles=function(e,t){void 0===t&&(t=null);for(var r=this._dataTileIndex,i=this._fetchQueue,n=this._updateQueue,s="esriGeometryPoint"===this.service.geometryType,a=function(e){var t=r.get(e.id);t?(t.displayTile=e,s?r.forEach((function(r){I.isChildOf(r,t)&&(r.displayTile=e)})):t.done=!1):((t=new m.default).tile=e.clone(),t.displayTile=e,r.add(t)),o._processDataTile(t)},o=this,u=0,c=e;u<c.length;u++){a(h=c[u])}if(t)for(var l=0,d=t;l<d.length;l++){var h=d[l];C.add(h),n.abort(h.id)}r.forEach((function(e){C.has(e.displayTile)&&O.push(e)}));for(var f=0,p=O;f<p.length;f++){var _=p[f];i.abort(_.id),r.delete(_)}O.length=0,C.clear()},t.prototype._processDataTile=function(e){var t=this,r=e.displayTile,i=e.key,s=this._dataTileIndex,a=this._fetchQueue,u=i.id,c=this._queryInfoHash,l=i.level-r.key.level>=E.maxDrillLevel;if(s.add(e),e.done||a.has(u)){if(e.queryInfoHash!==c||e.returnExceeded!==l)if(e.done)e.done=!1;else{if(!a.isOngoing(u))return e.queryInfoHash=c,void(e.returnExceeded=l);a.abort(u)}}else e.queryInfoHash=c,e.returnExceeded=l;e.done?this._invalidateTile(e.displayTile):a.has(u)||a.push(e).then((function(e){return t._handleResponse(e.dataTile,e.featureSet)})).catch((function(r){o.isAbortError(r)||(x.error(new n("featurelayer-controller:tile-error","Encountered an error when handling tile response",r)),e.done=!0,t._invalidateTile(e.displayTile))}))},t.prototype._handleResponse=function(e,t){if(e.done=!0,f.hydrateOptimizedFeatureSet(t),t.exceededTransferLimit)if(e.returnExceeded)this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);else{for(var r=e.tile.createChildTiles(),n=0,s=r;n<s.length;n++){var a=s[n],o=new m.default;o.tile=a,o.displayTile=e.displayTile,this._processDataTile(o)}i.release(r)}else this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);this._invalidateTile(e.tile)},t.prototype._deleteChildrenDataTiles=function(e){this._dataTileIndex.forEach((function(t){I.isChildOf(t,e)&&O.push(t)}));for(var t=0,r=O;t<r.length;t++){var i=r[t];this._fetchQueue.abort(i.id),this._dataTileIndex.delete(i)}O.length=0},t.prototype._createQuery=function(e,t,r,i,n,s){var a=this.service.geometryType,o=this._createDefaultQuery(i);return o.maxRecordCountFactor=n,o.returnExceededLimitFeatures=s,o.resultType="tile",o.geometry=e,this.service.capabilities.query.supportsQuantization?(o.quantizationParameters=new y.default({mode:"view",originPosition:"upper-left",tolerance:r,extent:t}),"esriGeometryPolyline"===a&&(o.maxAllowableOffset=r)):"esriGeometryPolyline"!==a&&"esriGeometryPolygon"!==a||(o.maxAllowableOffset=r),o},t.prototype._fetchTile=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n,s,a,o,u,c,l,h,p,_,y;return r.__generator(this,(function(r){switch(r.label){case 0:return n=new d({xmin:e.bounds[0],ymin:e.bounds[1],xmax:e.bounds[2],ymax:e.bounds[3],spatialReference:this.spatialReference}),s=this.service.geometryType,a="esriGeometryPoint"===s?e.tile:e.displayTile,o=a.extent,u=a.resolution,c=e.returnExceeded,l=this._createQuery(n,o,u,t,E.maxRecordCountFactor,c),[4,this.sourceAdapter.executeQuery(l,i)];case 1:if((h=r.sent()).transform&&"esriGeometryPolygon"===s)for(p=0,_=h.features;p<_.length;p++)(y=_[p]).geometry=f.removeCollinearVectices(y.geometry,y.geometry,s,!1,!1);return[2,h]}}))}))},t.prototype._invalidateTile=function(e){for(var t=this._pixelBuffer,r=this._updateQueue,i=0,n=this.tileStore.intersections(e,t);i<n.length;i++){var s=n[i].tile;r.push(s.id,s.updateTimestamp)}},t.prototype._updateTile=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n,s,a,u,c,l,d,h,f,p,_,y,v=this;return r.__generator(this,(function(r){switch(r.label){case 0:return n=this.tileStore.get(e),s=this.queryInfo,a=s.returnCentroid,u=s.returnGeometry,c=this._pixelBuffer,l={pixelBuffer:c,returnGeometry:u,returnCentroid:a,returnOutline:this.returnOutline},[4,this.featureStore.executeTileQuery(n,this.spatialReference,l)];case 1:return d=r.sent(),h=d.features,f=d.objectIds,[4,this.attributeStore.sendUpdates()];case 2:return r.sent(),p={geometryType:this.service.geometryType,features:h,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:n.transform},_=[],y=!0,this._dataTileIndex.forEach((function(e){n.id!==e.id&&I.isChildOf(e,n)&&y&&!e.done&&(y=!1)})),y&&n&&n.objectIds.forEach((function(e){if(!f.has(e)){var t=v.attributeStore.getLocalId(e);_.push(t)}})),f.forEach((function(e){n.objectIds.add(e)})),n.updateTimestamp=t,[2,this.processor.onTileData(n,{clear:!0,addOrUpdate:p.features,remove:_,transformParams:g.Utils.getTransformParams(p)},i).catch((function(e){o.isAbortError(e)||x.error("update-tile",e)}))]}}))}))},t.prototype._processEdits=function(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n,s,a,u,c,l=this;return r.__generator(this,(function(d){switch(d.label){case 0:return n=this._createTempQueryEngine(),s=this._createObjectIdsQuery(e),e.length?[4,this.sourceAdapter.executeQuery(s)]:[3,2];case 1:a=d.sent(),f.hydrateOptimizedFeatureSet(a),this._dataTileIndex.addOrUpdateFeatures(a.features),n.featureStore.addMany(a.features),d.label=2;case 2:return u=t.concat(e).map((function(e){return l.attributeStore.getLocalId(e)})),this._dataTileIndex.deleteFeaturesById(t),this.attributeStore.sendUpdates(),c=r.__assign(r.__assign({},this.queryInfo),{pixelBuffer:this._pixelBuffer,returnOutline:this.returnOutline}),this.tileStore.tiles.map((function(e){return r.__awaiter(l,void 0,void 0,(function(){var t,s;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,n.featureStore.executeTileQuery(e,this.spatialReference,c)];case 1:return t=r.sent().features,s={transform:e.transform,hasZ:!1,hasM:!1},[2,this.processor.onTileData(e,{addOrUpdate:t,remove:u,transformParams:s},i).catch((function(e){o.isAbortError(e)||x.error("update-tile",e)}))]}}))}))})),n.destroy(),[2]}}))}))},t.prototype._createObjectIdsQuery=function(e){var t=this._createDefaultQuery(this.queryInfo);return t.objectIds=e,t},r.__decorate([l.property()],t.prototype,"_fetchQueue",void 0),r.__decorate([l.property()],t.prototype,"_patchQueue",void 0),r.__decorate([l.property()],t.prototype,"_updateQueue",void 0),r.__decorate([l.property()],t.prototype,"_editsQueue",void 0),r.__decorate([l.property({readOnly:!0})],t.prototype,"featureStore",void 0),r.__decorate([l.property({constructOnly:!0})],t.prototype,"service",void 0),r.__decorate([l.property()],t.prototype,"sourceAdapter",void 0),r.__decorate([l.property({readOnly:!0,dependsOn:["featureStore","service"]})],t.prototype,"queryEngine",null),r.__decorate([l.property({dependsOn:["viewState","_fetchQueue.updating","_updateQueue.updating","_patchQueue.updating","_editsQueue.updating"]})],t.prototype,"updating",null),t=r.__decorate([l.subclass("esri.views.2d.layers.features.controllers.OnDemandController")],t)}(v.default);t.default=D}));